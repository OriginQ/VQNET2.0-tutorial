

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>使用pyQPanda2量子机器学习模块 &mdash; VQNET v2.15.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/documentation_options.js?v=a149e6fc"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="使用pyQPanda3量子机器学习模块" href="qnn_pq3.html" />
    <link rel="prev" title="实用函数" href="utils.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VQNET
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">安装介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">VQNet 安装步骤</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">上手实例</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="vqc_demo.html">使用自动微分模拟的量子机器学习示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="qml_demo.html">使用pyQPanda2的量子机器学习示例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">经典神经网络接口介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="QTensor.html">QTensor 模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="nn.html">经典神经网络模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">实用函数</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用pyqpanda的量子神经网络接口</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">使用pyQPanda2量子机器学习模块</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">量子计算层</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#quantumlayer">QuantumLayer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.quantumlayer.QuantumLayer"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.quantumlayer.QuantumLayer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#quantumlayerv2">QuantumLayerV2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.quantumlayer.QuantumLayerV2"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.quantumlayer.QuantumLayerV2</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#quantumbatchasyncqcloudlayer">QuantumBatchAsyncQcloudLayer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.quantumlayer.QuantumBatchAsyncQcloudLayer"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.quantumlayer.QuantumBatchAsyncQcloudLayer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#quantumlayermultiprocess">QuantumLayerMultiProcess</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.quantumlayer.QuantumLayerMultiProcess"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.quantumlayer.QuantumLayerMultiProcess</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#noisequantumlayer">NoiseQuantumLayer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.quantumlayer.NoiseQuantumLayer"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.quantumlayer.NoiseQuantumLayer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dataparallelhybirdvqcqpandaqvmlayer">DataParallelHybirdVQCQpandaQVMLayer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.DataParallelHybirdVQCQpandaQVMLayer"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.DataParallelHybirdVQCQpandaQVMLayer</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id3">量子逻辑门</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">基本量子逻辑门</a></li>
<li class="toctree-l3"><a class="reference internal" href="#amplitudeembeddingcircuit">AmplitudeEmbeddingCircuit</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.template.AmplitudeEmbeddingCircuit"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.template.AmplitudeEmbeddingCircuit()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">基于pyqpanda2量子机器学习算法封装接口</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#qgan">QGAN制备任意分布初态</a></li>
<li class="toctree-l3"><a class="reference internal" href="#svm">量子核SVM算法</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">同时扰动随机近似优化器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.SPSA"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.SPSA</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#pyvqnet.qnn.SPSA._step"><code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.SPSA._step()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="qnn_pq3.html">使用pyQPanda3量子机器学习模块</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">量子神经网络自动微分模拟接口</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="vqc.html">变分量子线路自动微分模拟</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">量子大模型微调</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="llm.html">量子大模型微调示例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">其他</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="torch_api.html">VQNet使用torch进行底层计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">VQNet Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VQNET</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">使用pyQPanda2量子机器学习模块</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/rst/qnn.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pyqpanda2">
<h1>使用pyQPanda2量子机器学习模块<a class="headerlink" href="#pyqpanda2" title="Link to this heading">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>以下接口的量子计算部分使用pyqpanda2 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">https://pyqpanda-toturial.readthedocs.io/zh/latest/</a>。</p>
<p>由于pyqpanda2以及pyqpanda3兼容性问题,您需要自行安装pyqpnda2, <cite>pip install pyqpanda</cite></p>
</div>
<section id="id1">
<h2>量子计算层<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<section id="quantumlayer">
<span id="id2"></span><h3>QuantumLayer<a class="headerlink" href="#quantumlayer" title="Link to this heading">¶</a></h3>
<p>QuantumLayer是一个支持量子含参线路作为参数的自动求导模块的封装类。用户定义一个函数作为参数 <code class="docutils literal notranslate"><span class="pre">qprog_with_measure</span></code> ,该函数需要包含pyQPanda22定义的量子线路:一般包含量子线路的编码线路,演化线路和测量操作。
该类可以嵌入量子经典混合机器学习模型,通过经典的梯度下降法,使得量子经典混合模型的目标函数或损失函数最小。
用户可通过参数 <code class="docutils literal notranslate"><span class="pre">diff_method</span></code> 指定 <code class="docutils literal notranslate"><span class="pre">QuantumLayer</span></code> 层中量子线路参数的梯度计算方式,``QuantumLayer`` 当前支持有限差分法 <code class="docutils literal notranslate"><span class="pre">finite_diff</span></code> 以及 <code class="docutils literal notranslate"><span class="pre">parameter-shift</span></code> 方法。</p>
<p>有限差分法是估算函数梯度最传统和最常用的数值方法之一。主要思想是用差分代替偏导数:</p>
<div class="math notranslate nohighlight">
\[f^{\prime}(x)=\lim _{h \rightarrow 0} \frac{f(x+h)-f(x)}{h}\]</div>
<p>若使用 <code class="docutils literal notranslate"><span class="pre">parameter-shift</span></code> 方法,我们使用如下目标函数:</p>
<div class="math notranslate nohighlight">
\[O(\theta)=\left\langle 0\left|U^{\dagger}(\theta) H U(\theta)\right| 0\right\rangle\]</div>
<p>理论上可以通过 <code class="docutils literal notranslate"><span class="pre">parameter-shift</span></code> 这一更精确的方法计算量子线路中参数对哈密顿量的梯度:</p>
<div class="math notranslate nohighlight">
\[\nabla O(\theta)=
\frac{1}{2}\left[O\left(\theta+\frac{\pi}{2}\right)-O\left(\theta-\frac{\pi}{2}\right)\right]\]</div>
<dl class="py class">
<dt class="sig sig-object py" id="pyvqnet.qnn.quantumlayer.QuantumLayer">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.quantumlayer.</span></span><span class="sig-name descname"><span class="pre">QuantumLayer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">qprog_with_measure</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">para_num</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">machine_type_or_cloud_token</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_of_qubits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_of_cbits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">diff_method</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'parameter_shift'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">delta</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.01</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.quantumlayer.QuantumLayer" title="Link to this definition">¶</a></dt>
<dd><p>变分量子层的抽象计算模块。对一个参数化的量子线路进行仿真,得到测量结果。该变分量子层继承了VQNet框架的梯度计算模块,可以计算线路参数的梯度,训练变分量子线路模型或将变分量子线路嵌入混合量子和经典模型。</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>qprog_with_measure</strong> – 用pyQPanda22构建的量子线路运行和测量函数。</p></li>
<li><p><strong>para_num</strong> – <cite>int</cite> - 参数个数。</p></li>
<li><p><strong>machine_type_or_cloud_token</strong> – qpanda量子虚拟机类型或pyQPanda22 量子云令牌 : <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/Realchip.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/Realchip.html</a>。</p></li>
<li><p><strong>num_of_qubits</strong> – 量子比特数。</p></li>
<li><p><strong>num_of_cbits</strong> – 经典比特数,默认为1。</p></li>
<li><p><strong>diff_method</strong> – 求解量子线路参数梯度的方法,“参数位移”或“有限差分”,默认参数偏移。</p></li>
<li><p><strong>delta</strong> – 有限差分计算梯度时的 delta。</p></li>
<li><p><strong>dtype</strong> – 参数的数据类型,defaults:None,使用默认数据类型:kfloat32,代表32位浮点数。</p></li>
<li><p><strong>name</strong> – 这个模块的名字, 默认为””。</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>一个可以计算量子线路的模块。</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>qprog_with_measure是pyQPanda22中定义的量子线路函数 :<a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html</a>。</p>
<p>此函数必须包含以下参数作为函数入参(即使某个参数未实际使用),否则无法在QuantumLayer中正常运行。</p>
<p>qprog_with_measure (input,param,qubits,cbits,machine)</p>
<blockquote>
<div><p><cite>input</cite>: 输入一维经典数据。如果没有输入可以输入 None。</p>
<p><cite>param</cite>: 输入一维的变分量子线路的待训练参数。</p>
<p><cite>qubits</cite>: 该QuantumLayer分配的量子比特,类型为pyQpanda.Qubits。</p>
<p><cite>cbits</cite>: 由QuantumLayer分配的经典比特,用来辅助测量函数,类型为 pyQpanda.ClassicalCondition。如果线路不使用cbits,也应保留此参数。</p>
<p><cite>machine</cite>: 由QuantumLayer创建的模拟器,例如CPUQVM,GPUQVM,QCloud等。</p>
</div></blockquote>
<p>使用QuantumLayer的 <cite>m_para</cite> 属性获取变分量子线路的训练参数。该参数为QTensor类,可使用to_numpy()接口转化为numpy数组。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>该类具有别名 <cite>QpandaQCircuitVQCLayer</cite> 。</p>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbsMeasure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pqctest</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span><span class="n">cbits</span><span class="p">,</span><span class="n">machine</span><span class="p">):</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1">#print(circuit)</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="c1"># pauli_dict  = {&#39;Z0 X1&#39;:10,&#39;Y2&#39;:-0.543}</span>
    <span class="n">rlt_prob</span> <span class="o">=</span> <span class="n">ProbsMeasure</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">prog</span><span class="p">,</span><span class="n">machine</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rlt_prob</span>

<span class="n">pqc</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">pqctest</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#classic data as input</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">40</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">33</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mf">2.0</span><span class="p">]]</span> <span class="p">)</span>
<span class="c1">#forward circuits</span>
<span class="n">rlt</span> <span class="o">=</span> <span class="n">pqc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="n">grad</span> <span class="o">=</span>  <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rlt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1">#backward circuits</span>
<span class="n">rlt</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rlt</span><span class="p">)</span>
<span class="c1"># [</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000],</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000],</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000]</span>
<span class="c1"># ]</span>
</pre></div>
</div>
<p>如果使用GPU,参考下面的例子:</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbsMeasure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span><span class="p">,</span><span class="n">DEV_GPU_0</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pqctest</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span><span class="n">cbits</span><span class="p">,</span><span class="n">machine</span><span class="p">):</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1">#print(circuit)</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="c1"># pauli_dict  = {&#39;Z0 X1&#39;:10,&#39;Y2&#39;:-0.543}</span>
    <span class="n">rlt_prob</span> <span class="o">=</span> <span class="n">ProbsMeasure</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">prog</span><span class="p">,</span><span class="n">machine</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rlt_prob</span>

<span class="c1">#这里的&quot;CPU&quot; 指的是qpanda量子计算模拟器使用CPU,跟pyvqnet是否使用GPU无关。</span>
<span class="n">pqc</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">pqctest</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#这里使用toGPU将QuantumLayer 移动到GPU上</span>
<span class="n">pqc</span><span class="o">.</span><span class="n">toGPU</span><span class="p">()</span>
<span class="c1">#classic data as input</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">40</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">33</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mf">2.0</span><span class="p">]]</span> <span class="p">)</span>
<span class="nb">input</span><span class="o">.</span><span class="n">toGPU</span><span class="p">()</span>
<span class="c1">#forward circuits</span>
<span class="n">rlt</span> <span class="o">=</span> <span class="n">pqc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="n">grad</span> <span class="o">=</span>  <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rlt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">DEV_GPU_0</span><span class="p">)</span>
<span class="c1">#backward circuits</span>
<span class="n">rlt</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rlt</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="quantumlayerv2">
<h3>QuantumLayerV2<a class="headerlink" href="#quantumlayerv2" title="Link to this heading">¶</a></h3>
<p>如您更加熟悉pyQPanda22语法,可以使用该接口QuantumLayerV2,自定义量子比特 <code class="docutils literal notranslate"><span class="pre">qubits</span></code> ,经典比特 <code class="docutils literal notranslate"><span class="pre">cbits</span></code> ,后端模拟器 <code class="docutils literal notranslate"><span class="pre">machine</span></code> 加入QuantumLayerV2的参数 <code class="docutils literal notranslate"><span class="pre">qprog_with_measure</span></code> 函数中。</p>
<dl class="py class">
<dt class="sig sig-object py" id="pyvqnet.qnn.quantumlayer.QuantumLayerV2">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.quantumlayer.</span></span><span class="sig-name descname"><span class="pre">QuantumLayerV2</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">qprog_with_measure</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">para_num</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">diff_method</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'parameter_shift'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">delta</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.01</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.quantumlayer.QuantumLayerV2" title="Link to this definition">¶</a></dt>
<dd><blockquote>
<div><p>变分量子层的抽象计算模块。对一个参数化的量子线路使用pyQPanda22进行仿真,得到测量结果。该变分量子层继承了VQNet框架的梯度计算模块,可以使用参数漂移法等计算线路参数的梯度,训练变分量子线路模型或将变分量子线路嵌入混合量子和经典模型。</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>qprog_with_measure</strong> – 用pyQPand构建的量子线路运行和测量函数。</p></li>
<li><p><strong>para_num</strong> – <cite>int</cite> - 参数个数。</p></li>
<li><p><strong>diff_method</strong> – 求解量子线路参数梯度的方法,“参数位移”或“有限差分”,默认参数偏移。</p></li>
<li><p><strong>delta</strong> – 有限差分计算梯度时的 delta。</p></li>
<li><p><strong>dtype</strong> – 参数的数据类型,defaults:None,使用默认数据类型:kfloat32,代表32位浮点数。</p></li>
<li><p><strong>name</strong> – 这个模块的名字, 默认为””。</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>一个可以计算量子线路的模块。</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>qprog_with_measure是pyQPanda22中定义的量子线路函数 :<a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html</a>。</p>
<p>此函数必须包含以下参数作为函数入参(即使某个参数未实际使用),否则无法在QuantumLayerV2中正常运行。</p>
<p>与QuantumLayer相比。该接口传入的变分线路运行函数中,用户应该手动创建量子比特和模拟器: <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/QuantumMachine.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/QuantumMachine.html</a>,</p>
<p>如果qprog_with_measure需要quantum measure,用户还需要手动创建需要分配cbits: <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/Measure.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/Measure.html</a></p>
<p>量子线路函数 qprog_with_measure (input,param,nqubits,ncubits)的使用可参考下面的例子。</p>
<p><cite>input</cite>: 输入一维经典数据。如果没有,输入 None。</p>
<p><cite>param</cite>: 输入一维的变分量子线路的待训练参数。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>该类具有别名 <cite>QpandaQCircuitVQCLayerLite</cite> 。</p>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbsMeasure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayerV2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pqctest</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">param</span><span class="p">):</span>
    <span class="n">num_of_qubits</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_of_qubits</span><span class="p">)</span>

    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1">#print(circuit)</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="n">rlt_prob</span> <span class="o">=</span> <span class="n">ProbsMeasure</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">prog</span><span class="p">,</span><span class="n">machine</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rlt_prob</span>

<span class="n">pqc</span> <span class="o">=</span> <span class="n">QuantumLayerV2</span><span class="p">(</span><span class="n">pqctest</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="c1">#classic data as input</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="p">)</span>

<span class="c1">#forward circuits</span>
<span class="n">rlt</span> <span class="o">=</span> <span class="n">pqc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="n">grad</span> <span class="o">=</span>  <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rlt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1">#backward circuits</span>
<span class="n">rlt</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rlt</span><span class="p">)</span>

<span class="c1"># [</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000],</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000],</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000]</span>
<span class="c1"># ]</span>
</pre></div>
</div>
<p>如果使用GPU,参考下面的例子:</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbsMeasure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayerV2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span><span class="p">,</span><span class="n">DEV_GPU_0</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pqctest</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">param</span><span class="p">):</span>
    <span class="n">num_of_qubits</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_of_qubits</span><span class="p">)</span>

    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1">#print(circuit)</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="n">rlt_prob</span> <span class="o">=</span> <span class="n">ProbsMeasure</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">prog</span><span class="p">,</span><span class="n">machine</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rlt_prob</span>

<span class="n">pqc</span> <span class="o">=</span> <span class="n">QuantumLayerV2</span><span class="p">(</span><span class="n">pqctest</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="c1">#layer move to gpu</span>
<span class="n">pqc</span><span class="o">.</span><span class="n">toGPU</span><span class="p">()</span>
<span class="c1">#classic data as input</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="p">)</span>
<span class="c1">#data move to gpu</span>
<span class="nb">input</span><span class="o">.</span><span class="n">toGPU</span><span class="p">(</span><span class="n">DEV_GPU_0</span><span class="p">)</span>
<span class="c1">#forward circuits</span>
<span class="n">rlt</span> <span class="o">=</span> <span class="n">pqc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="n">grad</span> <span class="o">=</span>  <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rlt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="n">device</span><span class="o">=</span> <span class="n">DEV_GPU_0</span><span class="p">)</span>
<span class="c1">#backward circuits</span>
<span class="n">rlt</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rlt</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="quantumbatchasyncqcloudlayer">
<h3>QuantumBatchAsyncQcloudLayer<a class="headerlink" href="#quantumbatchasyncqcloudlayer" title="Link to this heading">¶</a></h3>
<p>当您安装最新版本pyqpanda,可以使用本接口定义一个变分线路,并提交到originqc的真实芯片上运行。</p>
<dl class="py class">
<dt class="sig sig-object py" id="pyvqnet.qnn.quantumlayer.QuantumBatchAsyncQcloudLayer">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.quantumlayer.</span></span><span class="sig-name descname"><span class="pre">QuantumBatchAsyncQcloudLayer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">origin_qprog_func</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">qcloud_token</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">para_num</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_qubits</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_cubits</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pauli_str_dict</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shots</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1000</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">initializer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">diff_method</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'parameter_shift'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">submit_kwargs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">{}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">query_kwargs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">{}</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.quantumlayer.QuantumBatchAsyncQcloudLayer" title="Link to this definition">¶</a></dt>
<dd><p>使用 pyqpanda QCLOUD 从版本 3.8.2.2 开始的 originqc 真实芯片的抽象计算模块。 它提交参数化量子电路到真实芯片并获得测量结果。
如果 diff_method == “random_coordinate_descent” ,该层将随机选择单个参数来计算梯度,其他参数将保持为零。参考:<a class="reference external" href="https://arxiv.org/abs/2311.00088">https://arxiv.org/abs/2311.00088</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>qcloud_token 为您到 <a class="reference external" href="https://qcloud.originqc.com.cn/">https://qcloud.originqc.com.cn/</a> 中申请的api token。
origin_qprog_func 需要返回pypqanda.QProg类型的数据,如果没有设置pauli_str_dict,需要保证该QProg中已经插入了measure。
origin_qprog_func 的形式必须按照如下:</p>
<p>origin_qprog_func(input,param,qubits,cbits,machine)</p>
<blockquote>
<div><p><cite>input</cite>: 输入1~2维经典数据,二维的情况下,第一个维度为批处理大小。</p>
<p><cite>param</cite>: 输入一维的变分量子线路的待训练参数。</p>
<p><cite>machine</cite>: 由QuantumBatchAsyncQcloudLayer创建的模拟器QCloud,无需用户额外在函数中定义。</p>
<p><cite>qubits</cite>: 由QuantumBatchAsyncQcloudLayer创建的模拟器QCloud创建的量子比特,数量为  <cite>num_qubits</cite>, 类型为pyQpanda.Qubits,无需用户额外在函数中定义。</p>
<p><cite>cbits</cite>: 由QuantumBatchAsyncQcloudLayer分配的经典比特, 数量为  <cite>num_cubits</cite>, 类型为 pyQpanda.ClassicalCondition,无需用户额外在函数中定义。。</p>
</div></blockquote>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>origin_qprog_func</strong> – QPanda 构建的变分量子电路函数,必须返回QProg。</p></li>
<li><p><strong>qcloud_token</strong> – <cite>str</cite> - 量子机的类型或用于执行的云令牌。</p></li>
<li><p><strong>para_num</strong> – <cite>int</cite> - 参数数量,参数是大小为[para_num]的QTensor。</p></li>
<li><p><strong>num_qubits</strong> – <cite>int</cite> - 量子电路中的量子比特数量。</p></li>
<li><p><strong>num_cubits</strong> – <cite>int</cite> - 量子电路中用于测量的经典比特数量。</p></li>
<li><p><strong>pauli_str_dict</strong> – <cite>dict|list</cite> - 表示量子电路中泡利运算符的字典或字典列表。 默认为“无”,则进行测量操作,如果输入泡利算符的字典,则会计算单个期望或者多个期望。</p></li>
<li><p><strong>shot</strong> – <cite>int</cite> - 测量次数。 默认值为 1000。</p></li>
<li><p><strong>initializer</strong> – 参数值的初始化器。 默认为“无”,使用0~2*pi正态分布。</p></li>
<li><p><strong>dtype</strong> – 参数的数据类型。 默认值为 None,即使用默认数据类型pyvqnet.kfloat32。</p></li>
<li><p><strong>name</strong> – 模块的名称。 默认为空字符串。</p></li>
<li><p><strong>diff_method</strong> – 梯度计算的微分方法。 默认为“parameter_shift”,”random_coordinate_descent”。</p></li>
<li><p><strong>submit_kwargs</strong> – 用于提交量子电路的附加关键字参数,默认:{“chip_id”:pyqpanda.real_chip_type.origin_72,”is_amend”:True,”is_mapping”:True,”is_optimization”:True,”compile_level”:3,”default_task_group_size”:200,”test_qcloud_fake”:False},当设置test_qcloud_fake为True则本地CPUQVM模拟。</p></li>
<li><p><strong>query_kwargs</strong> – 用于查询量子结果的附加关键字参数,默认:{“timeout”:2,”print_query_info”:True,”sub_circuits_split_size”:1}。</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>一个可以计算量子电路的模块。</p>
</dd>
</dl>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span><span class="p">,</span><span class="n">QuantumBatchAsyncQcloudLayer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval_qcloud</span>

<span class="k">def</span><span class="w"> </span><span class="nf">qfun</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">param</span><span class="p">,</span> <span class="n">m_machine</span><span class="p">,</span> <span class="n">m_qlist</span><span class="p">,</span><span class="n">cubits</span><span class="p">):</span>
    <span class="n">measure_qubits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">m_prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ele</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measure_qubits</span><span class="p">):</span>
        <span class="n">m_prog</span> <span class="o">&lt;&lt;</span> <span class="n">pq</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="n">ele</span><span class="p">],</span> <span class="n">cubits</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">m_prog</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">QuantumBatchAsyncQcloudLayer</span><span class="p">(</span><span class="n">qfun</span><span class="p">,</span>
                <span class="s2">&quot;3047DE8A59764BEDAC9C3282093B16AF1&quot;</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">6</span><span class="p">,</span>
                <span class="mi">6</span><span class="p">,</span>
                <span class="n">pauli_str_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">shots</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">diff_method</span><span class="o">=</span><span class="s2">&quot;parameter_shift&quot;</span><span class="p">,</span>
                <span class="n">submit_kwargs</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">query_kwargs</span><span class="o">=</span><span class="p">{})</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">]],</span><span class="n">requires_grad</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">m_para</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">qfun2</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">param</span><span class="p">,</span> <span class="n">m_machine</span><span class="p">,</span> <span class="n">m_qlist</span><span class="p">,</span><span class="n">cubits</span><span class="p">):</span>
    <span class="n">measure_qubits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">m_prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">m_qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m_prog</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">QuantumBatchAsyncQcloudLayer</span><span class="p">(</span><span class="n">qfun2</span><span class="p">,</span>
            <span class="s2">&quot;3047DE8A59764BEDAC9C3282093B16AF&quot;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="n">pauli_str_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Z0 X1&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="s1">&#39;Y2&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">0.543</span><span class="p">},</span>
            <span class="n">shots</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="n">initializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">diff_method</span><span class="o">=</span><span class="s2">&quot;parameter_shift&quot;</span><span class="p">,</span>
            <span class="n">submit_kwargs</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">query_kwargs</span><span class="o">=</span><span class="p">{})</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">1.2</span><span class="p">]],</span><span class="n">requires_grad</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">m_para</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="quantumlayermultiprocess">
<h3>QuantumLayerMultiProcess<a class="headerlink" href="#quantumlayermultiprocess" title="Link to this heading">¶</a></h3>
<p>如您更加熟悉pyQPanda22语法,可以使用QuantumLayerMultiProcess,自定义量子比特 <code class="docutils literal notranslate"><span class="pre">qubits</span></code> ,经典比特 <code class="docutils literal notranslate"><span class="pre">cbits</span></code> ,后端模拟器 <code class="docutils literal notranslate"><span class="pre">machine</span></code> 加入QuantumLayerMultiProcess的参数 <code class="docutils literal notranslate"><span class="pre">qprog_with_measure</span></code> 函数中。</p>
<dl class="py class">
<dt class="sig sig-object py" id="pyvqnet.qnn.quantumlayer.QuantumLayerMultiProcess">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.quantumlayer.</span></span><span class="sig-name descname"><span class="pre">QuantumLayerMultiProcess</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">qprog_with_measure</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">para_num</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_of_qubits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_of_cbits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">diff_method</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'parameter_shift'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">delta</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.01</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.quantumlayer.QuantumLayerMultiProcess" title="Link to this definition">¶</a></dt>
<dd><p>变分量子层的抽象计算模块。使用多进程技术对一个批次数据计算梯度时候的量子线路进行加速。对于线路深度较少的线路,该层的多线程加速效果并不明显。</p>
<p>该层对一个参数化的量子线路进行仿真,得到测量结果。该变分量子层继承了VQNet框架的梯度计算模块,可以计算线路参数的梯度,训练变分量子线路模型或将变分量子线路嵌入混合量子和经典模型。</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>qprog_with_measure</strong> – 用pyQPanda22构建的量子线路运行和测量函数。</p></li>
<li><p><strong>para_num</strong> – <cite>int</cite> - 参数个数。</p></li>
<li><p><strong>num_of_qubits</strong> – 量子比特数。</p></li>
<li><p><strong>num_of_cbits</strong> – 经典比特数,默认为1。</p></li>
<li><p><strong>diff_method</strong> – 求解量子线路参数梯度的方法,“参数位移”或“有限差分”,默认参数偏移。</p></li>
<li><p><strong>delta</strong> – 有限差分计算梯度时的 delta。</p></li>
<li><p><strong>dtype</strong> – 参数的数据类型,defaults:None,使用默认数据类型:kfloat32,代表32位浮点数。</p></li>
<li><p><strong>name</strong> – 这个模块的名字, 默认为””。</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>一个可以计算量子线路的模块。</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>qprog_with_measure是pyQPanda22中定义的量子线路函数 :<a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html</a>。</p>
<p>此函数应包含以下参数,否则无法在QuantumLayerMultiProcess中正常运行。</p>
<p>与QuantumLayerV2类似,该接口传入的变分线路运行函数中,用户应该手动创建量子比特和模拟器: <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/QuantumMachine.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/QuantumMachine.html</a>,</p>
<p>如果qprog_with_measure需要quantum measure,用户应该手动创建cbits: <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/Measure.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/Measure.html</a></p>
<p>量子线路函数 qprog_with_measure (input,param,nqubits,ncubits)的使用可参考下面的例子。对于线路深度较少的线路,该层的多线程加速效果并不明显。</p>
<p><cite>input</cite>: 输入一维经典数据。</p>
<p><cite>param</cite>: 输入一维量子线路的参数。</p>
<p><cite>nqubits</cite>: 预先设定的量子比特数量。如果没有,输入 0。</p>
<p><cite>ncubits</cite>: 预先设定的经典比特数量。如果没有,输入 0。</p>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbsMeasure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayerMultiProcess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pqctest</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">nqubits</span><span class="p">,</span><span class="n">ncubits</span><span class="p">):</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nb">input</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1">#print(circuit)</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>

    <span class="n">rlt_prob</span> <span class="o">=</span> <span class="n">ProbsMeasure</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">prog</span><span class="p">,</span><span class="n">machine</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rlt_prob</span>


<span class="n">pqc</span> <span class="o">=</span> <span class="n">QuantumLayerMultiProcess</span><span class="p">(</span><span class="n">pqctest</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#classic data as input</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="p">)</span>
<span class="c1">#forward circuits</span>
<span class="n">rlt</span> <span class="o">=</span> <span class="n">pqc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="n">grad</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rlt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1">#backward circuits</span>
<span class="n">rlt</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rlt</span><span class="p">)</span>

<span class="c1"># [</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000],</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000],</span>
<span class="c1"># [0.2500000, 0.2500000, 0.2500000, 0.2500000]</span>
<span class="c1"># ]</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="noisequantumlayer">
<h3>NoiseQuantumLayer<a class="headerlink" href="#noisequantumlayer" title="Link to this heading">¶</a></h3>
<p>在真实的量子计算机中,受制于量子比特自身的物理特性,常常存在不可避免的计算误差。为了能在量子虚拟机中更好的模拟这种误差,VQNet同样支持含噪声量子虚拟机。含噪声量子虚拟机的模拟更贴近真实的量子计算机,我们可以自定义支持的逻辑门类型,自定义逻辑门支持的噪声模型。
现有可支持的量子噪声模型依据QPanda中定义,具体参考链接 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/NoiseQVM.html">QPANDA2</a> 中的介绍。</p>
<p>使用 NoiseQuantumLayer 定义一个量子线路自动微分类,该类支持QPanda噪声虚拟机。用户定义一个函数作为参数 <code class="docutils literal notranslate"><span class="pre">qprog_with_measure</span></code> ,该函数需要包含pyQPanda22定义的量子线路,同样需要传入一个参数 <code class="docutils literal notranslate"><span class="pre">noise_set_config</span></code>,使用pyQPanda22接口,设置噪声模型。</p>
<dl class="py class">
<dt class="sig sig-object py" id="pyvqnet.qnn.quantumlayer.NoiseQuantumLayer">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.quantumlayer.</span></span><span class="sig-name descname"><span class="pre">NoiseQuantumLayer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">qprog_with_measure</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">para_num</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">machine_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_of_qubits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_of_cbits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">diff_method</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'parameter_shift'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">delta</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.01</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">noise_set_config</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.quantumlayer.NoiseQuantumLayer" title="Link to this definition">¶</a></dt>
<dd><blockquote>
<div><p>变分量子层的抽象计算模块。对一个参数化的量子线路进行仿真,得到测量结果。该变分量子层继承了VQNet框架的梯度计算模块,可以计算线路参数的梯度,训练变分量子线路模型或将变分量子线路嵌入混合量子和经典模型。</p>
</div></blockquote>
<p>这一层可以在量子线路中使用噪声模型。</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>qprog_with_measure</strong> – 用pyQPanda22构建的量子线路运行和测量函数。</p></li>
<li><p><strong>para_num</strong> – <cite>int</cite> - 参数个数。</p></li>
<li><p><strong>machine_type</strong> – qpanda机器类型。</p></li>
<li><p><strong>num_of_qubits</strong> – 量子比特数。</p></li>
<li><p><strong>num_of_cbits</strong> – 经典比特数,默认为1。</p></li>
<li><p><strong>diff_method</strong> – 求解量子线路参数梯度的方法,“参数位移”或“有限差分”,默认参数偏移。</p></li>
<li><p><strong>delta</strong> – 有限差分计算梯度时的 delta。</p></li>
<li><p><strong>noise_set_config</strong> – 噪声设置函数。</p></li>
<li><p><strong>dtype</strong> – 参数的数据类型,defaults:None,使用默认数据类型:kfloat32,代表32位浮点数。</p></li>
<li><p><strong>name</strong> – 这个模块的名字, 默认为””。</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>一个可以计算含噪声量子线路的模块。</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>qprog_with_measure是pyQPanda22中定义的量子线路函数 :<a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html">https://pyqpanda-toturial.readthedocs.io/zh/latest/QCircuit.html</a>。</p>
<p>此函数必须包含以下参数作为函数入参(即使某个参数未实际使用),否则无法在NoiseQuantumLayer中正常运行。</p>
<p>qprog_with_measure (input,param,qubits,cbits,machine)</p>
<blockquote>
<div><p><cite>input</cite>: 输入一维经典数据。如果没有输入可以输入 None。</p>
<p><cite>param</cite>: 输入一维的变分量子线路的待训练参数。</p>
<p><cite>qubits</cite>: 该NoiseQuantumLayer分配的量子比特,类型为pyQpanda.Qubits。</p>
<p><cite>cbits</cite>: cbits由NoiseQuantumLayer分配的经典比特,用来辅助测量函数,类型为 pyQpanda.ClassicalCondition。如果线路不使用cbits,也应保留此参数。</p>
<p><cite>machine</cite>: 由NoiseQuantumLayer创建的模拟器。</p>
</div></blockquote>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbsMeasure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoiseQuantumLayer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="k">def</span><span class="w"> </span><span class="nf">circuit</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span><span class="n">cbits</span><span class="p">,</span><span class="n">machine</span><span class="p">):</span>

    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">&lt;&lt;</span> <span class="n">measure_all</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">cbits</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">run_with_configuration</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">cbits</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Compute probabilities for each state</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="c1"># Get state expectation</span>
    <span class="n">expectation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">states</span> <span class="o">*</span> <span class="n">probabilities</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expectation</span>

<span class="k">def</span><span class="w"> </span><span class="nf">default_noise_config</span><span class="p">(</span><span class="n">qvm</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>

    <span class="n">p</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">PAULI_X_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">PAULI_Y_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">PAULI_Z_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RX_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RY_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RZ_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RY_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">HADAMARD_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">qves</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">qves</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span><span class="c1">#</span>
    <span class="n">qves</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">q</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">DAMPING_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">CNOT_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">qves</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">qvm</span>

<span class="n">qvc</span> <span class="o">=</span> <span class="n">NoiseQuantumLayer</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="s2">&quot;noise&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">diff_method</span><span class="o">=</span> <span class="s2">&quot;parameter_shift&quot;</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">noise_set_config</span> <span class="o">=</span> <span class="n">default_noise_config</span><span class="p">)</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>

    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>

    <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
    <span class="p">]</span> <span class="p">)</span>
<span class="n">rlt</span> <span class="o">=</span> <span class="n">qvc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="n">grad</span> <span class="o">=</span>  <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rlt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">rlt</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">qvc</span><span class="o">.</span><span class="n">m_para</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>

<span class="c1">#[1195., 105., 70., 0.,</span>
<span class="c1"># 45., -45., 50., 15.,</span>
<span class="c1"># -80., 50., 10., -30.,</span>
<span class="c1"># 10., 60., 75., -110.,</span>
<span class="c1"># 55., 45., 25., 5.,</span>
<span class="c1"># 5., 50., -25., -15.]</span>
</pre></div>
</div>
</dd></dl>

<p>下面给出一个 <code class="docutils literal notranslate"><span class="pre">noise_set_config</span></code> 的例子,这里使得 <code class="docutils literal notranslate"><span class="pre">RX</span></code> , <code class="docutils literal notranslate"><span class="pre">RY</span></code> , <code class="docutils literal notranslate"><span class="pre">RZ</span></code> , <code class="docutils literal notranslate"><span class="pre">X</span></code> , <code class="docutils literal notranslate"><span class="pre">Y</span></code> , <code class="docutils literal notranslate"><span class="pre">Z</span></code> , <code class="docutils literal notranslate"><span class="pre">H</span></code> 等逻辑门加入了 p = 0.01 的 BITFLIP_KRAUS_OPERATOR噪声模型。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">noise_set_config</span><span class="p">(</span><span class="n">qvm</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">PAULI_X_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">PAULI_Y_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">PAULI_Z_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RX_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RY_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RZ_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">RY_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">BITFLIP_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">HADAMARD_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">qves</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">qves</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span><span class="c1">#</span>
        <span class="n">qves</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">q</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">qvm</span><span class="o">.</span><span class="n">set_noise_model</span><span class="p">(</span><span class="n">NoiseModel</span><span class="o">.</span><span class="n">DAMPING_KRAUS_OPERATOR</span><span class="p">,</span> <span class="n">GateType</span><span class="o">.</span><span class="n">CNOT_GATE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">qves</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qvm</span>
</pre></div>
</div>
</section>
<section id="dataparallelhybirdvqcqpandaqvmlayer">
<h3>DataParallelHybirdVQCQpandaQVMLayer<a class="headerlink" href="#dataparallelhybirdvqcqpandaqvmlayer" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="pyvqnet.qnn.DataParallelHybirdVQCQpandaQVMLayer">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.</span></span><span class="sig-name descname"><span class="pre">DataParallelHybirdVQCQpandaQVMLayer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">vqc_module</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="nn.html#pyvqnet.nn.pyvqnet.nn.module.Module" title="pyvqnet.nn.pyvqnet.nn.module.Module"><span class="pre">Module</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">qcloud_token</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_qubits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_cubits</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pauli_str_dict</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">Dict</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Dict</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shots</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1000</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">submit_kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">{}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">query_kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">{}</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.DataParallelHybirdVQCQpandaQVMLayer" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">HybirdVQCQpandaQVMLayer</span></code> 的数据并行版本,其中 <code class="docutils literal notranslate"><span class="pre">vqc_module</span></code> 为用户自定义的量子变分线路模型,其中的QMachine设置 <code class="docutils literal notranslate"><span class="pre">save_ir=</span> <span class="pre">True</span></code> 。
使用数据并行将输入数据第一个维度 批处理数量 根据 <cite>CommController</cite> 中分配的进程数进行分割,在多个进程中基于 <cite>mpi</cite> 或者 <cite>nccl</cite> 进行数据并行。请注意一个进程对应一个节点上的GPU设备。
每个进程中的该模块在前向计算时提交 批处理数量/节点数 个数据产生的量子线路,反向计算中计算 批处理数量/节点数 个数据贡献的梯度,并通过all_reduce计算多个节点上参数的平均梯度。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>该模块内部对输入切分,并将数据移动到对应设备上。第0个进程计算[0,批处理数量/节点数]数据,第k个进程计算[(k-1)批处理数量/节点数,k*批处理数量/节点数]</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>vqc_module</strong> – 带有 forward() 的 vqc_module。</p></li>
<li><p><strong>qcloud_token</strong> – <cite>str</cite> - 量子机器的类型或用于执行的云令牌。</p></li>
<li><p><strong>num_qubits</strong> – <cite>int</cite> - 量子电路中的量子比特数。</p></li>
<li><p><strong>num_cubits</strong> – <cite>int</cite> - 量子电路中用于测量的经典比特数。</p></li>
<li><p><strong>pauli_str_dict</strong> – <cite>dict|list</cite> - 表示量子电路中泡利算子的字典或字典列表。默认值为 None。</p></li>
<li><p><strong>shots</strong> – <cite>int</cite> - 量子线路测量次数。默认值为 1000。</p></li>
<li><p><strong>name</strong> – 模块名称。默认值为空字符串。</p></li>
<li><p><strong>submit_kwargs</strong> – 提交量子电路的附加关键字参数,默认值:
{“chip_id”:pyqpanda.real_chip_type.origin_72,
“is_amend”:True,”is_mapping”:True,
“is_optimization”:True,
“default_task_group_size”:200,
“test_qcloud_fake”:True}。</p></li>
<li><p><strong>query_kwargs</strong> – 查询量子结果的附加关键字参数,默认值:{“timeout”:2,”print_query_info”:True,”sub_circuits_split_size”:1}。</p></li>
</ul>
</dd>
</dl>
<p>以下是使用cpu计算的mpi例子,单节点双进程的命令如下： mpirun -n 2 python xxx.py</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">Comm_OP</span> <span class="o">=</span> <span class="n">CommController</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.device</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEV_GPU_0</span>
<span class="n">pyvqnet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Hybird</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cl1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ql</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">(</span><span class="n">num_wires</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cl2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ql</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">grad_mode</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_num_wires</span> <span class="o">=</span> <span class="n">num_wires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">num_wires</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">grad_mode</span><span class="o">=</span><span class="n">grad_mode</span><span class="p">,</span>
                        <span class="n">save_ir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rx_layer</span> <span class="o">=</span> <span class="n">RX</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ry_layer</span> <span class="o">=</span> <span class="n">RY</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rz_layer</span> <span class="o">=</span> <span class="n">RZ</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u1</span> <span class="o">=</span> <span class="n">U1</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u2</span> <span class="o">=</span> <span class="n">U2</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u3</span> <span class="o">=</span> <span class="n">U3</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">X1</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">Y1</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z1</span> <span class="o">=</span> <span class="n">Z1</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">PauliX</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">PauliY</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">PauliZ</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap</span> <span class="o">=</span> <span class="n">SWAP</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cz</span> <span class="o">=</span> <span class="n">CZ</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="n">CR</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxx</span> <span class="o">=</span> <span class="n">RXX</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rzz</span> <span class="o">=</span> <span class="n">RYY</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ryy</span> <span class="o">=</span> <span class="n">RZZ</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rzx</span> <span class="o">=</span> <span class="n">RZX</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toffoli</span> <span class="o">=</span> <span class="n">Toffoli</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#self.rz_layer2 = RZ(has_params=True, trainable=True, wires=1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">Hadamard</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iSWAP</span> <span class="o">=</span> <span class="n">iSWAP</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlayer</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnot</span> <span class="o">=</span> <span class="n">CNOT</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Z0&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Y3&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z1</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ryy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rzz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rzx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u1</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u2</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rx_layer</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iSWAP</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ry_layer</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlayer</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rz_layer</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toffoli</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">rlt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rlt</span>

<span class="n">input_x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]])</span>
<span class="n">input_x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">input_x</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>



<span class="n">qunatum_model</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">(</span><span class="n">num_wires</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex64</span><span class="p">)</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">DataParallelHybirdVQCQpandaQVMLayer</span><span class="p">(</span>
    <span class="n">Comm_OP</span><span class="p">,</span>
    <span class="n">qunatum_model</span><span class="p">,</span>
    <span class="s2">&quot;3047DE8A59764BEDAC9C3282093B16AF1&quot;</span><span class="p">,</span>

    <span class="n">num_qubits</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">num_cubits</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">pauli_str_dict</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;Z0&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;Y3&#39;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="n">shots</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">submit_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;test_qcloud_fake&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="n">query_kwargs</span><span class="o">=</span><span class="p">{})</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">l</span><span class="p">(</span><span class="n">input_x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">qunatum_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
</pre></div>
</div>
<p>以下是使用gpu计算的nccl例子,单节点双进程的命令如下： mpirun -n 2 python xxx.py</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">Comm_OP</span> <span class="o">=</span> <span class="n">CommController</span><span class="p">(</span><span class="s2">&quot;nccl&quot;</span><span class="p">)</span>
<span class="c1">#input_x = tensor.QTensor([[0.1, 0.2, 0.3]])</span>
<span class="n">input_x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]],</span><span class="n">device</span><span class="o">=</span><span class="n">Comm_OP</span><span class="o">.</span><span class="n">get_local_rank</span><span class="p">()</span> <span class="o">+</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">DEV_GPU_0</span><span class="p">)</span>
<span class="c1">#rest code not changed</span>
</pre></div>
</div>
<p>以下是进行多节点多进程并行计算的例子,请保证在不同节点的相同路径下,相同python环境下运行该脚本,并在每个节点下
编写ip地址映射文件 <cite>hosts</cite>,格式参考  <a class="reference internal" href="nn.html#hostfile"><span class="std std-ref">hostfile, f, hostfile</span></a> 。</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hosts示例</span>
<span class="mf">10.10.7.107</span> <span class="n">slots</span><span class="o">=</span><span class="mi">2</span>
<span class="mf">10.10.7.109</span> <span class="n">slots</span><span class="o">=</span><span class="mi">2</span>
</pre></div>
</div>
<p>使用 mpi 进行2节点每节点2进程共4进程并行,则可以运行 <cite>vqnetrun -np 4 -f hosts python xxx.py</cite></p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="n">Comm_OP</span> <span class="o">=</span> <span class="n">CommController</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">)</span>
<span class="c1">#rest code not changed</span>
</pre></div>
</div>
<p>使用 nccl 进行2节点每节点2进程共4进程并行,则可以运行 <cite>vqnetrun -np 4 -f hosts python xxx.py</cite></p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="n">Comm_OP</span> <span class="o">=</span> <span class="n">CommController</span><span class="p">(</span><span class="s2">&quot;nccl&quot;</span><span class="p">)</span>
<span class="c1">#input_x = tensor.QTensor([[0.1, 0.2, 0.3]])</span>
<span class="n">input_x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]],</span><span class="n">device</span><span class="o">=</span><span class="n">Comm_OP</span><span class="o">.</span><span class="n">get_local_rank</span><span class="p">()</span> <span class="o">+</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">DEV_GPU_0</span><span class="p">)</span>
<span class="c1">#rest code not changed</span>
</pre></div>
</div>
</dd></dl>

</section>
</section>
<section id="id3">
<h2>量子逻辑门<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p>处理量子比特的方式就是量子逻辑门。 使用量子逻辑门,我们有意识的使量子态发生演化。量子逻辑门是构成量子算法的基础。</p>
<section id="id4">
<h3>基本量子逻辑门<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>在VQNet中,我们使用本源量子自研的 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">pyqpanda</a> 的各个逻辑门搭建量子线路,进行量子模拟。
当前pyQPanda22支持的逻辑门可参考pyQPanda2 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">量子逻辑门</a> 部分的定义。
此外VQNet还封装了部分在量子机器学习中常用的量子逻辑门组合:</p>
</section>
<section id="amplitudeembeddingcircuit">
<h3>AmplitudeEmbeddingCircuit<a class="headerlink" href="#amplitudeembeddingcircuit" title="Link to this heading">¶</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="pyvqnet.qnn.template.AmplitudeEmbeddingCircuit">
<span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.template.</span></span><span class="sig-name descname"><span class="pre">AmplitudeEmbeddingCircuit</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_feat</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">qubits</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.template.AmplitudeEmbeddingCircuit" title="Link to this definition">¶</a></dt>
<dd><p>将 <span class="math notranslate nohighlight">\(2^n\)</span> 特征编码为 <span class="math notranslate nohighlight">\(n\)</span> 量子比特的振幅向量。为了表示一个有效的量子态向量, <code class="docutils literal notranslate"><span class="pre">features</span></code> 的L2范数必须是1。</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_feat</strong> – 表示参数的numpy数组。</p></li>
<li><p><strong>qubits</strong> – pyQPanda2分配的量子比特列表。</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>量子线路。</p>
</dd>
</dl>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">AmplitudeEmbeddingCircuit</span>
<span class="n">input_feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">3.7</span><span class="p">])</span>
<span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">init_quantum_machine</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">QMachineType</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
<span class="n">m_qlist</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">m_clist</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">cAlloc_many</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">m_prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
<span class="n">cir</span> <span class="o">=</span> <span class="n">AmplitudeEmbeddingCircuit</span><span class="p">(</span><span class="n">input_feat</span><span class="p">,</span><span class="n">m_qlist</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>
<span class="n">pq</span><span class="o">.</span><span class="n">destroy_quantum_machine</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>

<span class="c1">#                              ┌────────────┐     ┌────────────┐</span>
<span class="c1"># q_0:  |0&gt;─────────────── ─── ┤RY(0.853255)├ ─── ┤RY(1.376290)├</span>
<span class="c1">#           ┌────────────┐ ┌─┐ └──────┬─────┘ ┌─┐ └──────┬─────┘</span>
<span class="c1"># q_1:  |0&gt;─┤RY(2.355174)├ ┤X├ ───────■────── ┤X├ ───────■──────</span>
<span class="c1">#           └────────────┘ └─┘                └─┘</span>
</pre></div>
</div>
</dd></dl>

</section>
</section>
<section id="id6">
<h2>基于pyqpanda2量子机器学习算法封装接口<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h2>
<p>以下使用pyqpanda2构建线路,并在pyvqnet中实现了一些经典量子机器学习算法。</p>
<section id="qgan">
<h3>QGAN制备任意分布初态<a class="headerlink" href="#qgan" title="Link to this heading">¶</a></h3>
<p>基于2019年 Christa Zoufal 的论文 <a class="reference external" href="https://www.nature.com/articles/s41534-019-0223-2">Quantum Generative Adversarial Networks for learning and loading random distributions</a> , VQNet提供了一个QGAN制备任意分布初态的例子。该算法使用纯量子变分线路制备特定随机分布的生成量子态,可以减少原先生成特定量子态所需的逻辑门,降低量子线路复杂度。
QGAN使用经典的GAN模型结构,分为Generator生成器与Discriminator鉴别器两个子模型,Generator为量子线路产生特定分布,而Generator生成的分布generated data samples 以及真实的随机分布training data samples 输入Discriminator模型进行鉴别真伪。</p>
<a class="reference internal image-reference" href="../_images/qgan-arch.PNG"><img alt="../_images/qgan-arch.PNG" class="align-center" src="../_images/qgan-arch.PNG" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>构建VQNet的量子生成对抗网络接口 <code class="docutils literal notranslate"><span class="pre">QGANAPI</span></code> 类,我们可以对真实分布的数据 real_data 使用量子生成器进行初态制备。这里使用量子比特数为3,量子生成器内部含参线路模块重复次数为1。
使用的评价指标为KL散度。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.qgan.qgan_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">QGANAPI</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="c1">##################################</span>
<span class="n">num_of_qubits</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># paper config</span>
<span class="n">rep</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">number_of_data</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="c1"># Load data samples from different distributions</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">real_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">number_of_data</span><span class="p">)</span>


<span class="c1"># intial</span>
<span class="n">save_dir</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">qgan_model</span> <span class="o">=</span> <span class="n">QGANAPI</span><span class="p">(</span>
    <span class="n">real_data</span><span class="p">,</span>
    <span class="c1"># numpy generated data distribution, 1 - dim.</span>
    <span class="n">num_of_qubits</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">q_g_cir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="n">num_of_qubits</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">reps</span><span class="o">=</span><span class="n">rep</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;kl&quot;</span><span class="p">,</span>
    <span class="n">tol_rel_ent</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">if_save_param_dir</span><span class="o">=</span><span class="n">save_dir</span>
<span class="p">)</span>
</pre></div>
</div>
<p>接下来使用其训练接口 <code class="docutils literal notranslate"><span class="pre">train</span></code> 训练。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># train</span>
<span class="n">qgan_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># train qgan</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">eval</span></code> 画出其与真实分布之间的概率分布函数对比:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># show probability distribution function of generated distribution and real distribution</span>
<span class="n">qgan_model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">real_data</span><span class="p">)</span>  <span class="c1">#draw pdf</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">get_trained_quantum_parameters</span></code> 获取训练参数并输出为一个numpy数组形式。如果 <code class="docutils literal notranslate"><span class="pre">save_dir</span></code> 不为空,则该类将保存参数到文件中。可以通过 <code class="docutils literal notranslate"><span class="pre">load_param_and_eval</span></code> 函数载入参数,并可以通过
<code class="docutils literal notranslate"><span class="pre">get_circuits_with_trained_param</span></code> 获取训练完参数的量子生成器pyQPanda2线路。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get trained quantum parameters</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">qgan_model</span><span class="o">.</span><span class="n">get_trained_quantum_parameters</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; trained param </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#load saved parameters files</span>
<span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">save_dir</span><span class="p">,</span> <span class="n">qgan_model</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">+</span> <span class="s2">&quot;trained_qgan_param.pickle&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">t3</span><span class="p">[</span><span class="s2">&quot;quantum_parameters&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; trained param </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#show probability distribution function of generated distribution and real distribution</span>
<span class="n">qgan_model</span><span class="o">.</span><span class="n">load_param_and_eval</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

<span class="c1">#calculate metric</span>
<span class="nb">print</span><span class="p">(</span><span class="n">qgan_model</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;kl&quot;</span><span class="p">))</span>

<span class="c1">#get generator quantum circuit</span>
<span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
<span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
<span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_of_qubits</span><span class="p">)</span>
<span class="n">qpanda_cir</span> <span class="o">=</span> <span class="n">qgan_model</span><span class="o">.</span><span class="n">get_circuits_with_trained_param</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">qpanda_cir</span><span class="p">)</span>
</pre></div>
</div>
<p>生成lognormal分布的损失函数以及概率分布函数图,一般来说需要使用不同的随机种子多次训练该模型可得到较好结果:</p>
<a class="reference internal image-reference" href="../_images/qgan-loss.png"><img alt="../_images/qgan-loss.png" class="align-center" src="../_images/qgan-loss.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<a class="reference internal image-reference" href="../_images/qgan-pdf.png"><img alt="../_images/qgan-pdf.png" class="align-center" src="../_images/qgan-pdf.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="svm">
<h3>量子核SVM算法<a class="headerlink" href="#svm" title="Link to this heading">¶</a></h3>
<p>在机器学习任务中,数据通常不能被原始空间中的超平面分隔。寻找此类超平面的一种常见技术是对数据应用非线性变换函数。
此函数称为特征映射,通过特征映射,我们可以在这个新的特征空间中计算数据点之间的距离有多近,从而进行机器学习的分类任务。</p>
<p>本例参照 <a class="reference external" href="https://arxiv.org/pdf/1804.11326.pdf">Supervised learning with quantum enhanced feature spaces</a> 论文的第一个方法构建变分线路进行数据分类任务。
<code class="docutils literal notranslate"><span class="pre">gen_vqc_qsvm_data</span></code> 为生成该例子所需的数据。 <code class="docutils literal notranslate"><span class="pre">vqc_qsvm</span></code> 为变分量子线路类,用来对输入数据进行分类。
<code class="docutils literal notranslate"><span class="pre">vqc_qsvm.plot()</span></code> 函数可视化了数据的分布情况。</p>
<a class="reference internal image-reference" href="../_images/VQC-SVM.png"><img alt="../_images/VQC-SVM.png" class="align-center" src="../_images/VQC-SVM.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">vqc_qsvm</span><span class="p">,</span> <span class="n">gen_vqc_qsvm_data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">maxiter</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">training_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">gap</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="c1">#线路模块重复次数</span>
<span class="n">rep</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1">#定义接口类</span>
<span class="n">VQC_QSVM</span> <span class="o">=</span> <span class="n">vqc_qsvm</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>
<span class="c1">#随机生成数据</span>
<span class="n">train_features</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> \
    <span class="n">gen_vqc_qsvm_data</span><span class="p">(</span><span class="n">training_size</span><span class="o">=</span><span class="n">training_size</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">)</span>
<span class="n">VQC_QSVM</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_features</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
<span class="c1">#训练</span>
<span class="n">VQC_QSVM</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
<span class="c1">#测试数据测试</span>
<span class="n">rlt</span><span class="p">,</span> <span class="n">acc_1</span> <span class="o">=</span> <span class="n">VQC_QSVM</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_features</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;testing_accuracy </span><span class="si">{</span><span class="n">acc_1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>除了上述直接用变分量子线路将经典数据特征映射到量子特征空间,在论文 <a class="reference external" href="https://arxiv.org/pdf/1804.11326.pdf">Supervised learning with quantum enhanced feature spaces</a>
中还介绍了使用量子线路直接估计核函数,并使用经典支持向量机进行分类的方法。类比经典SVM中的各种核函数 <span class="math notranslate nohighlight">\(K(i,j)\)</span> , 使用量子核函数定义经典数据在量子特征空间 <span class="math notranslate nohighlight">\(\phi(\mathbf{x}_i)\)</span> 的内积 :</p>
<div class="math notranslate nohighlight">
\[|\langle \phi(\mathbf{x}_j) | \phi(\mathbf{x}_i) \rangle |^2 =  |\langle 0 | U^\dagger(\mathbf{x}_j) U(\mathbf{x}_i) | 0 \rangle |^2\]</div>
<p>使用VQNet和pyQPanda2,我们定义一个 <code class="docutils literal notranslate"><span class="pre">QuantumKernel_VQNet</span></code> 产生量子核函数,并使用 <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> 的 <code class="docutils literal notranslate"><span class="pre">SVC</span></code> 进行分类:</p>
<a class="reference internal image-reference" href="../_images/qsvm-kernel.png"><img alt="../_images/qsvm-kernel.png" class="align-center" src="../_images/qsvm-kernel.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda.Visualization.circuit_draw</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumKernel_VQNet</span><span class="p">,</span> <span class="n">gen_vqc_qsvm_data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">train_features</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span><span class="n">train_labels</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">gen_vqc_qsvm_data</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">quantum_kernel</span> <span class="o">=</span> <span class="n">QuantumKernel_VQNet</span><span class="p">(</span><span class="n">n_qbits</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">quantum_svc</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">quantum_kernel</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
<span class="n">quantum_svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">quantum_svc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_features</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;quantum kernel classification test score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>同时扰动随机近似优化器<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="pyvqnet.qnn.SPSA">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.</span></span><span class="sig-name descname"><span class="pre">SPSA</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">maxiter</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1000</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_avg</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">c0</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">_C0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">c1</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">c2</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.602</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">c3</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.101</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">c4</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">init_para</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">calibrate_flag</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.SPSA" title="Link to this definition">¶</a></dt>
<dd><p>同时扰动随机近似 (SPSA) 优化器。</p>
<p>SPSA 提供了一种用于逼近多元可微成本函数梯度的随机方法。
为实现这一点,使用扰动参数向量对成本函数进行两次评估:原始参数向量的每个分量同时随随机生成的值移动。
<a class="reference external" href="http://www.jhuapl.edu/SPSA">SPSA 网站</a> 上提供了进一步的介绍。</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>maxiter</strong> – 要执行的最大迭代次数。默认值:1000。</p></li>
<li><p><strong>last_avg</strong> – last_avg 迭代的平均参数。
如果 last_avg = 1,则只考虑最后一次迭代。默认值:1。</p></li>
<li><p><strong>c0</strong> – 初始a。更新参数的步长。默认值:0.2*pi</p></li>
<li><p><strong>c1</strong> – 初始的c。用于近似梯度的步长。默认值:0.1。</p></li>
<li><p><strong>c2</strong> – 论文中的alpha,用于在每次迭代时调整a(c0)。默认值:0.602。</p></li>
<li><p><strong>c3</strong> – 论文中的gamma,每次迭代时用来调整c(c1)。默认值:0.101。</p></li>
<li><p><strong>c4</strong> – 同样用来控制a的参数。默认值:0。</p></li>
<li><p><strong>init_para</strong> – 初始化参数。默认值:无。</p></li>
<li><p><strong>model</strong> – 参数模型:模型。默认值:无。</p></li>
<li><p><strong>calibrate_flag</strong> – 是否校准超参数 a 和 c,默认值:False。</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>一个SPSA优化器实例</p>
</dd>
</dl>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>SPSA只支持一维的输入参数。</p>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">AngleEmbeddingCircuit</span><span class="p">,</span> <span class="n">expval</span><span class="p">,</span> <span class="n">QuantumLayerV2</span><span class="p">,</span> <span class="n">SPSA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">BasicEntanglerTemplate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="c1">#定义一个量子变分线路模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Model_spsa</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model_spsa</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span> <span class="o">=</span> <span class="n">QuantumLayerV2</span><span class="p">(</span><span class="n">layer_fn_spsa_pq</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

<span class="c1">#本例线路是最小化该VQC的期望值</span>
<span class="k">def</span><span class="w"> </span><span class="nf">layer_fn_spsa_pq</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">num_of_qubits</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_of_qubits</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">AngleEmbeddingCircuit</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bc_class</span> <span class="o">=</span> <span class="n">BasicEntanglerTemplate</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">bc_class</span><span class="o">.</span><span class="n">create_circuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="n">m_prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
    <span class="n">pauli_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z0&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">m_prog</span><span class="p">,</span> <span class="n">pauli_dict</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exp2</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model_spsa</span><span class="p">()</span>
<span class="c1">#定义一个SPSA优化器</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">SPSA</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">init_para</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyvqnet.qnn.SPSA._step">
<span class="sig-prename descclassname"><span class="pre">pyvqnet.qnn.SPSA.</span></span><span class="sig-name descname"><span class="pre">_step</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_data</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyvqnet.qnn.SPSA._step" title="Link to this definition">¶</a></dt>
<dd><p>优化 sapa 优化器</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>input_data</strong> – 输入训练数据QTensor</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>train_para:最终参数。</p>
<p>theta_best:最后 <cite>last_avg</cite> 次优化后的平均参数。</p>
</p>
</dd>
</dl>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">SPSA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">AngleEmbeddingCircuit</span><span class="p">,</span> <span class="n">expval</span><span class="p">,</span> <span class="n">QuantumLayerV2</span><span class="p">,</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">BasicEntanglerTemplate</span>

<span class="c1">#定义一个量子变分线路模型</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Model_spsa</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model_spsa</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span> <span class="o">=</span> <span class="n">QuantumLayerV2</span><span class="p">(</span><span class="n">layer_fn_spsa_pq</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

<span class="c1">#本例线路是最小化该VQC的期望值</span>
<span class="k">def</span><span class="w"> </span><span class="nf">layer_fn_spsa_pq</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">num_of_qubits</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_of_qubits</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">AngleEmbeddingCircuit</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bc_class</span> <span class="o">=</span> <span class="n">BasicEntanglerTemplate</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">bc_class</span><span class="o">.</span><span class="n">create_circuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="n">m_prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
    <span class="n">pauli_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z0&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">m_prog</span><span class="p">,</span> <span class="n">pauli_dict</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exp2</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model_spsa</span><span class="p">()</span>
<span class="c1">#定义一个SPSA优化器</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">SPSA</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">init_para</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">#初始化参数</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.27507603</span><span class="p">]]))</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">_core</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.97507603</span><span class="p">,</span> <span class="mf">3.12950603</span><span class="p">,</span> <span class="mf">1.00854038</span><span class="p">,</span>
                <span class="mf">1.25907603</span><span class="p">]))</span>
<span class="c1">#调用SPSA进行迭代优化</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="c1">#计算优化后的VQC期望值</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="utils.html" class="btn btn-neutral float-left" title="实用函数" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="qnn_pq3.html" class="btn btn-neutral float-right" title="使用pyQPanda3量子机器学习模块" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Original Quantum.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>