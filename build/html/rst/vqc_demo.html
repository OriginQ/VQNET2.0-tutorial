

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>使用自动微分模拟的量子机器学习示例 &mdash; VQNET v2.15.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/documentation_options.js?v=a149e6fc"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="使用pyQPanda2的量子机器学习示例" href="qml_demo.html" />
    <link rel="prev" title="VQNet 安装步骤" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VQNET
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">安装介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">VQNet 安装步骤</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">上手实例</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">使用自动微分模拟的量子机器学习示例</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">量子自然梯度接口示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">用于手写数字识别的量子核函数模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">基于小样本的量子卷积神经网络模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hqcnn">混合量子经典神经网络的HQCNN示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id6">量子重载入算法示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#circuit-centric-quantum-classifiers">Circuit-centric quantum classifiers算法示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">量子经典迁移学习的示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variational-shadow-quantum-learning-for-classification">Variational Shadow Quantum Learning for Classification模型示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#qmlp">QMLP模型示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">使用量子经典混合神经网络模型实现一种强化学习算法的示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gpu">使用量子变分线路在GPU上拟合一个傅里叶级数的示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id10">量子奇异值分解</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id11">变分量子线路的优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dropout">量子dropout实现</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="qml_demo.html">使用pyQPanda2的量子机器学习示例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">经典神经网络接口介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="QTensor.html">QTensor 模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="nn.html">经典神经网络模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">实用函数</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用pyqpanda的量子神经网络接口</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="qnn.html">使用pyQPanda2量子机器学习模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="qnn_pq3.html">使用pyQPanda3量子机器学习模块</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">量子神经网络自动微分模拟接口</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="vqc.html">变分量子线路自动微分模拟</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">量子大模型微调</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="llm.html">量子大模型微调示例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">其他</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="torch_api.html">VQNet使用torch进行底层计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">VQNet Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VQNET</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">使用自动微分模拟的量子机器学习示例</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/rst/vqc_demo.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>使用自动微分模拟的量子机器学习示例<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p>下面的例子使用 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 下的变分量子线路接口实现一些量子机器学习算法和示例。 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 下的变分量子线路接口使用态矢来表示量子态在量子逻辑门下的演化,通过自动微分计算变分量子线路中的梯度。</p>
<p>请注意下例子中 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc.QMachine</span></code> 的使用,该类存放了量子态矢的数据,当计算批量数据时候或者每次进行测量之后,必须进行 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc.QMachine.reset_states</span></code> 重新初始化态矢数据到输入数据的batch_size大小。
<code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 还提供了 MeasureAll,Probability,Samples 等测量接口。</p>
<p>此外, <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc.QModule</span></code> 为用户定义的计算自动微分量子线路模型需要继承的类,需要像经典神经网络模型一样,定义 <cite>__init__</cite> 以及 <cite>forward</cite> 函数。
当模型最后的 <code class="docutils literal notranslate"><span class="pre">QTensor</span></code> 运行 <cite>backward</cite> 后,就能使用自动微分模拟计算出 <code class="docutils literal notranslate"><span class="pre">QModule</span></code> 中变分量子线路的参数梯度,并可以通过梯度下降法相关的优化器进行更新。</p>
<section id="id2">
<h2>量子自然梯度接口示例<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p>量子机器学习模型一般使用梯度下降法对可变量子逻辑线路中参数进行优化。经典梯度下降法公式如下:</p>
<div class="math notranslate nohighlight">
\[\theta_{t+1} = \theta_t -\eta \nabla \mathcal{L}(\theta),\]</div>
<p>本质上,每次迭代时候,我们将计算参数空间下,梯度下降最陡的方向作为参数变化的方向。
在空间中任何一个方向,在局部范围内下降的速度都不如负梯度方向快。
不同空间上,最速下降方向的推导是依赖于参数微分的范数——距离度量。距离度量在这里起着核心作用,
不同的度量会得到不同的最速下降方向。对于经典优化问题中参数所处的欧几里得空间,最速下降方向就是负梯度方向。
即使如此,在参数优化的每一步,由于损失函数随着参数的变化,其参数空间发生变换。使得找到另一个更优的距离范数成为可能。</p>
<p><a class="reference external" href="https://arxiv.org/abs/1909.02108">量子自然梯度法</a> 借鉴经典自然梯度法的概念 <a class="reference external" href="https://www.mitpressjournals.org/doi/abs/10.1162/089976698300017746">Amari (1998)</a> ,
我们改为将优化问题视为给定输入的可能输出值的概率分布(即,最大似然估计),则更好的方法是在分布
空间中执行梯度下降,它相对于参数化是无量纲和不变的. 因此,无论参数化如何,每个优化步骤总是会为每个参数选择最佳步长。
在量子机器学习任务中,量子态空间拥有一个独特的不变度量张量,称为 Fubini-Study 度量张量 <span class="math notranslate nohighlight">\(g_{ij}\)</span>。
该张量将量子线路参数空间中的最速下降转换为分布空间中的最速下降。
量子自然梯度的公式如下:</p>
<div class="math notranslate nohighlight">
\[\theta_{t+1} = \theta_t - \eta g^{+}(\theta_t)\nabla \mathcal{L}(\theta),\]</div>
<p>其中 <span class="math notranslate nohighlight">\(g^{+}\)</span> 是伪逆。</p>
<p>以下我们基于VQNet实现对一个量子变分线路参数进行量子自然梯度优化的例子,其中 <code class="docutils literal notranslate"><span class="pre">wrapper_calculate_qng</span></code> 是需要加到待计算量子自然梯度的模型的forward函数的装饰器。
通过 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc.QNG</span></code> 的 量子自然梯度优化器,可对模型注册的 <cite>Parameter</cite> 类型的参数优化。</p>
<p>我们的目标是使如下的量子变分线路的期望最小,可见其中含有两层共3个量子含参逻辑门,第一层由0和1比特上的 RZ, RY 逻辑门构成,第二层由2比特上的RX 逻辑门构成。</p>
<a class="reference internal image-reference" href="../_images/qng_all_cir.png"><img alt="../_images/qng_all_cir.png" class="align-center" src="../_images/qng_all_cir.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">vqc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrapper_calculate_qng</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>



<span class="k">class</span><span class="w"> </span><span class="nc">Hmodel</span><span class="p">(</span><span class="n">vqc</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span><span class="n">init_t</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Hmodel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_wires</span> <span class="o">=</span> <span class="n">num_wires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">vqc</span><span class="o">.</span><span class="n">QMachine</span><span class="p">(</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kfloat64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">init_from_tensor</span><span class="p">(</span><span class="n">init_t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">vqc</span><span class="o">.</span><span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Y0&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>

    <span class="nd">@wrapper_calculate_qng</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># V0(theta0, theta1): Parametrized layer 0</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># W1: non-parametrized gates</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># V_1(theta2, theta3): Parametrized layer 1</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">rx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># W2: non-parametrized gates</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>



<span class="k">class</span><span class="w"> </span><span class="nc">Hmodel2</span><span class="p">(</span><span class="n">vqc</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span><span class="n">init_t</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Hmodel2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_wires</span> <span class="o">=</span> <span class="n">num_wires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">vqc</span><span class="o">.</span><span class="n">QMachine</span><span class="p">(</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kfloat64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">init_from_tensor</span><span class="p">(</span><span class="n">init_t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">vqc</span><span class="o">.</span><span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Y0&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># V0(theta0, theta1): Parametrized layer 0</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># W1: non-parametrized gates</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># V_1(theta2, theta3): Parametrized layer 1</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">rx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># W2: non-parametrized gates</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">vqc</span><span class="o">.</span><span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
</pre></div>
</div>
<p>使用SGD经典梯度下降法作为基线比较两者在相同迭代次数下的损失值变化情况,可见使用量子自然梯度,该损失函数下降更快。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">steps</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([</span><span class="mf">0.432</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.123</span><span class="p">,</span> <span class="mf">0.543</span><span class="p">,</span> <span class="mf">0.233</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kfloat64</span><span class="p">)</span>
<span class="n">qng_model</span> <span class="o">=</span> <span class="n">Hmodel</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex128</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
<span class="n">qng</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">qnn</span><span class="o">.</span><span class="n">vqc</span><span class="o">.</span><span class="n">QNG</span><span class="p">(</span><span class="n">qng_model</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">qng_cost</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
    <span class="n">qng</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">qng</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">qng_model</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">qng_cost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([</span><span class="mf">0.432</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.123</span><span class="p">,</span> <span class="mf">0.543</span><span class="p">,</span> <span class="mf">0.233</span><span class="p">],</span>
            <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kfloat64</span><span class="p">)</span>
<span class="n">qng_model</span> <span class="o">=</span> <span class="n">Hmodel2</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex128</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
<span class="n">sgd</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">qng_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">sgd_cost</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>

    <span class="n">sgd</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">qng_model</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">sgd</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="n">sgd_cost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span>


<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qng_cost</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Quantum natural gradient descent&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sgd_cost</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Vanilla gradient descent&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cost function value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Optimization steps&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;qng_new_compare.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/qng_vs_sgd.png"><img alt="../_images/qng_vs_sgd.png" class="align-center" src="../_images/qng_vs_sgd.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id4">
<h2>用于手写数字识别的量子核函数模型<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p>下面的例子使用 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 下的变分量子线路接口实现了论文 <a class="reference external" href="https://link.springer.com/article/10.1007/s42484-023-00107-2">Quantum Advantage Seeker with Kernels (QuASK): a software framework to speed up the research in quantum machine learning</a> 中的量子核函数,基于手写数字数据集来对量子核的性能进行评估。</p>
<p>本次实验基于crz、ZZFeatureMap逻辑门实现了量子核矩阵以及量子核映射中两种线路的设计。
算法输入数据为维度8*8的手写数字数据集, 通过PCA降维, 将输入的数据降维到相应的比特数的维度如2、4、8, 之后对数据进行标准化处理后, 获取训练数据集以及测试数据用于训练, 本次实现可分为两个, 分别为量子核矩阵以及核映射。
量子核矩阵由量子线路计算每一对数据的相似度,随后组成矩阵后输出；
量子核映射则分别计算两组数据映射后计算两组数据的相似度矩阵。</p>
<p>具体代码实现如下,需要额外安装 <cite>sklearn</cite>, <cite>scipy</cite> 等:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">sqrtm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">expm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">la</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet</span><span class="w"> </span><span class="kn">import</span> <span class="n">_core</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc.qcircuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">PauliZ</span><span class="p">,</span> <span class="n">VQC_ZZFeatureMap</span><span class="p">,</span><span class="n">PauliX</span><span class="p">,</span><span class="n">PauliY</span><span class="p">,</span><span class="n">hadamard</span><span class="p">,</span><span class="n">crz</span><span class="p">,</span><span class="n">rz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc.qmeasure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ft</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="c1"># data load</span>
<span class="n">digits</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_digits</span><span class="p">(</span><span class="n">n_class</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># create lists to save the results</span>
<span class="n">gaussian_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">quantum_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">projected_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">quantum_gaussian</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">projected_gaussian</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># reduce dimensionality</span>

<span class="k">def</span><span class="w"> </span><span class="nf">custom_data_map_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    custom data map function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ft</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">m</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeff</span>

<span class="k">def</span><span class="w"> </span><span class="nf">vqnet_quantum_kernel</span><span class="p">(</span><span class="n">X_1</span><span class="p">,</span> <span class="n">X_2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">X_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X_2</span> <span class="o">=</span> <span class="n">X_1</span>  <span class="c1"># Training Gram matrix</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">X_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">X_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">),</span> <span class="s2">&quot;The training and testing data must have the same dimensionality&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">X_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># create projector (measures probability of having all &quot;00...0&quot;)</span>
    <span class="n">projector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">N</span><span class="p">))</span>
    <span class="n">projector</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">projector</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">projector</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kcomplex128</span><span class="p">)</span>
    <span class="c1"># define the circuit for the quantum kernel (&quot;overlap test&quot; circuit)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">kernel</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
        <span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kcomplex128</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">hadamard</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">QTensor</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat64</span><span class="p">),</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
                <span class="n">crz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">QTensor</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat64</span><span class="p">),</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
                <span class="n">crz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">QTensor</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat64</span><span class="p">),</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span><span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">QTensor</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat64</span><span class="p">),</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hadamard</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">states_1</span> <span class="o">=</span> <span class="n">qm</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">states_1</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">states_1</span><span class="p">)</span>

        <span class="n">states_2</span> <span class="o">=</span> <span class="n">qm</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">states_1</span><span class="p">),</span> <span class="n">projector</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">states_2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>

    <span class="n">gram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">X_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_1</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_2</span><span class="p">)):</span>
            <span class="n">gram</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">(</span><span class="n">X_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">X_2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">gram</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vqnet_projected_quantum_kernel</span><span class="p">(</span><span class="n">X_1</span><span class="p">,</span> <span class="n">X_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">QTensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])):</span>

    <span class="k">if</span> <span class="n">X_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X_2</span> <span class="o">=</span> <span class="n">X_1</span>  <span class="c1"># Training Gram matrix</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">X_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">X_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">),</span> <span class="s2">&quot;The training and testing data must have the same dimensionality&quot;</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">projected_xyz_embedding</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Quantum Kernel given the template written in Pennylane framework</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Pennylane template for the quantum feature map</span>
<span class="sd">            X: feature data (matrix)</span>

<span class="sd">        Returns:</span>
<span class="sd">            projected quantum feature map X</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">proj_feature_map</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kcomplex128</span><span class="p">)</span>
            <span class="n">VQC_ZZFeatureMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">qm</span><span class="p">,</span> <span class="n">data_map_func</span><span class="o">=</span><span class="n">custom_data_map_func</span><span class="p">,</span> <span class="n">entanglement</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">expval</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PauliX</span><span class="p">())</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
                <span class="o">+</span> <span class="p">[</span><span class="n">expval</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PauliY</span><span class="p">())</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
                <span class="o">+</span> <span class="p">[</span><span class="n">expval</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PauliZ</span><span class="p">())</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
            <span class="p">)</span>

        <span class="c1"># build the gram matrix</span>
        <span class="n">X_proj</span> <span class="o">=</span> <span class="p">[</span><span class="n">proj_feature_map</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X_proj</span>
    <span class="n">X_1_proj</span> <span class="o">=</span> <span class="n">projected_xyz_embedding</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">X_1</span><span class="p">))</span>
    <span class="n">X_2_proj</span> <span class="o">=</span> <span class="n">projected_xyz_embedding</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">X_2</span><span class="p">))</span>

    <span class="c1"># print(X_1_proj)</span>
    <span class="c1"># print(X_2_proj)</span>
    <span class="c1"># build the gram matrix</span>

    <span class="n">gamma</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gram</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">X_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_1_proj</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_2_proj</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X_1_proj</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">X_2_proj</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">gamma</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="n">gram</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">gram</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculate_generalization_accuracy</span><span class="p">(</span>
    <span class="n">training_gram</span><span class="p">,</span> <span class="n">training_labels</span><span class="p">,</span> <span class="n">testing_gram</span><span class="p">,</span> <span class="n">testing_labels</span>
<span class="p">):</span>

    <span class="n">svm</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;precomputed&quot;</span><span class="p">)</span>
    <span class="n">svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training_gram</span><span class="p">,</span> <span class="n">training_labels</span><span class="p">)</span>

    <span class="n">y_predict</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">testing_gram</span><span class="p">)</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">testing_labels</span> <span class="o">==</span> <span class="n">y_predict</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">testing_labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accuracy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="n">qubits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">qubits</span><span class="p">:</span>
    <span class="n">n_qubits</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">x_tr</span><span class="p">,</span> <span class="n">x_te</span> <span class="p">,</span> <span class="n">y_tr</span> <span class="p">,</span> <span class="n">y_te</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">digits</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">digits</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>

    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_qubits</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_tr</span><span class="p">)</span>
    <span class="n">x_tr_reduced</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_tr</span><span class="p">)</span>
    <span class="n">x_te_reduced</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_te</span><span class="p">)</span>

    <span class="c1"># normalize and scale</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_tr_reduced</span><span class="p">)</span>
    <span class="n">x_tr_norm</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_tr_reduced</span><span class="p">)</span>
    <span class="n">x_te_norm</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_te_reduced</span><span class="p">)</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_tr_norm</span><span class="p">,</span> <span class="n">x_te_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">minmax</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">x_tr_norm</span> <span class="o">=</span> <span class="n">minmax</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_tr_norm</span><span class="p">)</span>
    <span class="n">x_te_norm</span> <span class="o">=</span> <span class="n">minmax</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_te_norm</span><span class="p">)</span>

    <span class="c1"># select only 100 training and 20 test data</span>

    <span class="n">tr_size</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">x_tr</span> <span class="o">=</span> <span class="n">x_tr_norm</span><span class="p">[:</span><span class="n">tr_size</span><span class="p">]</span>
    <span class="n">y_tr</span> <span class="o">=</span> <span class="n">y_tr</span><span class="p">[:</span><span class="n">tr_size</span><span class="p">]</span>

    <span class="n">te_size</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">x_te</span> <span class="o">=</span> <span class="n">x_te_norm</span><span class="p">[:</span><span class="n">te_size</span><span class="p">]</span>
    <span class="n">y_te</span> <span class="o">=</span> <span class="n">y_te</span><span class="p">[:</span><span class="n">te_size</span><span class="p">]</span>

    <span class="n">quantum_kernel_tr</span> <span class="o">=</span> <span class="n">vqnet_quantum_kernel</span><span class="p">(</span><span class="n">X_1</span><span class="o">=</span><span class="n">x_tr</span><span class="p">)</span>

    <span class="n">projected_kernel_tr</span> <span class="o">=</span> <span class="n">vqnet_projected_quantum_kernel</span><span class="p">(</span><span class="n">X_1</span><span class="o">=</span><span class="n">x_tr</span><span class="p">)</span>

    <span class="n">quantum_kernel_te</span> <span class="o">=</span> <span class="n">vqnet_quantum_kernel</span><span class="p">(</span><span class="n">X_1</span><span class="o">=</span><span class="n">x_te</span><span class="p">,</span> <span class="n">X_2</span><span class="o">=</span><span class="n">x_tr</span><span class="p">)</span>

    <span class="n">projected_kernel_te</span> <span class="o">=</span> <span class="n">vqnet_projected_quantum_kernel</span><span class="p">(</span><span class="n">X_1</span><span class="o">=</span><span class="n">x_te</span><span class="p">,</span> <span class="n">X_2</span><span class="o">=</span><span class="n">x_tr</span><span class="p">)</span>

    <span class="n">quantum_accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_generalization_accuracy</span><span class="p">(</span><span class="n">quantum_kernel_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">,</span> <span class="n">quantum_kernel_te</span><span class="p">,</span> <span class="n">y_te</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;qubits </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, quantum_accuracy </span><span class="si">{</span><span class="n">quantum_accuracy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">projected_accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_generalization_accuracy</span><span class="p">(</span><span class="n">projected_kernel_tr</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">y_tr</span><span class="p">,</span> <span class="n">projected_kernel_te</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">y_te</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;qubits </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, projected_accuracy </span><span class="si">{</span><span class="n">projected_accuracy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># train_size 100 test_size 20</span>
<span class="c1">#</span>
<span class="c1"># qubits 2, quantum_accuracy 1.0</span>
<span class="c1"># qubits 2, projected_accuracy 1.0</span>
<span class="c1"># qubits 4, quantum_accuracy 1.0</span>
<span class="c1"># qubits 4, projected_accuracy 1.0</span>
<span class="c1"># qubits 8, quantum_accuracy 0.45</span>
<span class="c1"># qubits 8, projected_accuracy 1.0</span>

<span class="c1"># train_size 100 test_size 100</span>
<span class="c1">#</span>
<span class="c1"># qubits 2, quantum_accuracy 1.0</span>
<span class="c1"># qubits 2, projected_accuracy 0.99</span>
<span class="c1"># qubits 4, quantum_accuracy 0.99</span>
<span class="c1"># qubits 4, projected_accuracy 0.98</span>
<span class="c1"># qubits 8, quantum_accuracy 0.51</span>
<span class="c1"># qubits 8, projected_accuracy 0.99</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2>基于小样本的量子卷积神经网络模型<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p>下面的例子使用2.0.8新加入的 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 下的变分线路接口,实现了论文 <a class="reference external" href="https://www.nature.com/articles/s41467-022-32550-3">Generalization in quantum machine learning from few training data</a> 中的用于小样本的量子卷积神经网络模型。用于探讨量子机器学习模型中的泛化功能。</p>
<p>为了在量子电路中构建卷积层和池化层,我们将遵循论文中提出的 QCNN 结构。前一层将提取局部相关性,而后者允许降低特征向量的维度。在量子电路中,卷积层由沿着整个图像扫描的内核组成,是一个与相邻量子位相关的两个量子位酉。
至于池化层,我们将使用取决于相邻量子位测量的条件单量子位酉。最后,我们使用一个密集层,使用全对全单一门来纠缠最终状态的所有量子位,如下图所示:</p>
<a class="reference internal image-reference" href="../_images/qcnn_structrue.png"><img alt="../_images/qcnn_structrue.png" class="align-center" src="../_images/qcnn_structrue.png" style="width: 500px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>参考这种量子卷积层的设计方式,我们基于IsingXX、IsingYY、IsingZZ三个量子逻辑门对量子线路进行了构建,如下图所示:</p>
<a class="reference internal image-reference" href="../_images/Qcnn_circuit.png"><img alt="../_images/Qcnn_circuit.png" class="align-center" src="../_images/Qcnn_circuit.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>其中输入数据为维度8*8的手写数字数据集,通过数据编码层,经过第一层卷积,由IsingXX、IsingYY、IsingZZ、U3构成,,随后经过一层池化层,在0、2、5位量子比特上再经过一层卷积和一层池化,最后再经过一层Random Unitary,其中由15个随机酉矩阵构成,对应经典的Dense Layer,测量结果为对手写数据为0和1的预测概率,具体代码实现如下:</p>
<p>以下代码运行需要额外安装 <cite>pandas</cite>, <cite>sklearn</cite>, <cite>seaborn</cite>。
考虑到耗时情况下面相关运行配置常数设置较小，用户可自行设置较大值。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc.qcircuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">isingxx</span><span class="p">,</span><span class="n">isingyy</span><span class="p">,</span><span class="n">isingzz</span><span class="p">,</span><span class="n">u3</span><span class="p">,</span><span class="n">cnot</span><span class="p">,</span><span class="n">VQC_AmplitudeEmbedding</span><span class="p">,</span><span class="n">rxx</span><span class="p">,</span><span class="n">ryy</span><span class="p">,</span><span class="n">rzz</span><span class="p">,</span><span class="n">rzx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc.qmachine</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">probs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="n">n_reps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">10</span>

<span class="k">def</span><span class="w"> </span><span class="nf">convolutional_layer</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">wires</span><span class="p">,</span> <span class="n">skip_first_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">n_wires</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wires</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n_wires</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;this circuit is too small!&quot;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wires</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">indx</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">indx</span> <span class="o">&lt;</span> <span class="n">n_wires</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">indx</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_first_layer</span><span class="p">:</span>

                    <span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">[</span><span class="n">indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>

                <span class="n">isingxx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span>  <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">wires</span><span class="p">[</span><span class="n">indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                <span class="n">isingyy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span>  <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">wires</span><span class="p">[</span><span class="n">indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                <span class="n">isingzz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span>  <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">wires</span><span class="p">[</span><span class="n">indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                <span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>
                <span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">[</span><span class="n">indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">12</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">qm</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pooling_layer</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">wires</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a pooling layer to a circuit.&quot;&quot;&quot;</span>
    <span class="n">n_wires</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wires</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wires</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;this circuit is too small!&quot;</span>
    <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wires</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">indx</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">indx</span> <span class="o">&lt;</span> <span class="n">n_wires</span><span class="p">:</span>
            <span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">wires</span><span class="p">[</span><span class="n">indx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">[</span><span class="n">indx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conv_and_pooling</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">kernel_weights</span><span class="p">,</span> <span class="n">n_wires</span><span class="p">,</span> <span class="n">skip_first_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply both the convolutional and pooling layer.&quot;&quot;&quot;</span>

    <span class="n">convolutional_layer</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">kernel_weights</span><span class="p">[:</span><span class="mi">15</span><span class="p">],</span> <span class="n">n_wires</span><span class="p">,</span> <span class="n">skip_first_layer</span><span class="o">=</span><span class="n">skip_first_layer</span><span class="p">)</span>
    <span class="n">pooling_layer</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">kernel_weights</span><span class="p">[</span><span class="mi">15</span><span class="p">:],</span> <span class="n">n_wires</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qm</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dense_layer</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">wires</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply an arbitrary unitary gate to a specified set of wires.&quot;&quot;&quot;</span>

    <span class="n">rzz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rxx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">ryy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rzx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rxx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rzx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rzz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">ryy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rzz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rxx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rzx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rzx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">rzz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">ryy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wires</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qm</span>


<span class="n">num_wires</span> <span class="o">=</span> <span class="mi">6</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conv_net</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">last_layer_weights</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>

    <span class="n">layers</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">wires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_wires</span><span class="p">))</span>

    <span class="n">VQC_AmplitudeEmbedding</span><span class="p">(</span><span class="n">input_feature</span> <span class="o">=</span> <span class="n">features</span><span class="p">,</span> <span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">)</span>

    <span class="c1"># adds convolutional and pooling layers</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
        <span class="n">conv_and_pooling</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">weights</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">wires</span><span class="p">,</span> <span class="n">skip_first_layer</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">wires</span> <span class="o">=</span> <span class="n">wires</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">last_layer_weights</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wires</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;The size of the last layer weights vector is incorrect!&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> Expected </span><span class="si">{</span><span class="mi">4</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wires</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, Given </span><span class="si">{</span><span class="n">last_layer_weights</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">dense_layer</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">last_layer_weights</span><span class="p">,</span> <span class="n">wires</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">probs</span><span class="p">(</span><span class="n">q_state</span><span class="o">=</span><span class="n">qm</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="n">num_wires</span><span class="o">=</span><span class="n">qm</span><span class="o">.</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_digits_data</span><span class="p">(</span><span class="n">num_train</span><span class="p">,</span> <span class="n">num_test</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return training and testing data of digits dataset.&quot;&quot;&quot;</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_digits</span><span class="p">()</span>
    <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">digits</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">digits</span><span class="o">.</span><span class="n">target</span>

    <span class="c1"># only use first two classes</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span>

    <span class="c1"># normalize data</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># subsample train and test split</span>
    <span class="n">train_indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">num_train</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">test_indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="n">train_indices</span><span class="p">),</span> <span class="n">num_test</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">train_indices</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">train_indices</span><span class="p">]</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">test_indices</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">test_indices</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Qcnn_ising</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Qcnn_ising</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">conv_net</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">num_wires</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kcomplex128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="mi">18</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights_last</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="mi">4</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_last</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_qcnn</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_test</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">):</span>

    <span class="c1"># load data</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_digits_data</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_test</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>

    <span class="c1"># init weights and optimizer</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Qcnn_ising</span><span class="p">()</span>

    <span class="n">opti</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># data containers</span>
    <span class="n">train_cost_epochs</span><span class="p">,</span> <span class="n">test_cost_epochs</span><span class="p">,</span> <span class="n">train_acc_epochs</span><span class="p">,</span> <span class="n">test_acc_epochs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>

        <span class="n">train_cost</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">tensor</span><span class="o">.</span><span class="n">sums</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">tensor</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)),</span> <span class="n">y_train</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
        <span class="c1"># print(f&quot;step {step}, train_cost {train_cost}&quot;)</span>

        <span class="n">train_cost</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">train_cost_epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_cost</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># compute accuracy on training data</span>

        <span class="c1"># print(tensor.sums(result[tensor.arange(0, len(y_train)), y_train] &gt; 0.5))</span>
        <span class="n">train_acc</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">sums</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">tensor</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)),</span> <span class="n">y_train</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(train_acc)</span>
        <span class="c1"># print(f&quot;step {step}, train_acc {train_acc}&quot;)</span>
        <span class="n">train_acc_epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_acc</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># compute accuracy and cost on testing data</span>
        <span class="n">test_out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">sums</span><span class="p">(</span><span class="n">test_out</span><span class="p">[</span><span class="n">tensor</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)),</span> <span class="n">y_test</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">test_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">test_acc_epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_acc</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">test_cost</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">tensor</span><span class="o">.</span><span class="n">sums</span><span class="p">(</span><span class="n">test_out</span><span class="p">[</span><span class="n">tensor</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)),</span> <span class="n">y_test</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>
        <span class="n">test_cost_epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_cost</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># print(f&quot;step {step}, test_cost {test_cost}&quot;)</span>
        <span class="c1"># print(f&quot;step {step}, test_acc {test_acc}&quot;)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">n_train</span><span class="o">=</span><span class="p">[</span><span class="n">n_train</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_epochs</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="n">train_cost</span><span class="o">=</span><span class="n">train_cost_epochs</span><span class="p">,</span>
        <span class="n">train_acc</span><span class="o">=</span><span class="n">train_acc_epochs</span><span class="p">,</span>
        <span class="n">test_cost</span><span class="o">=</span><span class="n">test_cost_epochs</span><span class="p">,</span>
        <span class="n">test_acc</span><span class="o">=</span><span class="n">test_acc_epochs</span><span class="p">,</span>
    <span class="p">)</span>



<span class="k">def</span><span class="w"> </span><span class="nf">run_iterations</span><span class="p">(</span><span class="n">n_train</span><span class="p">):</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train_acc&quot;</span><span class="p">,</span> <span class="s2">&quot;train_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;test_acc&quot;</span><span class="p">,</span> <span class="s2">&quot;test_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;n_train&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">train_qcnn</span><span class="p">(</span><span class="n">n_train</span><span class="o">=</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_test</span><span class="o">=</span><span class="n">n_test</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">)</span>

        <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">results_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">results</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">results_df</span>

<span class="c1"># run training for multiple sizes</span>
<span class="n">train_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">run_iterations</span><span class="p">(</span><span class="n">n_train</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="k">for</span> <span class="n">n_train</span> <span class="ow">in</span> <span class="n">train_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">results_df</span><span class="p">,</span> <span class="n">run_iterations</span><span class="p">(</span><span class="n">n_train</span><span class="o">=</span><span class="n">n_train</span><span class="p">)])</span>

<span class="n">save</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 保存数据</span>
<span class="n">draw</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 绘图</span>

<span class="k">if</span> <span class="n">save</span><span class="p">:</span>
    <span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;test_qcnn.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
    <span class="c1"># aggregate dataframe</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;test_qcnn.csv&#39;</span><span class="p">)</span>
    <span class="n">df_agg</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;n_train&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">])</span>
    <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">16.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">generalization_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># plot losses and accuracies</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n_train</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df_agg</span><span class="p">[</span><span class="n">df_agg</span><span class="o">.</span><span class="n">n_train</span> <span class="o">==</span> <span class="n">n_train</span><span class="p">]</span>

        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">train_cost</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">test_cost</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">train_acc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">test_acc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="s2">&quot;x--&quot;</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="s2">&quot;x--&quot;</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;$N=</span><span class="si">{</span><span class="n">n_train</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">fr</span><span class="s2">&quot;$N=</span><span class="si">{</span><span class="n">n_train</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">dfs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">markevery</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># plot final loss difference</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">test_cost</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">train_cost</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
        <span class="n">generalization_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span>

    <span class="c1"># format loss plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Train and Test Losses&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>

    <span class="c1"># format generalization error plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">generalization_errors</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$gen(\alpha)$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Generalization Error $gen(\alpha) = R(\alpha) - \hat</span><span class="si">{R}</span><span class="s1">_N(\alpha)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Training Set Size&#39;</span><span class="p">)</span>

    <span class="c1"># format loss plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Train and Test Accuracies&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>

    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">mpl</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;N=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">)</span>
                        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                            <span class="n">mpl</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Black&#39;</span><span class="p">),</span>
                            <span class="n">mpl</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Black&#39;</span><span class="p">)</span>
                        <span class="p">]</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>使用 <cite>n_reps = 100, n_test = 100, n_epochs = 100</cite> 配置运行后的实验结果如下图所示:</p>
<a class="reference internal image-reference" href="../_images/result_qcnn_small.png"><img alt="../_images/result_qcnn_small.png" class="align-center" src="../_images/result_qcnn_small.png" style="width: 1000px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="hqcnn">
<h2>混合量子经典神经网络的HQCNN示例<a class="headerlink" href="#hqcnn" title="Link to this heading">¶</a></h2>
<p>使用 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 实现了HQCNN示例,使用量子经典混合网络进行Mnist数据集上图像分类。量子部分,这里定义了一个1量子比特的简单量子线路,该线路将经典神经网络层的输出作为输入,通过 <code class="docutils literal notranslate"><span class="pre">H</span></code>, <code class="docutils literal notranslate"><span class="pre">RY</span></code> 逻辑门进行量子数据编码,并计算z方向的哈密顿期望值作为输出。</p>
<a class="reference internal image-reference" href="../_images/hqcnn_quantum_cir.png"><img alt="../_images/hqcnn_quantum_cir.png" class="align-center" src="../_images/hqcnn_quantum_cir.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>由于量子线路可以和经典神经网络一起进行自动微分的计算,因此我们可以使用VQNet的2维卷积层 <code class="docutils literal notranslate"><span class="pre">Conv2D</span></code> ,池化层 <code class="docutils literal notranslate"><span class="pre">MaxPool2D</span></code> ,全连接层 <code class="docutils literal notranslate"><span class="pre">Linear</span></code> 以及刚才构建的量子线路构建模型。
通过以下代码中继承于VQNet自动微分模块 <code class="docutils literal notranslate"><span class="pre">Module</span></code> 的 Net 以及 Hybrid 类的定义,以及模型前传函数 <code class="docutils literal notranslate"><span class="pre">forward()</span></code> 中对数据前向计算的定义,我们构建了一个可以自动微分的模型
将本例中MNIST的数据进行卷积,降维,量子编码,测量,获取分类任务所需的最终特征。</p>
<p>以下首先为神经网络相关代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.conv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conv2D</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">activation</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.pooling</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxPool2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span><span class="p">,</span><span class="n">QModule</span><span class="p">,</span><span class="n">hadamard</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span><span class="n">MeasureAll</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Hybird</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#this super(Hybird, self).__init__() is need</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Hybird</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Z0&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
        <span class="c1">#use only one qubit to create a qmachine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="c1">#this reset_states must be done to get real batch size.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hadamard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Net</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hybird Quantum Classci Neural Network Module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hybird</span> <span class="o">=</span> <span class="n">Hybird</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="n">start_time_forward</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybird</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>以下为数据载入,训练代码等:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download mnist data if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./examples&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load mnist data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>


<span class="k">def</span><span class="w"> </span><span class="nf">data_select</span><span class="p">(</span><span class="n">train_num</span><span class="p">,</span> <span class="n">test_num</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select data from mnist dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">)</span>  <span class="c1"># 下载训练数据</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">)</span>
    <span class="n">idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">])</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Test Leaving only labels 0 and 1</span>
    <span class="n">idx_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">])</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run mnist train function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_select</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>

    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">train_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">val_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_acc_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">val_acc_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_train</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">n_train</span> <span class="o">+=</span> <span class="n">batch_size</span>

            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>

        <span class="n">train_loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="n">train_acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_train</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">val_loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="n">val_acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_eval</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1 loss is : 0.6849292357</span>
<span class="sd">Eval Accuracy: 0.5</span>
<span class="sd">2 loss is : 0.4714432901</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">3 loss is : 0.2898814073</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">4 loss is : 0.1938255936</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">5 loss is : 0.1351640474</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">6 loss is : 0.0998594583</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">7 loss is : 0.0778947517</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">8 loss is : 0.0627411657</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">9 loss is : 0.0519049061</span>
<span class="sd">Eval Accuracy: 1.0</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2>量子重载入算法示例<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h2>
<p>以下使用 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 下的接口构建quantum data re-uploading算法示例。
在神经网络中,每一个神经元都接受来自上层所有神经元的信息(图a)。与之相对的,单比特量子分类器接受上一个的信息处理单元和输入(图b)。
通俗地来说,对于传统的量子线路来说,当数据上传完成,可以直接通过若干幺正变换 <span class="math notranslate nohighlight">\(U(\theta_1,\theta_2,\theta_3)\)</span> 直接得到结果。
但是在量子数据重上传(Quantum Data Re-upLoading,QDRL)任务中,数据在幺正变换之前需要进行重新上传操作。</p>
<blockquote>
<div><p class="centered">
<strong>QDRL与经典神经网络原理图对比</strong></p></div></blockquote>
<a class="reference internal image-reference" href="../_images/qdrl.png"><img alt="../_images/qdrl.png" class="align-center" src="../_images/qdrl.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>导入库以及定义量子神经网络模型:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span><span class="p">,</span><span class="n">QModule</span><span class="p">,</span><span class="n">rz</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span><span class="n">Probability</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">sgd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span> <span class="k">as</span> <span class="n">get_minibatch_data</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>



<span class="k">class</span><span class="w"> </span><span class="nc">vmodel</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nq</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">vmodel</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nq</span> <span class="o">=</span> <span class="n">nq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="mi">9</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">Probability</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">))</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">qm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qm</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>

        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]])</span>

        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]])</span>

        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]])</span>

        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="n">qm</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pqc</span> <span class="o">=</span> <span class="n">vmodel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pqc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>定义数据载入,模型训练的相关代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">circle</span><span class="p">(</span><span class="n">samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)):</span>
    <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">data_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">data_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_y</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">reds</span> <span class="o">=</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">blues</span> <span class="o">=</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$x_1$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$x_2$&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_score</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">pred</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">sgd</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function for train qdrl model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">circle</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x_train</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>  <span class="c1"># 500*3</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training...........&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">get_minibatch_data</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">loss_fun</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
            <span class="n">losss</span> <span class="o">=</span> <span class="n">loss_fun</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

            <span class="n">losss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">accuracy</span> <span class="o">+=</span> <span class="n">get_score</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="n">loss</span> <span class="o">+=</span> <span class="n">losss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, train_accuracy_for_each_batch:</span><span class="si">{</span><span class="n">accuracy</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, train_loss_for_each_batch:</span><span class="si">{</span><span class="n">loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">():</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start eval...................&quot;</span><span class="p">)</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">circle</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">test_accuracy</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x_test</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>

    <span class="k">for</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span> <span class="ow">in</span> <span class="n">get_minibatch_data</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                                    <span class="n">batch_size</span><span class="p">):</span>

        <span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">test_data</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">test_label</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="n">test_accuracy</span> <span class="o">+=</span> <span class="n">get_score</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">test_label</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test_accuracy:</span><span class="si">{</span><span class="n">test_accuracy</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">train</span><span class="p">()</span>
    <span class="n">test</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">start training...........</span>
<span class="sd">epoch:0, train_accuracy_for_each_batch:0.828</span>
<span class="sd">epoch:0, train_loss_for_each_batch:0.10570884662866592</span>
<span class="sd">epoch:1, train_accuracy_for_each_batch:0.866</span>
<span class="sd">epoch:1, train_loss_for_each_batch:0.09770179575681687</span>
<span class="sd">epoch:2, train_accuracy_for_each_batch:0.878</span>
<span class="sd">epoch:2, train_loss_for_each_batch:0.09732778465747834</span>
<span class="sd">epoch:3, train_accuracy_for_each_batch:0.86</span>
<span class="sd">epoch:3, train_loss_for_each_batch:0.09763735890388489</span>
<span class="sd">epoch:4, train_accuracy_for_each_batch:0.864</span>
<span class="sd">epoch:4, train_loss_for_each_batch:0.09772944855690002</span>
<span class="sd">epoch:5, train_accuracy_for_each_batch:0.848</span>
<span class="sd">epoch:5, train_loss_for_each_batch:0.098575089097023</span>
<span class="sd">epoch:6, train_accuracy_for_each_batch:0.878</span>
<span class="sd">epoch:6, train_loss_for_each_batch:0.09734477716684341</span>
<span class="sd">epoch:7, train_accuracy_for_each_batch:0.878</span>
<span class="sd">epoch:7, train_loss_for_each_batch:0.09644640237092972</span>
<span class="sd">epoch:8, train_accuracy_for_each_batch:0.864</span>
<span class="sd">epoch:8, train_loss_for_each_batch:0.09722568172216416</span>
<span class="sd">epoch:9, train_accuracy_for_each_batch:0.862</span>
<span class="sd">epoch:9, train_loss_for_each_batch:0.09842782151699066</span>
<span class="sd">start eval...................</span>
<span class="sd">test_accuracy:0.934</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="circuit-centric-quantum-classifiers">
<h2>Circuit-centric quantum classifiers算法示例<a class="headerlink" href="#circuit-centric-quantum-classifiers" title="Link to this heading">¶</a></h2>
<p>这个例子使用 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 实现了论文 <a class="reference external" href="https://arxiv.org/pdf/1804.00633.pdf">Circuit-centric quantum classifiers</a> 中可变量子线路进行二分类任务。
该例子用来判断一个二进制数是奇数还是偶数。通过将二进制数编码到量子比特上,通过优化线路中的可变参数,使得该线路z方向测量值可以指示该输入为奇数还是偶数。
变分量子线路通常定义一个子线路,这是一种基本的电路架构,可以通过重复层构建复杂变分电路。
我们的电路层由多个旋转逻辑门以及将每个量子位与其相邻的量子位纠缠在一起的 <code class="docutils literal notranslate"><span class="pre">CNOT</span></code> 逻辑门组成。
我们还需要一个线路将经典数据编码到量子态上,使得线路测量的输出与输入有关联。
本例中,我们把二进制输入编码到对应顺序的量子比特上。例如输入数据1101被编码到4个量子比特。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">sgd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="n">kfloat32</span><span class="p">,</span><span class="n">kint64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span><span class="p">,</span> <span class="n">RX</span><span class="p">,</span> <span class="n">RY</span><span class="p">,</span> <span class="n">CNOT</span><span class="p">,</span> <span class="n">PauliX</span><span class="p">,</span> <span class="n">qmatrix</span><span class="p">,</span> <span class="n">PauliZ</span><span class="p">,</span><span class="n">qmeasure</span><span class="p">,</span><span class="n">qcircuit</span><span class="p">,</span><span class="n">VQC_RotCircuit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span><span class="p">,</span> <span class="n">tensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QModel</span><span class="p">(</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_num_wires</span> <span class="o">=</span> <span class="n">num_wires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">initializer</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">quantum_uniform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnot</span> <span class="o">=</span> <span class="n">CNOT</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">,</span><span class="n">qm</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">CNOT</span><span class="p">(</span><span class="n">wires</span> <span class="o">=</span> <span class="p">[</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nqubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])(</span><span class="n">q_machine</span> <span class="o">=</span> <span class="n">qm</span><span class="p">)</span>
            <span class="n">CNOT</span><span class="p">(</span><span class="n">wires</span> <span class="o">=</span> <span class="p">[</span><span class="n">nqubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nqubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]])(</span><span class="n">q_machine</span> <span class="o">=</span> <span class="n">qm</span><span class="p">)</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">build_circult</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">,</span><span class="n">qm</span><span class="p">):</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">,</span><span class="n">qm</span><span class="p">):</span>
                <span class="n">VQC_RotCircuit</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">nqubits</span><span class="p">,</span><span class="n">weights_j</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">basisstate</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nqubits</span><span class="p">:</span>
                    <span class="n">qcircuit</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">xx</span><span class="p">[:,[</span><span class="n">i</span><span class="p">]])</span>
                    <span class="n">qcircuit</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">xx</span><span class="p">[:,[</span><span class="n">i</span><span class="p">]])</span>
                    <span class="n">qcircuit</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">xx</span><span class="p">[:,[</span><span class="n">i</span><span class="p">]])</span>

            <span class="n">basisstate</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">nqubits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

                <span class="n">weights_i</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)):</span>
                    <span class="n">weights_j</span> <span class="o">=</span> <span class="n">weights_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">qm</span><span class="p">)</span>
                <span class="n">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">,</span><span class="n">qm</span><span class="p">)</span>

        <span class="n">build_circult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qmeasure</span><span class="o">.</span><span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Z0&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
</pre></div>
</div>
<p>数据载入,模型训练流程的代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qvc_train_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">]</span>
<span class="n">qvc_test_data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dataloader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">random_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">data</span><span class="p">[</span><span class="n">random_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span>
                                            <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="p">[</span><span class="n">random_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                                <span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span> <span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vqc_get_data</span><span class="p">(</span><span class="n">dataset_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tranform data to valid form</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset_str</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_train_data</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_test_data</span><span class="p">)</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vqc_square_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">-</span> <span class="n">predictions</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run2</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main run function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex64</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">sgd</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="c1">#loss = CategoricalCrossEntropy()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">datas</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">vqc_get_data</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span>  <span class="o">=</span><span class="mi">0</span>
        <span class="n">accuary</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">(</span><span class="n">datas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kint64</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">loss_b</span> <span class="o">=</span> <span class="n">vqc_square_loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">loss_b</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss_b</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
            <span class="n">accuary</span> <span class="o">+=</span> <span class="n">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, #### loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> #####accuray:</span><span class="si">{</span><span class="n">accuary</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

<span class="n">run2</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">epoch:0, #### loss:0.07805998176336289 #####accuray:1.0</span>
<span class="sd">epoch:1, #### loss:0.07268960326910019 #####accuray:1.0</span>
<span class="sd">epoch:2, #### loss:0.06934810429811478 #####accuray:1.0</span>
<span class="sd">epoch:3, #### loss:0.06652230024337769 #####accuray:1.0</span>
<span class="sd">epoch:4, #### loss:0.06363258957862854 #####accuray:1.0</span>
<span class="sd">epoch:5, #### loss:0.0604777917265892 #####accuray:1.0</span>
<span class="sd">epoch:6, #### loss:0.05711844265460968 #####accuray:1.0</span>
<span class="sd">epoch:7, #### loss:0.053814482688903806 #####accuray:1.0</span>
<span class="sd">epoch:8, #### loss:0.05088095813989639 #####accuray:1.0</span>
<span class="sd">epoch:9, #### loss:0.04851257503032684 #####accuray:1.0</span>
<span class="sd">epoch:10, #### loss:0.04672074168920517 #####accuray:1.0</span>
<span class="sd">epoch:11, #### loss:0.04540069997310638 #####accuray:1.0</span>
<span class="sd">epoch:12, #### loss:0.04442296177148819 #####accuray:1.0</span>
<span class="sd">epoch:13, #### loss:0.04368099868297577 #####accuray:1.0</span>
<span class="sd">epoch:14, #### loss:0.04310029000043869 #####accuray:1.0</span>
<span class="sd">epoch:15, #### loss:0.04263183027505875 #####accuray:1.0</span>
<span class="sd">epoch:16, #### loss:0.04224379360675812 #####accuray:1.0</span>
<span class="sd">epoch:17, #### loss:0.041915199160575865 #####accuray:1.0</span>
<span class="sd">epoch:18, #### loss:0.04163179695606232 #####accuray:1.0</span>
<span class="sd">epoch:19, #### loss:0.041383542120456696 #####accuray:1.0</span>
<span class="sd">epoch:20, #### loss:0.0411631852388382 #####accuray:1.0</span>
<span class="sd">epoch:21, #### loss:0.04096531867980957 #####accuray:1.0</span>
<span class="sd">epoch:22, #### loss:0.04078584611415863 #####accuray:1.0</span>
<span class="sd">epoch:23, #### loss:0.0406215637922287 #####accuray:1.0</span>
<span class="sd">epoch:24, #### loss:0.040470016002655027 #####accuray:1.0</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="id8">
<h2>量子经典迁移学习的示例<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h2>
<p>可以将称为迁移学习的机器学习方法应用于基于混合经典量子网络的图像分类器。基于VQNet的 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 接口,我们实现以下代码示例。
迁移学习是一种成熟的人工神经网络训练技术,它基于一般直觉,即如果预训练的网络擅长解决给定的问题,那么,只需一些额外的训练,它也可以用来解决一个不同但相关的问题。
下面首先使用经典神经网络CNN训练一个分类模型,然后将部分层参数冻结,加入一个变分量子线路构成量子经典混合神经网络进行迁移学习模型训练。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.conv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conv2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.utils.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_parameters</span><span class="p">,</span> <span class="n">save_parameters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">activation</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.pooling</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxPool2D</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoftmaxCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.sgd</span><span class="w"> </span><span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">hadamard</span><span class="p">,</span><span class="n">QMachine</span><span class="p">,</span><span class="n">QModule</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span><span class="n">cnot</span><span class="p">,</span><span class="n">MeasureAll</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>

<span class="n">train_size</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">eval_size</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">EPOCHES</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Number of qubits</span>
<span class="n">q_depth</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Depth of the quantum circuit (number of variational layers)</span>




<span class="k">def</span><span class="w"> </span><span class="nf">q_h_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
        <span class="n">hadamard</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="c1"># to get shape of (batch,1) for ry</span>



<span class="k">def</span><span class="w"> </span><span class="nf">q_ry_embed_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">qubits</span><span class="p">):</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">param</span><span class="p">[:,[</span><span class="n">idx</span><span class="p">]])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">q_ry_param_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">qubits</span><span class="p">):</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">param</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">q_entangling_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">):</span>
    <span class="n">nqubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nqubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># Loop over even indices: i=0,2,...N-2</span>
        <span class="n">cnot</span><span class="p">(</span><span class="n">qm</span><span class="p">,[</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nqubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">):</span>  <span class="c1"># Loop over odd indices:  i=1,3,...N-3</span>
        <span class="n">cnot</span><span class="p">(</span><span class="n">qm</span><span class="p">,[</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vqc_quantum_net</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">q_input_features</span><span class="p">,</span> <span class="n">q_weights_flat</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">q_weights</span> <span class="o">=</span> <span class="n">q_weights_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">q_depth</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">])</span>
    <span class="n">q_h_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
    <span class="n">q_ry_embed_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">q_input_features</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q_depth</span><span class="p">):</span>
        <span class="n">q_entangling_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">)</span>
        <span class="n">q_ry_param_vqc</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">q_weights</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">qubits</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QNet</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nq</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QNet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nq</span> <span class="o">=</span><span class="n">nq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="n">q_depth</span> <span class="o">*</span> <span class="n">n_qubits</span><span class="p">,))</span>
        <span class="n">pauli_str_list</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">pauli_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pauli_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">pauli_str_list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="c1">#you have to expand states to input batchsize!</span>
        <span class="n">vqc_quantum_net</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
</pre></div>
</div>
<p>数据载入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span>
            <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;examples&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load mnist data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
<p>经典神经网络训练,使用 <code class="docutils literal notranslate"><span class="pre">SGD</span></code> 对全部神经网络参数进行训练30个批次,:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CNN</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classical CNN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu3</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relu4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool4</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">classcal_cnn_model_training</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load train data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropy</span><span class="p">()</span>

    <span class="n">epochs</span> <span class="o">=</span> <span class="n">EPOCHES</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">temp_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Forward pass</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># Calculating loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>  <span class="c1"># target output</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Backward pass</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># Optimize the weights</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>

        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">save_flag</span><span class="p">:</span>
            <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">save_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">)</span>
            <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp_loss</span> <span class="o">&gt;</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">save_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>量子迁移学习模型训练,将模型的 <cite>fc3</cite> 替换为 量子神经网络模块,使用 <code class="docutils literal notranslate"><span class="pre">Adam</span></code> 以0.005学习率微调:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">quantum_cnn_transferlearning</span><span class="p">():</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Q_DressedQuantumNet</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Definition of the *dressed* layout.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_net</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_net</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qlayer</span> <span class="o">=</span> <span class="n">QNet</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>

            <span class="c1"># obtain the input features for the quantum circuit</span>
            <span class="c1"># by reducing the feature dimension from 512 to 4</span>
            <span class="n">pre_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_net</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span>
            <span class="n">q_in</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">pre_out</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">q_out_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qlayer</span><span class="p">(</span><span class="n">q_in</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">q_out_elem</span>
            <span class="c1"># return the two-dimensional prediction from the postprocessing layer</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_net</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span>
                                <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">()</span>
    <span class="n">model_param</span> <span class="o">=</span> <span class="n">load_parameters</span><span class="p">(</span><span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_param</span><span class="p">)</span>

    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropy</span><span class="p">()</span>

    <span class="n">epochs</span> <span class="o">=</span> <span class="n">EPOCHES</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">eval_losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_hybrid</span> <span class="o">=</span> <span class="n">model</span>


    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_hybrid</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Q_DressedQuantumNet</span><span class="p">()</span>

    <span class="n">optimizer_hybrid</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">temp_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">optimizer_hybrid</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Forward pass</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model_hybrid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>  <span class="c1"># target output</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Backward pass</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># Optimize the weights</span>
            <span class="n">optimizer_hybrid</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>

        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">save_flag</span><span class="p">:</span>
            <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                            <span class="s2">&quot;./result/QCNN_TL_FC3.model&quot;</span><span class="p">)</span>
            <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                            <span class="s2">&quot;./result/QCNN_TL_ALL.model&quot;</span><span class="p">)</span>
            <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp_loss</span> <span class="o">&gt;</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                                <span class="s2">&quot;./result/QCNN_TL_FC3.model&quot;</span><span class="p">)</span>
                <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                                <span class="s2">&quot;./result/QCNN_TL_ALL.model&quot;</span><span class="p">)</span>

        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loss_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>
                                    <span class="n">y_test</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model_hybrid</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">np_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y1</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">loss_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np_loss</span><span class="p">)</span>
        <span class="n">eval_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_temp</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_eval</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> eval loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">eval_losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">):</span>
        <span class="n">classcal_cnn_model_training</span><span class="p">()</span>

    <span class="c1">#train quantum circuits.</span>
    <span class="n">quantum_cnn_transferlearning</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CNN 1 loss is : 2.3365595341</span>
<span class="sd">CNN 2 loss is : 2.3346040249</span>
<span class="sd">CNN 3 loss is : 2.3327281475</span>
<span class="sd">CNN 4 loss is : 2.3309340477</span>
<span class="sd">CNN 5 loss is : 2.3292131424</span>
<span class="sd">CNN 6 loss is : 2.3275604248</span>
<span class="sd">CNN 7 loss is : 2.3259737492</span>
<span class="sd">CNN 8 loss is : 2.3244516850</span>
<span class="sd">CNN 9 loss is : 2.3229918480</span>
<span class="sd">CNN Eval Accuracy: 0.56</span>
<span class="sd">QCNN 1 loss is : 2.3138980865</span>
<span class="sd">QCNN 1 eval loss is : 2.3130946350</span>
<span class="sd">QCNN 2 loss is : 2.3082799911</span>
<span class="sd">QCNN 2 eval loss is : 2.3063821411</span>
<span class="sd">QCNN 3 loss is : 2.3051402569</span>
<span class="sd">QCNN 3 eval loss is : 2.3004246521</span>
<span class="sd">QCNN 4 loss is : 2.3029096127</span>
<span class="sd">QCNN 4 eval loss is : 2.2958245850</span>
<span class="sd">QCNN 5 loss is : 2.3011913300</span>
<span class="sd">QCNN 5 eval loss is : 2.2928590393</span>
<span class="sd">QCNN 6 loss is : 2.2995581627</span>
<span class="sd">QCNN 6 eval loss is : 2.2891053772</span>
<span class="sd">QCNN 7 loss is : 2.2987136841</span>
<span class="sd">QCNN 7 eval loss is : 2.2853169250</span>
<span class="sd">QCNN 8 loss is : 2.2977037430</span>
<span class="sd">QCNN 8 eval loss is : 2.2839303589</span>
<span class="sd">QCNN 9 loss is : 2.2968051434</span>
<span class="sd">QCNN 9 eval loss is : 2.2818415833</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="variational-shadow-quantum-learning-for-classification">
<h2>Variational Shadow Quantum Learning for Classification模型示例<a class="headerlink" href="#variational-shadow-quantum-learning-for-classification" title="Link to this heading">¶</a></h2>
<p>使用 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 的可变量子线路接口构建2分类模型,在与相似参数精度的神经网络对比分类精度,两者精度相近。而量子线路的参数量远小于经典神经网络。
算法基于论文:<a class="reference external" href="https://arxiv.org/abs/2012.08288">Variational Shadow Quantum Learning for Classification Model</a>  复现。</p>
<p>VSQL量子整体模型如下:</p>
<a class="reference internal image-reference" href="../_images/vsql_model.PNG"><img alt="../_images/vsql_model.PNG" class="align-center" src="../_images/vsql_model.PNG" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>定义变分量子线路模型:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">AmplitudeEmbeddingCircuit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">rx</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span><span class="n">cnot</span><span class="p">,</span><span class="n">vqc_amplitude_embedding</span><span class="p">,</span><span class="n">QMachine</span><span class="p">,</span><span class="n">QModule</span><span class="p">,</span><span class="n">MeasureAll</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>



<span class="k">class</span><span class="w"> </span><span class="nc">VQC_VSQL</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nq</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VQC_VSQL</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nq</span> <span class="o">=</span><span class="n">nq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span> <span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_qsc</span><span class="p">,))</span>
        <span class="n">pauli_str_list</span> <span class="o">=</span><span class="p">[]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_pauli_str</span><span class="p">(</span><span class="n">n_start</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">):</span>
            <span class="n">D</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">D</span><span class="p">[</span><span class="s1">&#39;wires&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_start</span><span class="p">,</span> <span class="n">n_start</span> <span class="o">+</span> <span class="n">n_qsc</span><span class="p">)]</span>
            <span class="n">D</span><span class="p">[</span><span class="s2">&quot;observables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_start</span><span class="p">,</span> <span class="n">n_start</span> <span class="o">+</span> <span class="n">n_qsc</span><span class="p">)]</span>
            <span class="n">D</span><span class="p">[</span><span class="s2">&quot;coefficient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_start</span><span class="p">,</span> <span class="n">n_start</span> <span class="o">+</span> <span class="n">n_qsc</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">D</span>
        <span class="c1">#this reset states to shape of batchsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">subcir</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">qlist</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">,</span> <span class="n">n_start</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qsc</span><span class="p">):</span>
                <span class="n">rx</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">rx</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qsc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">cnot</span><span class="p">(</span><span class="n">qm</span><span class="p">,[</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>

                <span class="ow">not</span><span class="p">(</span><span class="n">qm</span><span class="p">,[</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">n_qsc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span><span class="p">]])</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qsc</span><span class="p">):</span>
                    <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">repeat</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>


        <span class="n">qm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qm</span>
        <span class="n">vqc_amplitude_embedding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">f_i</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">n_qsc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">psd</span> <span class="o">=</span> <span class="n">get_pauli_str</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">)</span>
            <span class="n">subcir</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">),</span> <span class="n">depth</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>

            <span class="n">ma</span> <span class="o">=</span><span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">psd</span><span class="p">)</span>
            <span class="n">f_ij</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">qm</span><span class="p">)</span>
            <span class="n">f_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_ij</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tensor</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">f_i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="c1">#-&gt;(Batch,n - n_qsc + 1)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model of VSQL</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vq</span> <span class="o">=</span> <span class="n">VQC_VSQL</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">n_qsc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vq</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>定义数据载入以及训练流程代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">}</span>


<span class="c1">#GLOBAL VAR</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_qsc</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download function for mnist dataset file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span>
            <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;examples&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load mnist data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>


<span class="k">def</span><span class="w"> </span><span class="nf">show_image</span><span class="p">():</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">img</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_vsql</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    VQSL MODEL</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="p">)</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="n">x_train_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_test_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">x_train_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">240</span><span class="p">),</span>
                <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_train_list</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">x_test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">240</span><span class="p">),</span>
                <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_test_list</span><span class="p">)</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model start&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">result_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./result/vqslrlt.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>

        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">cceloss</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">cceloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

            <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">n_loss</span> <span class="o">+=</span> <span class="n">batch_size</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; n_loss </span><span class="si">{</span><span class="n">n_loss</span><span class="si">}</span><span class="s2"> Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Evaluation</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>
                                <span class="n">y_test</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">cceloss</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">cceloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">n_loss</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">result_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">model</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">done vqsl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">run_vsql</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">model start</span>
<span class="sd">n_loss 5 Train Accuracy: 0.4</span>
<span class="sd">n_loss 10 Train Accuracy: 0.4</span>
<span class="sd">n_loss 15 Train Accuracy: 0.4</span>
<span class="sd">n_loss 20 Train Accuracy: 0.35</span>
<span class="sd">n_loss 25 Train Accuracy: 0.44</span>
<span class="sd">n_loss 30 Train Accuracy: 0.43333333333333335</span>
<span class="sd">n_loss 35 Train Accuracy: 0.4857142857142857</span>
<span class="sd">n_loss 40 Train Accuracy: 0.525</span>
<span class="sd">n_loss 45 Train Accuracy: 0.5777777777777777</span>
<span class="sd">n_loss 50 Train Accuracy: 0.58</span>
<span class="sd">n_loss 55 Train Accuracy: 0.5818181818181818</span>
<span class="sd">n_loss 60 Train Accuracy: 0.5833333333333334</span>
<span class="sd">n_loss 65 Train Accuracy: 0.5692307692307692</span>
<span class="sd">n_loss 70 Train Accuracy: 0.5714285714285714</span>
<span class="sd">n_loss 75 Train Accuracy: 0.5733333333333334</span>
<span class="sd">n_loss 80 Train Accuracy: 0.6</span>
<span class="sd">n_loss 85 Train Accuracy: 0.611764705882353</span>
<span class="sd">n_loss 90 Train Accuracy: 0.6111111111111112</span>
<span class="sd">n_loss 95 Train Accuracy: 0.631578947368421</span>
<span class="sd">n_loss 100 Train Accuracy: 0.63</span>
<span class="sd">n_loss 105 Train Accuracy: 0.638095238095238</span>
<span class="sd">n_loss 110 Train Accuracy: 0.6545454545454545</span>
<span class="sd">n_loss 115 Train Accuracy: 0.6434782608695652</span>
<span class="sd">n_loss 120 Train Accuracy: 0.65</span>
<span class="sd">n_loss 125 Train Accuracy: 0.664</span>
<span class="sd">n_loss 130 Train Accuracy: 0.6692307692307692</span>
<span class="sd">n_loss 135 Train Accuracy: 0.674074074074074</span>
<span class="sd">n_loss 140 Train Accuracy: 0.6857142857142857</span>
<span class="sd">n_loss 145 Train Accuracy: 0.6827586206896552</span>
<span class="sd">n_loss 150 Train Accuracy: 0.6933333333333334</span>
<span class="sd">n_loss 155 Train Accuracy: 0.6967741935483871</span>
<span class="sd">n_loss 160 Train Accuracy: 0.7</span>
<span class="sd">n_loss 165 Train Accuracy: 0.696969696969697</span>
<span class="sd">n_loss 170 Train Accuracy: 0.7058823529411765</span>
<span class="sd">n_loss 175 Train Accuracy: 0.7142857142857143</span>
<span class="sd">n_loss 180 Train Accuracy: 0.7222222222222222</span>
<span class="sd">n_loss 185 Train Accuracy: 0.7297297297297297</span>
<span class="sd">n_loss 190 Train Accuracy: 0.7368421052631579</span>
<span class="sd">n_loss 195 Train Accuracy: 0.7435897435897436</span>
<span class="sd">n_loss 200 Train Accuracy: 0.74</span>
<span class="sd">n_loss 205 Train Accuracy: 0.7463414634146341</span>
<span class="sd">n_loss 210 Train Accuracy: 0.7476190476190476</span>
<span class="sd">n_loss 215 Train Accuracy: 0.7488372093023256</span>
<span class="sd">n_loss 220 Train Accuracy: 0.7545454545454545</span>
<span class="sd">n_loss 225 Train Accuracy: 0.76</span>
<span class="sd">n_loss 230 Train Accuracy: 0.7565217391304347</span>
<span class="sd">n_loss 235 Train Accuracy: 0.7617021276595745</span>
<span class="sd">n_loss 240 Train Accuracy: 0.7666666666666667</span>
<span class="sd">n_loss 245 Train Accuracy: 0.7714285714285715</span>
<span class="sd">n_loss 250 Train Accuracy: 0.776</span>
<span class="sd">n_loss 255 Train Accuracy: 0.7803921568627451</span>
<span class="sd">n_loss 260 Train Accuracy: 0.7846153846153846</span>
<span class="sd">n_loss 265 Train Accuracy: 0.7849056603773585</span>
<span class="sd">n_loss 270 Train Accuracy: 0.7888888888888889</span>
<span class="sd">n_loss 275 Train Accuracy: 0.7927272727272727</span>
<span class="sd">n_loss 280 Train Accuracy: 0.7892857142857143</span>
<span class="sd">n_loss 285 Train Accuracy: 0.7929824561403509</span>
<span class="sd">n_loss 290 Train Accuracy: 0.7965517241379311</span>
<span class="sd">n_loss 295 Train Accuracy: 0.8</span>
<span class="sd">n_loss 300 Train Accuracy: 0.8</span>
<span class="sd">n_loss 305 Train Accuracy: 0.8032786885245902</span>
<span class="sd">n_loss 310 Train Accuracy: 0.8064516129032258</span>
<span class="sd">n_loss 315 Train Accuracy: 0.8095238095238095</span>
<span class="sd">n_loss 320 Train Accuracy: 0.8125</span>
<span class="sd">n_loss 325 Train Accuracy: 0.8153846153846154</span>
<span class="sd">n_loss 330 Train Accuracy: 0.8181818181818182</span>
<span class="sd">n_loss 335 Train Accuracy: 0.8208955223880597</span>
<span class="sd">n_loss 340 Train Accuracy: 0.8235294117647058</span>
<span class="sd">n_loss 345 Train Accuracy: 0.8260869565217391</span>
<span class="sd">n_loss 350 Train Accuracy: 0.8285714285714286</span>
<span class="sd">n_loss 355 Train Accuracy: 0.8309859154929577</span>
<span class="sd">n_loss 360 Train Accuracy: 0.8277777777777777</span>
<span class="sd">n_loss 365 Train Accuracy: 0.8301369863013699</span>
<span class="sd">n_loss 370 Train Accuracy: 0.8324324324324325</span>
<span class="sd">n_loss 375 Train Accuracy: 0.8346666666666667</span>
<span class="sd">n_loss 380 Train Accuracy: 0.8368421052631579</span>
<span class="sd">n_loss 385 Train Accuracy: 0.8389610389610389</span>
<span class="sd">n_loss 390 Train Accuracy: 0.841025641025641</span>
<span class="sd">n_loss 395 Train Accuracy: 0.8430379746835444</span>
<span class="sd">n_loss 400 Train Accuracy: 0.845</span>
<span class="sd">n_loss 405 Train Accuracy: 0.8469135802469135</span>
<span class="sd">n_loss 410 Train Accuracy: 0.848780487804878</span>
<span class="sd">n_loss 415 Train Accuracy: 0.8506024096385543</span>
<span class="sd">n_loss 420 Train Accuracy: 0.8523809523809524</span>
<span class="sd">n_loss 425 Train Accuracy: 0.8541176470588235</span>
<span class="sd">n_loss 430 Train Accuracy: 0.8558139534883721</span>
<span class="sd">n_loss 435 Train Accuracy: 0.8574712643678161</span>
<span class="sd">n_loss 440 Train Accuracy: 0.8590909090909091</span>
<span class="sd">n_loss 445 Train Accuracy: 0.8606741573033708</span>
<span class="sd">n_loss 450 Train Accuracy: 0.8622222222222222</span>
<span class="sd">n_loss 455 Train Accuracy: 0.8637362637362638</span>
<span class="sd">n_loss 460 Train Accuracy: 0.8652173913043478</span>
<span class="sd">n_loss 465 Train Accuracy: 0.864516129032258</span>
<span class="sd">n_loss 470 Train Accuracy: 0.8659574468085106</span>
<span class="sd">n_loss 475 Train Accuracy: 0.8673684210526316</span>
<span class="sd">n_loss 480 Train Accuracy: 0.8666666666666667</span>
<span class="sd">n_loss 485 Train Accuracy: 0.8680412371134021</span>
<span class="sd">n_loss 490 Train Accuracy: 0.8673469387755102</span>
<span class="sd">n_loss 495 Train Accuracy: 0.8686868686868687</span>
<span class="sd">n_loss 500 Train Accuracy: 0.87</span>
<span class="sd">Train Accuracy: 0.87</span>
<span class="sd">Epoch: 1, Loss: 0.0713323565647006</span>
<span class="sd">eval</span>
<span class="sd">Eval Accuracy: 0.95</span>
<span class="sd">n_loss 5 Train Accuracy: 1.0</span>
<span class="sd">n_loss 10 Train Accuracy: 1.0</span>
<span class="sd">n_loss 15 Train Accuracy: 1.0</span>
<span class="sd">n_loss 20 Train Accuracy: 1.0</span>
<span class="sd">n_loss 25 Train Accuracy: 1.0</span>
<span class="sd">n_loss 30 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 35 Train Accuracy: 0.9428571428571428</span>
<span class="sd">n_loss 40 Train Accuracy: 0.925</span>
<span class="sd">n_loss 45 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 50 Train Accuracy: 0.92</span>
<span class="sd">n_loss 55 Train Accuracy: 0.9272727272727272</span>
<span class="sd">n_loss 60 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 65 Train Accuracy: 0.9230769230769231</span>
<span class="sd">n_loss 70 Train Accuracy: 0.9285714285714286</span>
<span class="sd">n_loss 75 Train Accuracy: 0.9066666666666666</span>
<span class="sd">n_loss 80 Train Accuracy: 0.9</span>
<span class="sd">n_loss 85 Train Accuracy: 0.9058823529411765</span>
<span class="sd">n_loss 90 Train Accuracy: 0.9111111111111111</span>
<span class="sd">n_loss 95 Train Accuracy: 0.9157894736842105</span>
<span class="sd">n_loss 100 Train Accuracy: 0.92</span>
<span class="sd">n_loss 105 Train Accuracy: 0.9238095238095239</span>
<span class="sd">n_loss 110 Train Accuracy: 0.9272727272727272</span>
<span class="sd">n_loss 115 Train Accuracy: 0.9304347826086956</span>
<span class="sd">n_loss 120 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 125 Train Accuracy: 0.936</span>
<span class="sd">n_loss 130 Train Accuracy: 0.9307692307692308</span>
<span class="sd">n_loss 135 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 140 Train Accuracy: 0.9285714285714286</span>
<span class="sd">n_loss 145 Train Accuracy: 0.9310344827586207</span>
<span class="sd">n_loss 150 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 155 Train Accuracy: 0.9354838709677419</span>
<span class="sd">n_loss 160 Train Accuracy: 0.9375</span>
<span class="sd">n_loss 165 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 170 Train Accuracy: 0.9352941176470588</span>
<span class="sd">n_loss 175 Train Accuracy: 0.9371428571428572</span>
<span class="sd">n_loss 180 Train Accuracy: 0.9388888888888889</span>
<span class="sd">n_loss 185 Train Accuracy: 0.9405405405405406</span>
<span class="sd">n_loss 190 Train Accuracy: 0.9421052631578948</span>
<span class="sd">n_loss 195 Train Accuracy: 0.9435897435897436</span>
<span class="sd">n_loss 200 Train Accuracy: 0.935</span>
<span class="sd">n_loss 205 Train Accuracy: 0.9317073170731708</span>
<span class="sd">n_loss 210 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 215 Train Accuracy: 0.9348837209302325</span>
<span class="sd">n_loss 220 Train Accuracy: 0.9272727272727272</span>
<span class="sd">n_loss 225 Train Accuracy: 0.9244444444444444</span>
<span class="sd">n_loss 230 Train Accuracy: 0.9217391304347826</span>
<span class="sd">n_loss 235 Train Accuracy: 0.9234042553191489</span>
<span class="sd">n_loss 240 Train Accuracy: 0.925</span>
<span class="sd">n_loss 245 Train Accuracy: 0.926530612244898</span>
<span class="sd">n_loss 250 Train Accuracy: 0.928</span>
<span class="sd">n_loss 255 Train Accuracy: 0.9294117647058824</span>
<span class="sd">n_loss 260 Train Accuracy: 0.926923076923077</span>
<span class="sd">n_loss 265 Train Accuracy: 0.9283018867924528</span>
<span class="sd">n_loss 270 Train Accuracy: 0.9222222222222223</span>
<span class="sd">n_loss 275 Train Accuracy: 0.9236363636363636</span>
<span class="sd">n_loss 280 Train Accuracy: 0.925</span>
<span class="sd">n_loss 285 Train Accuracy: 0.9263157894736842</span>
<span class="sd">n_loss 290 Train Accuracy: 0.9206896551724137</span>
<span class="sd">n_loss 295 Train Accuracy: 0.9220338983050848</span>
<span class="sd">n_loss 300 Train Accuracy: 0.9233333333333333</span>
<span class="sd">n_loss 305 Train Accuracy: 0.9245901639344263</span>
<span class="sd">n_loss 310 Train Accuracy: 0.9258064516129032</span>
<span class="sd">n_loss 315 Train Accuracy: 0.926984126984127</span>
<span class="sd">n_loss 320 Train Accuracy: 0.928125</span>
<span class="sd">n_loss 325 Train Accuracy: 0.9292307692307692</span>
<span class="sd">n_loss 330 Train Accuracy: 0.9303030303030303</span>
<span class="sd">n_loss 335 Train Accuracy: 0.9313432835820895</span>
<span class="sd">n_loss 340 Train Accuracy: 0.9323529411764706</span>
<span class="sd">n_loss 345 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 350 Train Accuracy: 0.9342857142857143</span>
<span class="sd">n_loss 355 Train Accuracy: 0.9352112676056338</span>
<span class="sd">n_loss 360 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 365 Train Accuracy: 0.9315068493150684</span>
<span class="sd">n_loss 370 Train Accuracy: 0.9324324324324325</span>
<span class="sd">n_loss 375 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 380 Train Accuracy: 0.9315789473684211</span>
<span class="sd">n_loss 385 Train Accuracy: 0.9324675324675324</span>
<span class="sd">n_loss 390 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 395 Train Accuracy: 0.9316455696202531</span>
<span class="sd">n_loss 400 Train Accuracy: 0.9325</span>
<span class="sd">n_loss 405 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 410 Train Accuracy: 0.9317073170731708</span>
<span class="sd">n_loss 415 Train Accuracy: 0.9325301204819277</span>
<span class="sd">n_loss 420 Train Accuracy: 0.9333333333333333</span>
<span class="sd">n_loss 425 Train Accuracy: 0.9341176470588235</span>
<span class="sd">n_loss 430 Train Accuracy: 0.9348837209302325</span>
<span class="sd">n_loss 435 Train Accuracy: 0.9356321839080459</span>
<span class="sd">n_loss 440 Train Accuracy: 0.9363636363636364</span>
<span class="sd">n_loss 445 Train Accuracy: 0.9348314606741573</span>
<span class="sd">n_loss 450 Train Accuracy: 0.9355555555555556</span>
<span class="sd">n_loss 455 Train Accuracy: 0.9362637362637363</span>
<span class="sd">n_loss 460 Train Accuracy: 0.9369565217391305</span>
<span class="sd">n_loss 465 Train Accuracy: 0.9376344086021505</span>
<span class="sd">n_loss 470 Train Accuracy: 0.9382978723404255</span>
<span class="sd">n_loss 475 Train Accuracy: 0.9368421052631579</span>
<span class="sd">n_loss 480 Train Accuracy: 0.9375</span>
<span class="sd">n_loss 485 Train Accuracy: 0.9381443298969072</span>
<span class="sd">n_loss 490 Train Accuracy: 0.936734693877551</span>
<span class="sd">n_loss 495 Train Accuracy: 0.9373737373737374</span>
<span class="sd">n_loss 500 Train Accuracy: 0.938</span>
<span class="sd">Train Accuracy: 0.938</span>
<span class="sd">Epoch: 2, Loss: 0.036427834063768386</span>
<span class="sd">eval</span>
<span class="sd">Eval Accuracy: 0.95</span>

<span class="sd">done vqsl</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="qmlp">
<h2>QMLP模型示例<a class="headerlink" href="#qmlp" title="Link to this heading">¶</a></h2>
<p>以下代码实现了一种量子多层感知器 (QMLP) 架构,其特点是具有容错输入嵌入、丰富的非线性和带有参数化双量子比特纠缠门的增强变分电路模拟。<a class="reference external" href="https://arxiv.org/pdf/2206.01345.pdf">QMLP: An Error-Tolerant Nonlinear Quantum MLP Architecture using Parameterized Two-Qubit Gates</a> 。</p>
<p>以下代码实现变分量子线路:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeanSquaredError</span><span class="p">,</span> <span class="n">CrossEntropyLoss</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.pooling</span><span class="w"> </span><span class="kn">import</span> <span class="n">AvgPool2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span><span class="p">,</span><span class="n">QModule</span><span class="p">,</span><span class="n">rot</span><span class="p">,</span> <span class="n">crx</span><span class="p">,</span><span class="n">rx</span><span class="p">,</span><span class="n">MeasureAll</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>



<span class="k">def</span><span class="w"> </span><span class="nf">vqc_rot_cir</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">qubits</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">rot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vqc_crot_cir</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">qubits</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">crx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">qubits</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)]],</span> <span class="n">params</span><span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>


<span class="k">class</span><span class="w"> </span><span class="nc">build_qmlp_vqc</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nq</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">build_qmlp_vqc</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">nq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nq</span> <span class="o">=</span><span class="n">nq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span><span class="n">Parameter</span><span class="p">((</span><span class="n">nq</span><span class="o">*</span><span class="mi">8</span><span class="p">,))</span>
        <span class="n">pauli_str_list</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nq</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">pauli_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pauli_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">pauli_str_list</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">num_qubits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nq</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
            <span class="n">rx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">[:,[</span><span class="n">i</span><span class="p">]])</span><span class="c1"># use[:,i] will get shape of (batch),which is not valid for rx gates.</span>
        <span class="n">vqc_rot_cir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_qubits</span><span class="o">*</span><span class="mi">3</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">))</span>
        <span class="n">vqc_crot_cir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">num_qubits</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="n">num_qubits</span><span class="o">*</span><span class="mi">4</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
            <span class="n">rx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">[:,[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">vqc_rot_cir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">num_qubits</span><span class="o">*</span><span class="mi">4</span><span class="p">:</span><span class="n">num_qubits</span><span class="o">*</span><span class="mi">7</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">))</span>
        <span class="n">vqc_crot_cir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">num_qubits</span><span class="o">*</span><span class="mi">7</span><span class="p">:</span><span class="n">num_qubits</span><span class="o">*</span><span class="mi">8</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nq</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">QMLPModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QMLPModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ave_pool2d</span> <span class="o">=</span> <span class="n">AvgPool2D</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span> <span class="o">=</span> <span class="n">build_qmlp_vqc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">bsz</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ave_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">bsz</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
        <span class="n">quanutum_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">quanutum_result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>以下代码为训练数据载入以及训练流程代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download mnist data if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;examples&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load mnist data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_select</span><span class="p">(</span><span class="n">train_num</span><span class="p">,</span> <span class="n">test_num</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select data from mnist dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">)</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">)</span>
    <span class="n">idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">])</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Test Leaving only labels 0 and 1</span>
    <span class="n">idx_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">])</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span>



<span class="k">def</span><span class="w"> </span><span class="nf">vqnet_test_QMLPModel</span><span class="p">():</span>

    <span class="n">train_size</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">eval_size</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">QMLPModel</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_train</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Forward pass</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># Calculating loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loss: &quot;</span><span class="p">,</span> <span class="n">loss_np</span><span class="p">)</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">temp_out</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">temp_out</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">temp_output</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">temp_out</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">temp_out</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">temp_maks</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_output</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span>

            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp_maks</span><span class="p">))</span>
            <span class="n">n_train</span> <span class="o">+=</span> <span class="mi">160</span>

            <span class="c1"># Backward pass</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># Optimize the weights</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;##########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="c1"># train_acc_list.append(correct / n_train)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch: &quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="c1"># print(100. * (epoch + 1) / epochs)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">vqnet_test_QMLPModel</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8111111111111111</span>
<span class="sd">epoch:  1</span>
<span class="sd">1 loss is : 1.5855706836</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  2</span>
<span class="sd">2 loss is : 0.5768806215</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  3</span>
<span class="sd">3 loss is : 0.3712821839</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  4</span>
<span class="sd">4 loss is : 0.3419296628</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  5</span>
<span class="sd">5 loss is : 0.3328191666</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  6</span>
<span class="sd">6 loss is : 0.3280464354</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  7</span>
<span class="sd">7 loss is : 0.3252888937</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  8</span>
<span class="sd">8 loss is : 0.3235242934</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  9</span>
<span class="sd">9 loss is : 0.3226686205</span>
<span class="sd">##########################</span>
<span class="sd">Train Accuracy: 0.8128968253968254</span>
<span class="sd">epoch:  10</span>
<span class="sd">10 loss is : 0.3220652020</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="id9">
<h2>使用量子经典混合神经网络模型实现一种强化学习算法的示例<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h2>
<p>载入必要库,定义全局变量,其中 <cite>pygame==2.1.3,gym==0.23.0</cite> 。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gym</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">animation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span><span class="p">,</span><span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeanSquaredError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span><span class="p">,</span><span class="n">QTensor</span><span class="p">,</span><span class="n">kfloat32</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">u3</span><span class="p">,</span><span class="n">cnot</span><span class="p">,</span><span class="n">rx</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span><span class="n">rz</span><span class="p">,</span>\
    <span class="n">QMachine</span><span class="p">,</span><span class="n">QModule</span><span class="p">,</span><span class="n">MeasureAll</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">display_frames_as_gif</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">c_index</span><span class="p">):</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">(),</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">name_result</span> <span class="o">=</span> <span class="s2">&quot;./result_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c_index</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.gif&quot;</span>
    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name_result</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">CIRCUIT_SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">MAX_STEPS</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">BATCHSIZE</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">TARGET_MAX</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">GAMMA</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">STATE_T</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ACTION</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">REWARD</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">STATE_NT</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">DONE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_qubits</span><span class="o">=</span> <span class="mi">4</span>
<span class="n">n_layers</span><span class="o">=</span><span class="mi">2</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;FrozenLake-v1&quot;</span><span class="p">,</span> <span class="n">is_slippery</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">map_name</span> <span class="o">=</span> <span class="s1">&#39;4x4&#39;</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="n">targ_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sampled_vs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">memory</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_layers</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
</pre></div>
</div>
<p>量子神经网络模型定义代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">layer_circuit</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>

    <span class="c1"># Entanglement block</span>
    <span class="n">cnot</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="p">[</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">cnot</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="p">[</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">cnot</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="p">[</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>

    <span class="c1"># u3 gate</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>

        <span class="n">u3</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">encoder</span><span class="p">(</span><span class="n">encodings</span><span class="p">):</span>
    <span class="n">encodings</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">encodings</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">encodings</span><span class="si">:</span><span class="s1">0</span><span class="si">{</span><span class="n">CIRCUIT_SIZE</span><span class="si">}</span><span class="s1">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QDRL_MODULE</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_qubits</span><span class="p">,</span><span class="n">n_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span> <span class="o">=</span> <span class="n">num_qubits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="n">n_layers</span><span class="p">,</span><span class="n">num_qubits</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">pauli_str_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">pauli_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pauli_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">pauli_str_list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="n">qubits</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">)</span>
        <span class="n">all_ma</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># x is batch data</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># each data should have unique initial statesvector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">wires</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="n">wires</span><span class="p">:</span>
                    <span class="n">rx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="n">wire</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="n">rz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="n">wire</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">layer_circuit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
            <span class="n">all_ma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tensor</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_ma</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DRLModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DRLModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span> <span class="o">=</span> <span class="n">QDRL_MODULE</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span><span class="n">n_layers</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">quanutum_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">quanutum_result</span>
</pre></div>
</div>
<p>训练代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">param_targ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">bias_targ</span> <span class="o">=</span> <span class="n">bias</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DRLModel</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_ITERATIONS</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">state_t</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">a_init</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_STEPS</span><span class="p">):</span>
        <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rgb_array&#39;</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">input_x</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">state_t</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
        <span class="n">acts</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_x</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias</span>
        <span class="c1"># print(f&#39;type of acts: {type(acts)}&#39;)</span>
        <span class="n">act_t</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>
        <span class="c1"># print(f&#39;act_t: {act_t} type of act_t: {type(act_t)}&#39;)</span>
        <span class="n">act_t_np</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">act_t</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Episode: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, Steps: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">, act: </span><span class="si">{</span><span class="n">act_t_np</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">state_nt</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">act_t_np</span><span class="p">)</span>
        <span class="n">targ_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">input_state_nt</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">state_nt</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
        <span class="n">act_nt</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">input_state_nt</span><span class="p">)</span><span class="o">+</span><span class="n">bias</span><span class="p">)</span>
        <span class="n">act_nt_np</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">act_nt</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">state_t</span><span class="p">,</span> <span class="n">act_t</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">state_nt</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">BATCHSIZE</span><span class="p">:</span>
            <span class="c1"># print(&#39;Optimizing...&#39;)</span>
            <span class="n">sampled_vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">memory</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">memory</span><span class="p">),</span> <span class="n">BATCHSIZE</span><span class="p">)]</span>
            <span class="n">target_temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sampled_vs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">DONE</span><span class="p">]:</span>
                    <span class="n">target_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">REWARD</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_s</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">s</span><span class="p">[</span><span class="n">STATE_NT</span><span class="p">]]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
                    <span class="n">out_temp</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">REWARD</span><span class="p">]</span> <span class="o">+</span> <span class="n">GAMMA</span> <span class="o">*</span> <span class="n">tensor</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">input_s</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias_targ</span><span class="p">)</span>
                    <span class="n">out_temp</span> <span class="o">=</span> <span class="n">out_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">target_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_temp</span><span class="p">)</span>
            <span class="n">target_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">sampled_vs</span><span class="p">:</span>
                <span class="n">input_b</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">b</span><span class="p">[</span><span class="n">STATE_T</span><span class="p">]]],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
                <span class="n">out_result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_b</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">ACTION</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
                <span class="n">out_result_temp</span> <span class="o">=</span> <span class="n">out_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">target_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_result_temp</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">target_label</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">target_temp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">target_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">target_label</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># update parameters in target circuit</span>
        <span class="k">if</span> <span class="n">targ_counter</span> <span class="o">==</span> <span class="n">TARGET_MAX</span><span class="p">:</span>
            <span class="n">param_targ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">bias_targ</span> <span class="o">=</span> <span class="n">bias</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">targ_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">state_t</span><span class="p">,</span> <span class="n">act_t_np</span> <span class="o">=</span> <span class="n">state_nt</span><span class="p">,</span> <span class="n">act_nt_np</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;reward&quot;</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reward</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rgb_array&#39;</span><span class="p">))</span>
                <span class="n">display_frames_as_gif</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Episode: 0, Steps: 0, act: 0</span>
<span class="sd"># Episode: 0, Steps: 1, act: 0</span>
<span class="sd"># Episode: 0, Steps: 2, act: 0</span>
<span class="sd"># Episode: 0, Steps: 3, act: 0</span>
<span class="sd"># Episode: 0, Steps: 4, act: 0</span>
<span class="sd"># Episode: 0, Steps: 5, act: 3</span>
<span class="sd"># Episode: 0, Steps: 6, act: 0</span>
<span class="sd"># Episode: 0, Steps: 7, act: 0</span>
<span class="sd"># Episode: 0, Steps: 8, act: 1</span>
<span class="sd"># Episode: 0, Steps: 9, act: 3</span>
<span class="sd"># Episode: 0, Steps: 10, act: 0</span>
<span class="sd"># Episode: 0, Steps: 11, act: 1</span>
<span class="sd"># Episode: 0, Steps: 12, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 1, Steps: 0, act: 3</span>
<span class="sd"># Episode: 1, Steps: 1, act: 1</span>
<span class="sd"># Episode: 1, Steps: 2, act: 0</span>
<span class="sd"># Episode: 1, Steps: 3, act: 0</span>
<span class="sd"># Episode: 1, Steps: 4, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 2, Steps: 0, act: 0</span>
<span class="sd"># Episode: 2, Steps: 1, act: 2</span>
<span class="sd"># Episode: 2, Steps: 2, act: 2</span>
<span class="sd"># Episode: 2, Steps: 3, act: 1</span>
<span class="sd"># Episode: 2, Steps: 4, act: 3</span>
<span class="sd"># Episode: 2, Steps: 5, act: 1</span>
<span class="sd"># Episode: 2, Steps: 6, act: 1</span>
<span class="sd"># Episode: 2, Steps: 7, act: 3</span>
<span class="sd"># Episode: 2, Steps: 8, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 3, Steps: 0, act: 0</span>
<span class="sd"># Episode: 3, Steps: 1, act: 0</span>
<span class="sd"># Episode: 3, Steps: 2, act: 0</span>
<span class="sd"># Episode: 3, Steps: 3, act: 1</span>
<span class="sd"># Episode: 3, Steps: 4, act: 1</span>
<span class="sd"># Episode: 3, Steps: 5, act: 2</span>
<span class="sd"># Episode: 3, Steps: 6, act: 3</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 4, Steps: 0, act: 0</span>
<span class="sd"># Episode: 4, Steps: 1, act: 0</span>
<span class="sd"># Episode: 4, Steps: 2, act: 1</span>
<span class="sd"># Episode: 4, Steps: 3, act: 0</span>
<span class="sd"># Episode: 4, Steps: 4, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 5, Steps: 0, act: 3</span>
<span class="sd"># Episode: 5, Steps: 1, act: 1</span>
<span class="sd"># Episode: 5, Steps: 2, act: 1</span>
<span class="sd"># Episode: 5, Steps: 3, act: 0</span>
<span class="sd"># Episode: 5, Steps: 4, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 6, Steps: 0, act: 2</span>
<span class="sd"># Episode: 6, Steps: 1, act: 3</span>
<span class="sd"># Episode: 6, Steps: 2, act: 3</span>
<span class="sd"># Episode: 6, Steps: 3, act: 0</span>
<span class="sd"># Episode: 6, Steps: 4, act: 0</span>
<span class="sd"># Episode: 6, Steps: 5, act: 1</span>
<span class="sd"># Episode: 6, Steps: 6, act: 1</span>
<span class="sd"># Episode: 6, Steps: 7, act: 2</span>
<span class="sd"># Episode: 6, Steps: 8, act: 3</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 7, Steps: 0, act: 2</span>
<span class="sd"># Episode: 7, Steps: 1, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 8, Steps: 0, act: 0</span>
<span class="sd"># Episode: 8, Steps: 1, act: 2</span>
<span class="sd"># Episode: 8, Steps: 2, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 9, Steps: 0, act: 0</span>
<span class="sd"># Episode: 9, Steps: 1, act: 0</span>
<span class="sd"># Episode: 9, Steps: 2, act: 0</span>
<span class="sd"># Episode: 9, Steps: 3, act: 0</span>
<span class="sd"># Episode: 9, Steps: 4, act: 3</span>
<span class="sd"># Episode: 9, Steps: 5, act: 2</span>
<span class="sd"># Episode: 9, Steps: 6, act: 3</span>
<span class="sd"># Episode: 9, Steps: 7, act: 0</span>
<span class="sd"># Episode: 9, Steps: 8, act: 0</span>
<span class="sd"># Episode: 9, Steps: 9, act: 1</span>
<span class="sd"># Episode: 9, Steps: 10, act: 0</span>
<span class="sd"># Episode: 9, Steps: 11, act: 1</span>
<span class="sd"># Episode: 9, Steps: 12, act: 3</span>
<span class="sd"># Episode: 9, Steps: 13, act: 0</span>
<span class="sd"># Episode: 9, Steps: 14, act: 0</span>
<span class="sd"># Episode: 9, Steps: 15, act: 0</span>
<span class="sd"># Episode: 9, Steps: 16, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 10, Steps: 0, act: 0</span>
<span class="sd"># Episode: 10, Steps: 1, act: 0</span>
<span class="sd"># Episode: 10, Steps: 2, act: 0</span>
<span class="sd"># Episode: 10, Steps: 3, act: 1</span>
<span class="sd"># Episode: 10, Steps: 4, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 11, Steps: 0, act: 0</span>
<span class="sd"># Episode: 11, Steps: 1, act: 0</span>
<span class="sd"># Episode: 11, Steps: 2, act: 1</span>
<span class="sd"># Episode: 11, Steps: 3, act: 0</span>
<span class="sd"># Episode: 11, Steps: 4, act: 0</span>
<span class="sd"># Episode: 11, Steps: 5, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 12, Steps: 0, act: 0</span>
<span class="sd"># Episode: 12, Steps: 1, act: 0</span>
<span class="sd"># Episode: 12, Steps: 2, act: 3</span>
<span class="sd"># Episode: 12, Steps: 3, act: 0</span>
<span class="sd"># Episode: 12, Steps: 4, act: 0</span>
<span class="sd"># Episode: 12, Steps: 5, act: 0</span>
<span class="sd"># Episode: 12, Steps: 6, act: 3</span>
<span class="sd"># Episode: 12, Steps: 7, act: 3</span>
<span class="sd"># Episode: 12, Steps: 8, act: 0</span>
<span class="sd"># Episode: 12, Steps: 9, act: 0</span>
<span class="sd"># Episode: 12, Steps: 10, act: 3</span>
<span class="sd"># Episode: 12, Steps: 11, act: 0</span>
<span class="sd"># Episode: 12, Steps: 12, act: 1</span>
<span class="sd"># Episode: 12, Steps: 13, act: 1</span>
<span class="sd"># Episode: 12, Steps: 14, act: 0</span>
<span class="sd"># Episode: 12, Steps: 15, act: 0</span>
<span class="sd"># Episode: 12, Steps: 16, act: 2</span>
<span class="sd"># Episode: 12, Steps: 17, act: 1</span>
<span class="sd"># Episode: 12, Steps: 18, act: 1</span>
<span class="sd"># Episode: 12, Steps: 19, act: 3</span>
<span class="sd"># Episode: 12, Steps: 20, act: 0</span>
<span class="sd"># Episode: 12, Steps: 21, act: 0</span>
<span class="sd"># Episode: 12, Steps: 22, act: 2</span>
<span class="sd"># Episode: 12, Steps: 23, act: 3</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 13, Steps: 0, act: 3</span>
<span class="sd"># Episode: 13, Steps: 1, act: 0</span>
<span class="sd"># Episode: 13, Steps: 2, act: 0</span>
<span class="sd"># Episode: 13, Steps: 3, act: 1</span>
<span class="sd"># Episode: 13, Steps: 4, act: 3</span>
<span class="sd"># Episode: 13, Steps: 5, act: 0</span>
<span class="sd"># Episode: 13, Steps: 6, act: 2</span>
<span class="sd"># Episode: 13, Steps: 7, act: 3</span>
<span class="sd"># Episode: 13, Steps: 8, act: 0</span>
<span class="sd"># Episode: 13, Steps: 9, act: 1</span>
<span class="sd"># Episode: 13, Steps: 10, act: 3</span>
<span class="sd"># Episode: 13, Steps: 11, act: 1</span>
<span class="sd"># Episode: 13, Steps: 12, act: 1</span>
<span class="sd"># Episode: 13, Steps: 13, act: 2</span>
<span class="sd"># Episode: 13, Steps: 14, act: 0</span>
<span class="sd"># Episode: 13, Steps: 15, act: 2</span>
<span class="sd"># Episode: 13, Steps: 16, act: 0</span>
<span class="sd"># Episode: 13, Steps: 17, act: 0</span>
<span class="sd"># Episode: 13, Steps: 18, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 14, Steps: 0, act: 1</span>
<span class="sd"># Episode: 14, Steps: 1, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 15, Steps: 0, act: 3</span>
<span class="sd"># Episode: 15, Steps: 1, act: 2</span>
<span class="sd"># Episode: 15, Steps: 2, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 16, Steps: 0, act: 1</span>
<span class="sd"># Episode: 16, Steps: 1, act: 1</span>
<span class="sd"># Episode: 16, Steps: 2, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 17, Steps: 0, act: 2</span>
<span class="sd"># Episode: 17, Steps: 1, act: 2</span>
<span class="sd"># Episode: 17, Steps: 2, act: 3</span>
<span class="sd"># Episode: 17, Steps: 3, act: 1</span>
<span class="sd"># Episode: 17, Steps: 4, act: 0</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 18, Steps: 0, act: 3</span>
<span class="sd"># Episode: 18, Steps: 1, act: 2</span>
<span class="sd"># Episode: 18, Steps: 2, act: 3</span>
<span class="sd"># Episode: 18, Steps: 3, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 19, Steps: 0, act: 0</span>
<span class="sd"># Episode: 19, Steps: 1, act: 3</span>
<span class="sd"># Episode: 19, Steps: 2, act: 2</span>
<span class="sd"># Episode: 19, Steps: 3, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 20, Steps: 0, act: 3</span>
<span class="sd"># Episode: 20, Steps: 1, act: 0</span>
<span class="sd"># Episode: 20, Steps: 2, act: 1</span>
<span class="sd"># Episode: 20, Steps: 3, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 21, Steps: 0, act: 0</span>
<span class="sd"># Episode: 21, Steps: 1, act: 0</span>
<span class="sd"># Episode: 21, Steps: 2, act: 0</span>
<span class="sd"># Episode: 21, Steps: 3, act: 3</span>
<span class="sd"># Episode: 21, Steps: 4, act: 0</span>
<span class="sd"># Episode: 21, Steps: 5, act: 0</span>
<span class="sd"># Episode: 21, Steps: 6, act: 0</span>
<span class="sd"># Episode: 21, Steps: 7, act: 1</span>
<span class="sd"># Episode: 21, Steps: 8, act: 0</span>
<span class="sd"># Episode: 21, Steps: 9, act: 0</span>
<span class="sd"># Episode: 21, Steps: 10, act: 1</span>
<span class="sd"># Episode: 21, Steps: 11, act: 3</span>
<span class="sd"># Episode: 21, Steps: 12, act: 3</span>
<span class="sd"># Episode: 21, Steps: 13, act: 1</span>
<span class="sd"># Episode: 21, Steps: 14, act: 1</span>
<span class="sd"># Episode: 21, Steps: 15, act: 0</span>
<span class="sd"># Episode: 21, Steps: 16, act: 3</span>
<span class="sd"># Episode: 21, Steps: 17, act: 1</span>
<span class="sd"># Episode: 21, Steps: 18, act: 3</span>
<span class="sd"># Episode: 21, Steps: 19, act: 0</span>
<span class="sd"># Episode: 21, Steps: 20, act: 3</span>
<span class="sd"># Episode: 21, Steps: 21, act: 2</span>
<span class="sd"># Episode: 21, Steps: 22, act: 3</span>
<span class="sd"># Episode: 21, Steps: 23, act: 0</span>
<span class="sd"># Episode: 21, Steps: 24, act: 3</span>
<span class="sd"># Episode: 21, Steps: 25, act: 3</span>
<span class="sd"># Episode: 21, Steps: 26, act: 0</span>
<span class="sd"># Episode: 21, Steps: 27, act: 0</span>
<span class="sd"># Episode: 21, Steps: 28, act: 3</span>
<span class="sd"># Episode: 21, Steps: 29, act: 0</span>
<span class="sd"># Episode: 21, Steps: 30, act: 0</span>
<span class="sd"># Episode: 21, Steps: 31, act: 3</span>
<span class="sd"># Episode: 21, Steps: 32, act: 1</span>
<span class="sd"># Episode: 21, Steps: 33, act: 0</span>
<span class="sd"># Episode: 21, Steps: 34, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 22, Steps: 0, act: 3</span>
<span class="sd"># Episode: 22, Steps: 1, act: 0</span>
<span class="sd"># Episode: 22, Steps: 2, act: 3</span>
<span class="sd"># Episode: 22, Steps: 3, act: 3</span>
<span class="sd"># Episode: 22, Steps: 4, act: 3</span>
<span class="sd"># Episode: 22, Steps: 5, act: 1</span>
<span class="sd"># Episode: 22, Steps: 6, act: 2</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 23, Steps: 0, act: 0</span>
<span class="sd"># Episode: 23, Steps: 1, act: 0</span>
<span class="sd"># Episode: 23, Steps: 2, act: 0</span>
<span class="sd"># Episode: 23, Steps: 3, act: 2</span>
<span class="sd"># Episode: 23, Steps: 4, act: 3</span>
<span class="sd"># Episode: 23, Steps: 5, act: 2</span>
<span class="sd"># Episode: 23, Steps: 6, act: 0</span>
<span class="sd"># Episode: 23, Steps: 7, act: 0</span>
<span class="sd"># Episode: 23, Steps: 8, act: 0</span>
<span class="sd"># Episode: 23, Steps: 9, act: 1</span>
<span class="sd"># Episode: 23, Steps: 10, act: 3</span>
<span class="sd"># Episode: 23, Steps: 11, act: 0</span>
<span class="sd"># Episode: 23, Steps: 12, act: 2</span>
<span class="sd"># Episode: 23, Steps: 13, act: 1</span>
<span class="sd"># reward 0.0</span>
<span class="sd"># Episode: 24, Steps: 0, act: 0</span>
<span class="sd"># Episode: 24, Steps: 1, act: 3</span>
<span class="sd"># Episode: 24, Steps: 2, act: 1</span>
<span class="sd"># Episode: 24, Steps: 3, act: 1</span>
<span class="sd"># Episode: 24, Steps: 4, act: 0</span>
<span class="sd"># Episode: 24, Steps: 5, act: 2</span>
<span class="sd"># Episode: 24, Steps: 6, act: 2</span>
<span class="sd"># Episode: 24, Steps: 7, act: 1</span>
<span class="sd"># Episode: 24, Steps: 8, act: 1</span>
<span class="sd"># Episode: 24, Steps: 9, act: 1</span>
<span class="sd"># Episode: 24, Steps: 10, act: 2</span>
<span class="sd"># reward 1.0</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="gpu">
<h2>使用量子变分线路在GPU上拟合一个傅里叶级数的示例<a class="headerlink" href="#gpu" title="Link to this heading">¶</a></h2>
<p>通过参数化的量子线路将数据输入映射到预测的模型,量子计算机可用于监督学习。虽然已经做了大量工作来研究这种方法的实际意义,
但这些模型的许多重要理论特性仍然未知。在这里,我们研究了将数据编码到模型中的策略如何影响参数化量子电路作为函数逼近器的表达能力。</p>
<p>本例参照 <a class="reference external" href="https://arxiv.org/pdf/2008.08605.pdf">The effect of data encoding on the expressive power of variational quantum machine learning models</a> 论文将量子计算机设计的常见量子机器学习模型与傅里叶级数联系起来。</p>
<p>其中量子模型为:</p>
<a class="reference internal image-reference" href="../_images/single_qubit_model_circuit.png"><img alt="../_images/single_qubit_model_circuit.png" class="align-center" src="../_images/single_qubit_model_circuit.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>导入必须的库并且使用 <code class="docutils literal notranslate"><span class="pre">pyvqnet.qnn.vqc</span></code> 定义变分量子线路模型:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span><span class="p">,</span><span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeanSquaredError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet</span><span class="w"> </span><span class="kn">import</span> <span class="n">kfloat32</span><span class="p">,</span> <span class="n">kint64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.device</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEV_GPU</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span><span class="p">,</span><span class="n">QModule</span><span class="p">,</span><span class="n">rx</span><span class="p">,</span><span class="n">rz</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span>\
    <span class="n">MeasureAll</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># degree of the target function</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># scaling of the data</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span> <span class="o">+</span> <span class="mf">0.15</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">degree</span>  <span class="c1"># coefficients of non-zero frequencies</span>
<span class="n">coeff0</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># coefficient of zero frequency</span>
<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">weights</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># some random initial weights</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">target_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a truncated Fourier series, where the data gets re-scaled.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">coeff0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">scaling</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
        <span class="n">conj_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">conj_coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">exponent</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">target_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_function</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vqc_s</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="n">rx</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">vqc_w</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span><span class="n">theta</span><span class="p">):</span>
    <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ry</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">rz</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">QModel</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span> <span class="o">=</span> <span class="n">num_qubits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
        <span class="n">pauli_str_list</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">pauli_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pauli_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">pauli_str_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">qubits</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">)</span>
        <span class="n">vqc_w</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vqc_s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">vqc_w</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_fourier_series</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_fourier_series</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>训练代码,我们此处使用GPU进行训练,我们需要将模型 <cite>Model</cite> 以及输入的 <cite>data</cite> , <cite>label</cite> 使用 <code class="docutils literal notranslate"><span class="pre">toGPU</span></code> 或者指定 <cite>device</cite> 的方式将数据放到GPU上。
其他接口与使用CPU进行训练的代码没有区别。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">toGPU</span><span class="p">(</span><span class="n">DEV_GPU</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">MeanSquaredError</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Select batch of data</span>
            <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,))</span>
            <span class="n">x_batch</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y_batch</span> <span class="o">=</span> <span class="n">target_y</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#load data into GPU</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">DEV_GPU</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">DEV_GPU</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss_b</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">loss_b</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss_b</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, #### loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">epoch:0, #### loss:0.03909379681921564</span>
<span class="sd">epoch:1, #### loss:0.005479114687623223</span>
<span class="sd">epoch:2, #### loss:0.019679916104651057</span>
<span class="sd">epoch:3, #### loss:0.00861194647848606</span>
<span class="sd">epoch:4, #### loss:0.0035393996626953595</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="id10">
<h2>量子奇异值分解<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h2>
<p>下面例子实现论文 <a class="reference external" href="https://arxiv.org/abs/2006.02336">Variational Quantum Singular Value Decomposition</a> 中的算法。</p>
<p>奇异值分解 (Singular Value Decomposition,简称 <code class="docutils literal notranslate"><span class="pre">SVD</span></code>) 是线性代数中一种重要的矩阵分解,它作为特征分解在任意维数矩阵上的推广,在机器学习领域中被广泛应用,常用于矩阵压缩、推荐系统以及自然语言处理等。</p>
<p>变分量子奇异值分解(Variational Quantum Singular Value Decomposition,简称 <code class="docutils literal notranslate"><span class="pre">QSVD</span></code>)将SVD转换成优化问题,并通过变分量子线路求解。</p>
<p>论文中将矩阵奇异值分解分解成四个步骤求解:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>输入带分解矩阵 <span class="math notranslate nohighlight">\(\mathbf{M}\)</span>,想压缩到的阶数 <span class="math notranslate nohighlight">\(\mathbf{T}\)</span>, 权重 <span class="math notranslate nohighlight">\(\mathbf{W}\)</span>,参数话的酉矩阵 <span class="math notranslate nohighlight">\(\mathbf{U}(\theta)\)</span> 和 <span class="math notranslate nohighlight">\(\mathbf{V}(\phi)\)</span></p></li>
<li><p>搭建量子神经网络估算奇异值 <span class="math notranslate nohighlight">\(m_j = Re\langle\psi_j\mid U(\theta)^\dagger M V(\phi) \mid\psi_j\rangle\)</span>,并最大化加权奇异值的和 <span class="math notranslate nohighlight">\(L(\theta, \phi) = \sum_{j=1}^{T} q_j \cdot \operatorname{Re}\langle\psi_j \mid U(\theta)^\dagger MV(\phi) \mid \psi_j\rangle\)</span>, 其中,加权是为了让计算出的奇异值从大到小排列</p></li>
<li><p>读出最大化时参数值,计算出 <span class="math notranslate nohighlight">\(\mathbf{U}(\alpha^{*})\)</span> 和 <span class="math notranslate nohighlight">\(\mathbf{V}(\beta^{*})\)</span></p></li>
<li><p>输出结果: 奇异值 <span class="math notranslate nohighlight">\(m_1, \dots, m_r\)</span>,和奇异矩阵 <span class="math notranslate nohighlight">\(\mathbf{U}(\alpha^{*})\)</span> 和 <span class="math notranslate nohighlight">\(\mathbf{V}(\beta^{*})\)</span></p></li>
</ol>
</div></blockquote>
<a class="reference internal image-reference" href="../_images/qsvd.png"><img alt="../_images/qsvd.png" class="align-center" src="../_images/qsvd.png" style="width: 700px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>伪代码如下:</p>
<a class="reference internal image-reference" href="../_images/qsvd_algorithm.png"><img alt="../_images/qsvd_algorithm.png" class="align-center" src="../_images/qsvd_algorithm.png" style="width: 700px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>量子线路设计如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>q0: ──RY(v_theta0)────RZ(v_theta3)────●─────────X────RY(v_theta6)─────RZ(v_theta9)────●─────────X────RY(v_theta12)────RZ(v_theta15)────●─────────X────RY(v_theta18)────RZ(v_theta21)────●─────────X────RY(v_theta24)────RZ(v_theta27)────●─────────X────RY(v_theta30)────RZ(v_theta33)────●─────────X────RY(v_theta36)────RZ(v_theta39)────●─────────X────RY(v_theta42)────RZ(v_theta45)────●─────────X────RY(v_theta48)────RZ(v_theta51)────●─────────X────RY(v_theta54)────RZ(v_theta57)────●─────────X────RY(v_theta60)────RZ(v_theta63)────●─────────X────RY(v_theta66)────RZ(v_theta69)────●─────────X────RY(v_theta72)────RZ(v_theta75)────●─────────X────RY(v_theta78)────RZ(v_theta81)────●─────────X────RY(v_theta84)────RZ(v_theta87)────●─────────X────RY(v_theta90)────RZ(v_theta93)────●─────────X────RY(v_theta96)────RZ(v_theta99)─────●─────────X────RY(v_theta102)────RZ(v_theta105)────●─────────X────RY(v_theta108)────RZ(v_theta111)────●─────────X────RY(v_theta114)────RZ(v_theta117)────●─────────X──
                                      │         │                                     │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                      │         │                                       │         │                                        │         │                                        │         │                                        │         │
q1: ──RY(v_theta1)────RZ(v_theta4)────X────●────┼────RY(v_theta7)────RZ(v_theta10)────X────●────┼────RY(v_theta13)────RZ(v_theta16)────X────●────┼────RY(v_theta19)────RZ(v_theta22)────X────●────┼────RY(v_theta25)────RZ(v_theta28)────X────●────┼────RY(v_theta31)────RZ(v_theta34)────X────●────┼────RY(v_theta37)────RZ(v_theta40)────X────●────┼────RY(v_theta43)────RZ(v_theta46)────X────●────┼────RY(v_theta49)────RZ(v_theta52)────X────●────┼────RY(v_theta55)────RZ(v_theta58)────X────●────┼────RY(v_theta61)────RZ(v_theta64)────X────●────┼────RY(v_theta67)────RZ(v_theta70)────X────●────┼────RY(v_theta73)────RZ(v_theta76)────X────●────┼────RY(v_theta79)────RZ(v_theta82)────X────●────┼────RY(v_theta85)────RZ(v_theta88)────X────●────┼────RY(v_theta91)────RZ(v_theta94)────X────●────┼────RY(v_theta97)────RZ(v_theta100)────X────●────┼────RY(v_theta103)────RZ(v_theta106)────X────●────┼────RY(v_theta109)────RZ(v_theta112)────X────●────┼────RY(v_theta115)────RZ(v_theta118)────X────●────┼──
                                           │    │                                          │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                           │    │                                            │    │                                             │    │                                             │    │                                             │    │
q2: ──RY(v_theta2)────RZ(v_theta5)─────────X────●────RY(v_theta8)────RZ(v_theta11)─────────X────●────RY(v_theta14)────RZ(v_theta17)─────────X────●────RY(v_theta20)────RZ(v_theta23)─────────X────●────RY(v_theta26)────RZ(v_theta29)─────────X────●────RY(v_theta32)────RZ(v_theta35)─────────X────●────RY(v_theta38)────RZ(v_theta41)─────────X────●────RY(v_theta44)────RZ(v_theta47)─────────X────●────RY(v_theta50)────RZ(v_theta53)─────────X────●────RY(v_theta56)────RZ(v_theta59)─────────X────●────RY(v_theta62)────RZ(v_theta65)─────────X────●────RY(v_theta68)────RZ(v_theta71)─────────X────●────RY(v_theta74)────RZ(v_theta77)─────────X────●────RY(v_theta80)────RZ(v_theta83)─────────X────●────RY(v_theta86)────RZ(v_theta89)─────────X────●────RY(v_theta92)────RZ(v_theta95)─────────X────●────RY(v_theta98)────RZ(v_theta101)─────────X────●────RY(v_theta104)────RZ(v_theta107)─────────X────●────RY(v_theta110)────RZ(v_theta113)─────────X────●────RY(v_theta116)────RZ(v_theta119)─────────X────●──
</pre></div>
</div>
<p>以下是具体QSVD实现代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.parameter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ry</span><span class="p">,</span> <span class="n">QMachine</span><span class="p">,</span> <span class="n">cnot</span><span class="p">,</span> <span class="n">rz</span>

<span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># qbits number</span>
<span class="n">cir_depth</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># circuit depth</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">n_qubits</span>
<span class="n">rank</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># learning rank</span>
<span class="n">step</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">ITR</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># iterations</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># learning rate</span>

<span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rank</span> <span class="o">*</span> <span class="n">step</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">step</span><span class="p">),</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Define random seed</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mat_generator</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a random complex matrix</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
        <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">matrix</span>


<span class="c1"># Generate matrix M which will be decomposed</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">mat_generator</span><span class="p">()</span>

<span class="c1"># m_copy is generated to error analysis</span>
<span class="n">m_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

<span class="c1"># Print M</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Random matrix M is: &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

<span class="c1"># Get SVD results</span>
<span class="n">U</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">v_dagger</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Random matrix M is:</span>
<span class="c1"># [[6.+1.j 3.+9.j 7.+3.j 4.+7.j 6.+6.j 9.+8.j 2.+7.j 6.+4.j]</span>
<span class="c1">#  [7.+1.j 4.+4.j 3.+7.j 7.+9.j 7.+8.j 2.+8.j 5.+0.j 4.+8.j]</span>
<span class="c1">#  [1.+6.j 7.+8.j 5.+7.j 1.+0.j 4.+7.j 0.+7.j 9.+2.j 5.+0.j]</span>
<span class="c1">#  [8.+7.j 0.+2.j 9.+2.j 2.+0.j 6.+4.j 3.+9.j 8.+6.j 2.+9.j]</span>
<span class="c1">#  [4.+8.j 2.+6.j 6.+8.j 4.+7.j 8.+1.j 6.+0.j 1.+6.j 3.+6.j]</span>
<span class="c1">#  [8.+7.j 1.+4.j 9.+2.j 8.+7.j 9.+5.j 4.+2.j 1.+0.j 3.+2.j]</span>
<span class="c1">#  [6.+4.j 7.+2.j 2.+0.j 0.+4.j 3.+9.j 1.+6.j 7.+6.j 3.+8.j]</span>
<span class="c1">#  [1.+9.j 5.+9.j 5.+2.j 9.+6.j 3.+0.j 5.+3.j 1.+3.j 9.+4.j]]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<span class="c1"># [54.8348498 19.1814107 14.9886625 11.6141956 10.1592704  7.6022325</span>
<span class="c1">#  5.8104054  3.30116  ]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">vqc_circuit</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">para</span><span class="p">):</span>
    <span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">qm</span><span class="o">.</span><span class="n">set_states</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">para</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">para</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">qm</span><span class="o">.</span><span class="n">states</span>

<span class="n">i_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">VQC_svd</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VQC_svd</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params_u</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params_u_single</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="mi">120</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_v_single</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="mi">120</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qm_u_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">qm_v_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>

            <span class="n">qm</span> <span class="o">=</span> <span class="n">vqc_circuit</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">i_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kcomplex64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_u_single</span><span class="p">)</span>
            <span class="n">qm_u_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qm</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">qm</span> <span class="o">=</span> <span class="n">vqc_circuit</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">i_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kcomplex64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_v_single</span><span class="p">)</span>
            <span class="n">qm_v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qm</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">states_u</span> <span class="o">=</span> <span class="n">qm_u_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">states_u</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">states_u</span><span class="p">)</span>

            <span class="n">states_v</span> <span class="o">=</span> <span class="n">qm_v_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">pred</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">states_u</span><span class="p">,</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kcomplex64</span><span class="p">))</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">states_v</span><span class="p">)</span>

            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">qm_u_list</span><span class="p">,</span> <span class="n">qm_v_list</span><span class="p">,</span> <span class="n">result</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">loss_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">VQC_svd</span><span class="p">()</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ITR</span><span class="p">)):</span>

        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">qm_u_list</span><span class="p">,</span> <span class="n">qm_v_list</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">loss</span> <span class="o">-=</span> <span class="n">loss_</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">itr</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="n">pyvqnet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span><span class="sa">f</span><span class="s2">&quot;vqc_svd_</span><span class="si">{</span><span class="n">ITR</span><span class="si">}</span><span class="s2">.model&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">eval</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">VQC_svd</span><span class="p">()</span>
    <span class="n">model_para</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">load_parameters</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vqc_svd_</span><span class="si">{</span><span class="n">ITR</span><span class="si">}</span><span class="s2">.model&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_para</span><span class="p">)</span>
    <span class="n">qm_u_list</span><span class="p">,</span> <span class="n">qm_v_list</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
    <span class="c1"># U is qm_u_list</span>
    <span class="c1"># V is qm_v_list</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>运行的loss以及奇异值结果:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="o">-</span><span class="mf">145.04752</span><span class="p">]]</span>  <span class="c1">## 20/200 [00:56&lt;09:30,  3.17s/it]</span>
<span class="p">[[[</span><span class="o">-</span><span class="mf">5.9279256</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.7229557</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">12.809682</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">3.2357244</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">5.232873</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">4.5523396</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.9724817</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">7.733829</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">4836.0083</span><span class="p">]]</span> <span class="c1">## 40/200 [02:08&lt;10:11,  3.82s/it]</span>
<span class="p">[[[</span><span class="mf">30.293152</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">21.15204</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">26.832254</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">11.953516</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">9.615778</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">9.914136</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.34158</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.7990487</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5371.0034</span><span class="p">]]</span> <span class="c1">## 60/200 [03:31&lt;10:04,  4.32s/it]</span>
<span class="p">[[[</span><span class="mf">52.829674</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">16.831125</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">15.112174</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">12.098673</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">9.9859915</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">8.895033</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.1445904</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">1.2537733</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5484.087</span><span class="p">]]</span>  <span class="c1">## 80/200 [05:03&lt;09:23,  4.69s/it]</span>
<span class="p">[[[</span><span class="mf">54.775055</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">16.41207</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">15.00042</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">13.043125</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">9.884815</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">8.17144</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.8188157</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.5532891</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5516.793</span><span class="p">]]</span>  <span class="c1">## 100/200 [06:41&lt;08:23,  5.04s/it]</span>
<span class="p">[[[</span><span class="mf">54.797073</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">17.457108</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">14.50795</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">13.288734</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">9.7749815</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">7.900285</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.7255745</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.2063196</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5531.2007</span><span class="p">]]</span> <span class="c1">## 120/200 [08:24&lt;07:08,  5.35s/it]</span>
<span class="p">[[[</span><span class="mf">54.816666</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">18.107487</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">14.094158</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">13.305479</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">9.837374</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">7.7387457</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.6890383</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.1503702</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5539.823</span><span class="p">]]</span>  <span class="c1">## 140/200 [10:11&lt;05:20,  5.34s/it]</span>
<span class="p">[[[</span><span class="mf">54.822754</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">18.518795</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">13.9633045</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">13.136647</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">9.929082</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">7.647796</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.6548705</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.2427776</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5545.748</span><span class="p">]]</span>  <span class="c1">## 160/200 [12:00&lt;03:37,  5.43s/it]</span>
<span class="p">[[[</span><span class="mf">54.825073</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">18.766531</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">14.041204</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">12.855356</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">10.009973</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">7.5971537</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.6524153</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.3767563</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5550.124</span><span class="p">]]</span>  <span class="c1">## 180/200 [13:50&lt;01:49,  5.45s/it]</span>
<span class="p">[[[</span><span class="mf">54.82772</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">18.913624</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">14.219269</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">12.547045</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">10.063704</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">7.569273</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.6508512</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.4574079</span><span class="p">]]]</span>
 <span class="p">[[</span><span class="o">-</span><span class="mf">5553.423</span><span class="p">]]</span>  <span class="c1">## 200/200 [15:40&lt;00:00,  4.70s/it]</span>
<span class="p">[[[</span><span class="mf">54.829308</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">19.001402</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">14.423045</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">12.262444</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">10.100731</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">7.5507345</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">5.6469355</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.4976197</span><span class="p">]]]</span>
</pre></div>
</div>
</section>
<section id="id11">
<h2>变分量子线路的优化<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h2>
<p>VQNet当前提供4种方式对用户自定义的变分量子线路中的量子逻辑门进行优化:融合旋转门(commute_controlled_right,commute_controlled_left),受控门交换(commute_controlled),单比特逻辑门融合(single_qubit_ops_fuse)。</p>
<p>这里使用 <cite>wrapper_compile</cite> 装饰器对 <cite>QModule</cite> 定义的模型forward函数进行装饰,会默认连续调用 <cite>commute_controlled_right</cite>, <cite>merge_rotations</cite>, <cite>single_qubit_ops_fuse</cite> 三个规则进行线路优化。
最后通过 <cite>op_history_summary</cite> 接口,对 <cite>QModule</cite> 前向函数运行后产生的 <cite>op_history</cite> 的信息对比。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">op_history_summary</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QModule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span><span class="p">,</span> <span class="n">wrapper_compile</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">pauliy</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="n">QMachine</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span><span class="n">rz</span><span class="p">,</span> <span class="n">ControlledPhaseShift</span><span class="p">,</span> \
    <span class="n">rx</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">isingxy</span><span class="p">,</span><span class="n">CSWAP</span><span class="p">,</span> <span class="n">PauliX</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">MeasureAll</span><span class="p">,</span> <span class="n">RZ</span><span class="p">,</span> <span class="n">CZ</span><span class="p">,</span> <span class="n">PhaseShift</span><span class="p">,</span> <span class="n">u3</span><span class="p">,</span> <span class="n">cnot</span><span class="p">,</span> <span class="n">cry</span><span class="p">,</span> <span class="n">toffoli</span><span class="p">,</span> <span class="n">cy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span><span class="p">,</span> <span class="n">tensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>

<span class="k">class</span><span class="w"> </span><span class="nc">QModel_before</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QModel_before</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_num_wires</span> <span class="o">=</span> <span class="n">num_wires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">set_save_op_history_flag</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cswap</span> <span class="o">=</span> <span class="n">CSWAP</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cz</span> <span class="o">=</span> <span class="n">CZ</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">paulix</span> <span class="o">=</span> <span class="n">PauliX</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">PhaseShift</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cps</span> <span class="o">=</span> <span class="n">ControlledPhaseShift</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rz</span> <span class="o">=</span> <span class="n">RZ</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">measure</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;wires&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;observables&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
            <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paulix</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">rx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">rot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">isingxy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cswap</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">pauliy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cps</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">toffoli</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="n">cy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="n">rlt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rlt</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QModel</span><span class="p">(</span><span class="n">QModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_num_wires</span> <span class="o">=</span> <span class="n">num_wires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cswap</span> <span class="o">=</span> <span class="n">CSWAP</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cz</span> <span class="o">=</span> <span class="n">CZ</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">paulix</span> <span class="o">=</span> <span class="n">PauliX</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">PhaseShift</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cps</span> <span class="o">=</span> <span class="n">ControlledPhaseShift</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rz</span> <span class="o">=</span> <span class="n">RZ</span><span class="p">(</span><span class="n">has_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">measure</span> <span class="o">=</span> <span class="n">MeasureAll</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;wires&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;observables&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
            <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

    <span class="nd">@partial</span><span class="p">(</span><span class="n">wrapper_compile</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paulix</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">rx</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">rot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">use_dagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">isingxy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">u3</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cswap</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">cnot</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">pauliy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cps</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">toffoli</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="n">cy</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">,</span><span class="n">wires</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="n">rlt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">q_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rlt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tensor</span>
<span class="n">input_x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]],</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kfloat64</span><span class="p">)</span>

<span class="n">input_x</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">num_wires</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">qunatum_model</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">(</span><span class="n">num_wires</span><span class="o">=</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex128</span><span class="p">)</span>
<span class="n">qunatum_model_before</span> <span class="o">=</span> <span class="n">QModel_before</span><span class="p">(</span><span class="n">num_wires</span><span class="o">=</span><span class="n">num_wires</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex128</span><span class="p">)</span>

<span class="n">batch_y</span> <span class="o">=</span> <span class="n">qunatum_model</span><span class="p">(</span><span class="n">input_x</span><span class="p">)</span>
<span class="n">batch_y</span> <span class="o">=</span> <span class="n">qunatum_model_before</span><span class="p">(</span><span class="n">input_x</span><span class="p">)</span>

<span class="n">flatten_oph_names</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">op_history_summary</span><span class="p">(</span><span class="n">qunatum_model_before</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">op_history</span><span class="p">))</span>
<span class="n">flatten_oph_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">qunatum_model</span><span class="o">.</span><span class="n">compiled_op_historys</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;compile&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">oph</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;op_history&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oph</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;wires&quot;</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
                <span class="n">flatten_oph_names</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span><span class="s2">&quot;wires&quot;</span><span class="p">:</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">op_history_summary</span><span class="p">(</span><span class="n">qunatum_model</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">op_history</span><span class="p">))</span>


<span class="c1"># ###################Summary#######################</span>
<span class="c1"># qubits num: 3</span>
<span class="c1"># gates: {&#39;cz&#39;: 1, &#39;paulix&#39;: 1, &#39;rx&#39;: 1, &#39;ry&#39;: 4, &#39;rz&#39;: 3, &#39;rot&#39;: 2, &#39;isingxy&#39;: 1, &#39;u3&#39;: 1, &#39;s&#39;: 1, &#39;cswap&#39;: 1, &#39;cnot&#39;: 1, &#39;pauliy&#39;: 1, &#39;cry&#39;: 1, &#39;phaseshift&#39;: 1, &#39;controlledphaseshift&#39;: 1, &#39;toffoli&#39;: 1, &#39;t&#39;: 1, &#39;cy&#39;: 1}</span>
<span class="c1"># total gates: 24</span>
<span class="c1"># total parameter gates: 15</span>
<span class="c1"># total parameters: 21</span>
<span class="c1"># #################################################</span>

<span class="c1"># after</span>


<span class="c1"># ###################Summary#######################</span>
<span class="c1"># qubits num: 3</span>
<span class="c1"># gates: {&#39;cz&#39;: 1, &#39;rot&#39;: 7, &#39;isingxy&#39;: 1, &#39;u3&#39;: 1, &#39;cswap&#39;: 1, &#39;cnot&#39;: 1, &#39;cry&#39;: 1, &#39;controlledphaseshift&#39;: 1, &#39;toffoli&#39;: 1, &#39;cy&#39;: 1}</span>
<span class="c1"># total gates: 16</span>
<span class="c1"># total parameter gates: 11</span>
<span class="c1"># total parameters: 27</span>
<span class="c1"># #################################################</span>
</pre></div>
</div>
</section>
<section id="dropout">
<h2>量子dropout实现<a class="headerlink" href="#dropout" title="Link to this heading">¶</a></h2>
<p>神经网络(NN)通常需要具有大量可训练参数的高度灵活的模型,以便学习特定的基础函数(或数据分布)。然而,仅仅能够以较低的样本内误差进行学习是不够的；泛化能力也是非常重要的。</p>
<p>表现力强的模型可能会出现过拟合问题,这意味着它们在训练数据上训练得太好,结果在新的未见数据上表现不佳。出现这种情况的原因是,模型学会了训练数据中的噪声,而不是可泛化到新数据的基本模式。</p>
<p>Dropout是经典深度神经网络(DNN)的一种常用技术,可防止计算单元过于专业化,降低过拟合风险。</p>
<p>论文 <cite>A General Approach to Dropout in Quantum Neural Networks</cite> 表明,使用过度参数化的 QNN 模型可以消除大量局部极小值,从而改变优化格局。一方面,参数数量的增加会使训练更快、更容易,但另一方面,它可能会使模型过度拟合数据。这也与重复编码经典数据以实现计算的非线性密切相关。正因如此,受经典 DNN 的启发,我们可以考虑在 QNN 中应用某种 “dropout” 技术。这相当于在训练过程中随机丢弃一些(组)参数化门,以达到更好的泛化效果。</p>
<p>接下来我将通过下面样例了展示如何利用量子dropout来避免在量子机器学习算法在训练中出现的过拟合问题,我们将dropout掉的逻辑门的参数设置为0来进行dropout。</p>
<p>首先是导入相应包</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.vqc.qmeasure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">ticker</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>
</pre></div>
</div>
<p>设置全局变量</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置量子线路层数等相关全局变量</span>
<span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">inner_layers</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">layers</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">params_per_layer</span> <span class="o">=</span> <span class="n">n_qubits</span> <span class="o">*</span> <span class="n">inner_layers</span> <span class="c1"># 此时三个参数为全局变量, 若改成局部变量,注意样例使用地方修改</span>

<span class="c1"># 设置模型训练相关参数</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">700</span>
<span class="n">n_run</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">seed</span> <span class="o">=</span><span class="mi">1234</span>
<span class="n">drop_rates</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)]</span>
<span class="n">train_history</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">test_history</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">opt_params</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
<p>搭建简单的量子线路</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">wires</span><span class="p">,</span> <span class="n">qmachine</span><span class="p">):</span>
    <span class="c1"># Encodes the datum multiple times in the register,</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wires</span><span class="p">:</span>
        <span class="n">ry</span><span class="p">(</span><span class="n">qmachine</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tensor</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wires</span><span class="p">:</span>
        <span class="n">rz</span><span class="p">(</span><span class="n">qmachine</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tensor</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">var_ansatz</span><span class="p">(</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">wires</span><span class="p">,</span> <span class="n">qmachine</span><span class="p">,</span> <span class="n">rotations</span><span class="o">=</span><span class="p">[</span><span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">,</span> <span class="n">rx</span><span class="p">],</span> <span class="n">entangler</span><span class="o">=</span><span class="n">cnot</span><span class="p">,</span> <span class="n">keep_rotation</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

    <span class="c1"># the length of `rotations` defines the number of inner layers</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wires</span><span class="p">)</span>
    <span class="n">wires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wires</span><span class="p">)</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># keep_rotations contains a list per each inner_layer</span>
    <span class="k">for</span> <span class="n">rots</span> <span class="ow">in</span> <span class="n">keep_rotation</span><span class="p">:</span>
        <span class="c1"># we cicle over the elements of the lists inside keep_rotation</span>
        <span class="k">for</span> <span class="n">qb</span><span class="p">,</span> <span class="n">keep_or_drop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rots</span><span class="p">):</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">rotations</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>  <span class="c1"># each inner layer can have a different rotation</span>

            <span class="n">angle</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">counter</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">qb</span><span class="p">]</span>
            <span class="c1"># conditional statement implementing dropout</span>
            <span class="c1"># if `keep_or_drop` is negative the rotation is dropped</span>
            <span class="k">if</span> <span class="n">keep_or_drop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">angle_drop</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">angle_drop</span> <span class="o">=</span> <span class="n">angle</span>

            <span class="n">rot</span><span class="p">(</span><span class="n">qmachine</span><span class="p">,</span> <span class="n">wires</span><span class="p">[</span><span class="n">qb</span><span class="p">],</span> <span class="n">angle_drop</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">qb</span> <span class="ow">in</span> <span class="n">wires</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">entangler</span><span class="p">(</span><span class="n">qmachine</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">wires</span><span class="p">[</span><span class="n">qb</span><span class="p">],</span> <span class="n">wires</span><span class="p">[</span><span class="n">qb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">qnn_circuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">keep_rot</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">qm</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
        <span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">),</span> <span class="n">qmachine</span><span class="o">=</span><span class="n">qm</span><span class="p">)</span>

        <span class="n">keep_rotation</span> <span class="o">=</span> <span class="n">keep_rot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">var_ansatz</span><span class="p">(</span>
            <span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">params_per_layer</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">params_per_layer</span><span class="p">],</span>
            <span class="n">wires</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">),</span><span class="n">qmachine</span><span class="o">=</span><span class="n">qm</span><span class="p">,</span>
            <span class="n">entangler</span><span class="o">=</span><span class="n">cnot</span><span class="p">,</span>
            <span class="n">keep_rotation</span><span class="o">=</span><span class="n">keep_rotation</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">expval</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PauliZ</span><span class="p">())</span>
</pre></div>
</div>
<p>生成dropout列表,根据dropout列表来对量子线路中的逻辑门随机dropout</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_dropout</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">layer_drop_rate</span><span class="p">,</span> <span class="n">rot_drop_rate</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
    <span class="n">drop_layers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">lay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="n">layer_drop_rate</span><span class="p">,</span> <span class="n">layer_drop_rate</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 需dropout的层</span>
            <span class="n">drop_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lay</span><span class="p">)</span>

    <span class="n">keep_rot</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
        <span class="c1"># 每个列表分为层</span>
        <span class="c1"># 这与我们使用的 QNN 相关</span>
        <span class="n">keep_rot_layer</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inner_layers</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">drop_layers</span><span class="p">:</span>  <span class="c1"># 如果需要在这一层应用 dropout</span>
            <span class="n">keep_rot_layer</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">inner_keep_r</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params_per_layer</span><span class="p">):</span>
                <span class="c1"># 每个旋转在层内有概率 p=rot_drop_rate 被丢弃</span>
                <span class="c1"># 根据这个概率,我们为每个参数(旋转)采样</span>
                <span class="c1"># 是否需要丢弃它</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rot_drop_rate</span><span class="p">,</span> <span class="n">rot_drop_rate</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 如果需要保留</span>
                    <span class="n">inner_keep_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span> <span class="o">%</span> <span class="n">n_qubits</span><span class="p">)</span>  <span class="c1"># % 是必须的,因为我们逐层工作</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果旋转需要丢弃</span>
                    <span class="n">inner_keep_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">param</span> <span class="o">%</span> <span class="n">n_qubits</span> <span class="o">==</span> <span class="n">n_qubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 如果是寄存器的最后一个量子比特</span>
                    <span class="n">keep_rot_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inner_keep_r</span><span class="p">)</span>
                    <span class="n">inner_keep_r</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">keep_rot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keep_rot_layer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep_rot</span><span class="p">)</span>
</pre></div>
</div>
<p>将量子线路添加至量子神经网络模块</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">QNN</span><span class="p">(</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span> <span class="o">=</span> <span class="n">QMachine</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pyvqnet</span><span class="o">.</span><span class="n">kcomplex64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">para</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">((</span><span class="n">params_per_layer</span> <span class="o">*</span> <span class="n">layers</span><span class="p">,))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">QTensor</span><span class="p">,</span> <span class="n">keep_rot</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="o">.</span><span class="n">reset_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">qnn_circuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">para</span><span class="p">,</span> <span class="n">keep_rot</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>制作sin数据集</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_sin_dataset</span><span class="p">(</span><span class="n">dataset_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">noise_value</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1D regression problem y=sin(x*\pi)&quot;&quot;&quot;</span>
    <span class="c1"># x-axis</span>
    <span class="n">x_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dataset_size</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_ax</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
    <span class="c1"># noise vector</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span> <span class="o">*</span> <span class="n">noise_value</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_ax</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">noise</span><span class="p">)</span>  <span class="c1"># apply noise</span>

    <span class="c1"># split the dataset</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span>

<span class="n">X</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">make_sin_dataset</span><span class="p">(</span><span class="n">dataset_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>


<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\sin(x)$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$y = \sin(\pi\cdot x) + \epsilon$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$x$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/dropout_sin.png"><img alt="../_images/dropout_sin.png" class="align-center" src="../_images/dropout_sin.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>模型训练代码</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">layer_drop_rate</span><span class="p">,</span> <span class="n">rot_drop_rate</span> <span class="ow">in</span> <span class="n">drop_rates</span><span class="p">:</span>
    <span class="n">costs_per_comb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_costs_per_comb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">opt_params_per_comb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 多次执行</span>
    <span class="k">for</span> <span class="n">tmp_seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">n_run</span><span class="p">):</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">tmp_seed</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># X must be a matrix</span>

        <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># compatibility check</span>

        <span class="c1"># lists for saving single run training and test cost trend</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">test_costs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">QNN</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">pyvqnet</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="c1"># 生成dropout列表</span>
            <span class="n">keep_rot</span> <span class="o">=</span> <span class="n">make_dropout</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">layer_drop_rate</span><span class="p">,</span> <span class="n">rot_drop_rate</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
            <span class="c1"># 更新rng</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">tmp_seed</span><span class="p">)</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">y</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                                                <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">keep_rot</span><span class="p">)</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">cost</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

            <span class="c1">## 测试</span>
            <span class="n">keep_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">((</span><span class="n">n_qubits</span><span class="p">)))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inner_layers</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>


            <span class="n">data_test</span><span class="p">,</span> <span class="n">label_test</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                                                <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">result_test</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data_test</span><span class="p">,</span> <span class="n">keep_rot</span><span class="p">)</span>
            <span class="n">test_cost</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label_test</span><span class="p">,</span> <span class="n">result_test</span><span class="p">)</span>
            <span class="n">test_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_cost</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_drop_rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">rot_drop_rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;run </span><span class="si">{</span><span class="n">tmp_seed</span><span class="o">-</span><span class="n">seed</span><span class="si">}</span><span class="s2"> - epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;--- Train cost:</span><span class="si">{</span><span class="n">cost</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;--- Test cost:</span><span class="si">{</span><span class="n">test_cost</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">costs_per_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>
        <span class="n">test_costs_per_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_costs</span><span class="p">)</span>
        <span class="n">opt_params_per_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

    <span class="n">train_history</span><span class="p">[(</span><span class="n">layer_drop_rate</span><span class="p">,</span> <span class="n">rot_drop_rate</span><span class="p">)]</span> <span class="o">=</span> <span class="n">costs_per_comb</span>
    <span class="n">test_history</span><span class="p">[(</span><span class="n">layer_drop_rate</span><span class="p">,</span> <span class="n">rot_drop_rate</span><span class="p">)]</span> <span class="o">=</span> <span class="n">test_costs_per_comb</span>
    <span class="n">opt_params</span><span class="p">[(</span><span class="n">layer_drop_rate</span><span class="p">,</span> <span class="n">rot_drop_rate</span><span class="p">)]</span> <span class="o">=</span> <span class="n">opt_params_per_comb</span>

<span class="c1">## 0.0-0.0  run 0 - epoch 695/700 --- Train cost:0.3917597 --- Test cost:0.2427316</span>
<span class="c1">## 0.0-0.0  run 1 - epoch 695/700 --- Train cost:0.3917596 --- Test cost:0.2349882</span>
<span class="c1">## 0.0-0.0  run 2 - epoch 695/700 --- Train cost:0.3917597 --- Test cost:0.2103992</span>
<span class="c1">## 0.3-0.2  run 0 - epoch 695/700 --- Train cost:0.3920721 --- Test cost:0.2155183</span>
<span class="c1">## 0.3-0.2  run 1 - epoch 695/700 --- Train cost:0.3932508 --- Test cost:0.2353068</span>
<span class="c1">## 0.3-0.2  run 2 - epoch 695/700 --- Train cost:0.392473 --- Test cost:0.20580922</span>
<span class="c1">## 0.7-0.7  run 0 - epoch 695/700 --- Train cost:0.3922218 --- Test cost:0.2057379</span>
</pre></div>
</div>
<p>通过在训练时对模型的参数们进行随机dropout方式,能够预防模型的过拟合问题,不过需要对dropout的概率进行合适的设计,不然也会导致模型训练结果不佳。</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install.html" class="btn btn-neutral float-left" title="VQNet 安装步骤" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="qml_demo.html" class="btn btn-neutral float-right" title="使用pyQPanda2的量子机器学习示例" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Original Quantum.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>