

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>使用pyQPanda2的量子机器学习示例 &mdash; VQNET v2.15.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/documentation_options.js?v=a149e6fc"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="QTensor 模块" href="QTensor.html" />
    <link rel="prev" title="使用自动微分模拟的量子机器学习示例" href="vqc_demo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VQNET
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">安装介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">VQNet 安装步骤</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">上手实例</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="vqc_demo.html">使用自动微分模拟的量子机器学习示例</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">使用pyQPanda2的量子机器学习示例</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">带参量子线路在分类任务的应用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#qvc">1. QVC示例</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">量子线路</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">模型构建</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">模型训练和测试</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-re-uploading">2. Data Re-uploading模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vsql-variational-shadow-quantum-learning-for-classification">3. VSQL: Variational Shadow Quantum Learning for Classification模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quanvolution">4.Quanvolution进行图像分类</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id5">量子自编码器模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">1.量子自编码器</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id7">量子线路结构学习</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">1.量子线路结构学习</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id9">量子经典神经网络混合模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">1.混合量子经典神经网络模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">数据准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">构建量子线路</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">构建混合量子神经网络</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">训练和测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">数据可视化</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id16">2.混合量子经典迁移学习模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qunet">3.混合量子经典的QUnet网络模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id18">数据准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">构建量子线路</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">构建混合经典量子神经网络</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">训练和模型保存</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">数据可视化</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#qmlp">4.混合量子经典的QMLP网络模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id24">构建混合经典量子神经网络</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">数据结果</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#qdrl">5.混合量子经典的QDRL网络模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id27">构建混合经典量子神经网络</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">数据结果</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id29">无监督学习</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#quantum-kmeans">1.Quantum Kmeans</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id30">1.1介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">1.2算法原理介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vqnet">1.3 VQNet实现</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id39">量子机器学习研究</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fourier-series">量子模型拟合fourier series算法</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pauli">1.1用串行Pauli旋转编码拟合傅里叶级数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id40">1.2用并行Pauli旋转编码拟合傅里叶级数</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id41">量子线路表达能力</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id42">贫瘠高原现象</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id43">量子感知机</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id44">随机参数偏移算法</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id45">双随机梯度下降</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id47">基于梯度的剪枝</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id48">在VQNet使用量子计算层进行模型训练</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vqnetquantumlayer">在VQNet中使用QuantumLayer进行模型训练</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vqnetnoisequantumlayer">在VQNet中使用NoiseQuantumLayer进行模型训练</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">经典神经网络接口介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="QTensor.html">QTensor 模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="nn.html">经典神经网络模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">实用函数</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用pyqpanda的量子神经网络接口</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="qnn.html">使用pyQPanda2量子机器学习模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="qnn_pq3.html">使用pyQPanda3量子机器学习模块</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">量子神经网络自动微分模拟接口</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="vqc.html">变分量子线路自动微分模拟</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">量子大模型微调</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="llm.html">量子大模型微调示例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">其他</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="torch_api.html">VQNet使用torch进行底层计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">VQNet Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VQNET</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">使用pyQPanda2的量子机器学习示例</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/rst/qml_demo.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pyqpanda2">
<h1>使用pyQPanda2的量子机器学习示例<a class="headerlink" href="#pyqpanda2" title="Link to this heading">¶</a></h1>
<p>我们这里使用VQNet以及pyQPanda2实现了多个量子机器学习示例。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>以下接口的量子计算部分使用pyqpanda2 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">https://pyqpanda-toturial.readthedocs.io/zh/latest/</a>。</p>
<p>由于pyqpanda2以及pyqpanda3兼容性问题,您需要自行安装pyqpnda2, <cite>pip install pyqpanda</cite></p>
</div>
<section id="id1">
<h2>带参量子线路在分类任务的应用<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<section id="qvc">
<h3>1. QVC示例<a class="headerlink" href="#qvc" title="Link to this heading">¶</a></h3>
<p>这个例子使用VQNet实现了论文 <a class="reference external" href="https://arxiv.org/pdf/1804.00633.pdf">Circuit-centric quantum classifiers</a> 中可变量子线路进行二分类任务。
该例子用来判断一个二进制数是奇数还是偶数。通过将二进制数编码到量子比特上,通过优化线路中的可变参数,使得该线路z方向测量值可以指示该输入为奇数还是偶数。</p>
<section id="id2">
<h4>量子线路<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h4>
<p>变分量子线路通常定义一个子线路,这是一种基本的电路架构,可以通过重复层构建复杂变分电路。
我们的电路层由多个旋转逻辑门以及将每个量子位与其相邻的量子位纠缠在一起的 <code class="docutils literal notranslate"><span class="pre">CNOT</span></code> 逻辑门组成。
我们还需要一个线路将经典数据编码到量子态上,使得线路测量的输出与输入有关联。
本例中,我们把二进制输入编码到对应顺序的量子比特上。例如输入数据1101被编码到4个量子比特。</p>
<div class="math notranslate nohighlight">
\[x = 0101 \rightarrow|\psi\rangle=|0101\rangle\]</div>
<a class="reference internal image-reference" href="../_images/qvc_circuit.png"><img alt="../_images/qvc_circuit.png" class="align-center" src="../_images/qvc_circuit.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>

<span class="k">def</span><span class="w"> </span><span class="nf">qvc_circuits</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">qlist</span><span class="p">,</span><span class="n">clist</span><span class="p">,</span><span class="n">machine</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">):</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">nqubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">cir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_circult</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
            <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">circult</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">basisstate</span><span class="p">():</span>
            <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">circult</span>

        <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">basisstate</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">weights_i</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)):</span>
                <span class="n">weights_j</span> <span class="o">=</span> <span class="n">weights_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span><span class="n">nqubits</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">cnots</span> <span class="o">=</span> <span class="n">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cnots</span><span class="p">)</span>

        <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
        <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circult</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prog</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">build_circult</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">qlist</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_dict</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">prob</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>模型构建<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h4>
<p>我们已经定义了可变量子线路 <code class="docutils literal notranslate"><span class="pre">qvc_circuits</span></code> 。我们希望将其用于我们VQNet的自动微分逻辑中,并使用VQNet的优化算法进行模型训练。我们定义了一个 Model 类,该类继承于抽象类 <code class="docutils literal notranslate"><span class="pre">Module</span></code>。
Model中使用 <a class="reference internal" href="qnn.html#quantumlayer"><span class="std std-ref">QuantumLayer</span></a> 类这个可进行自动微分的量子计算层。<code class="docutils literal notranslate"><span class="pre">qvc_circuits</span></code> 为我们希望运行的量子线路,24 为所有需要训练的量子线路参数的个数,”cpu” 表示这里使用 pyqpanda 的 全振幅模拟器,4表示需要申请4个量子比特。
在 <code class="docutils literal notranslate"><span class="pre">forward()</span></code> 函数中,用户定义了模型前向运行的逻辑。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.sgd</span><span class="w"> </span><span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span> <span class="k">as</span> <span class="n">dataloader</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">qvc_circuits</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id4">
<h4>模型训练和测试<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h4>
<p>我们使用预先生成的随机二进制数以及其奇数偶数标签。其中数据如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">qvc_train_data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">qvc_test_data</span><span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="n">dataset_str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dataset_str</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_train_data</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_test_data</span><span class="p">)</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span>
</pre></div>
</div>
<p>接着就可以按照一般神经网络训练的模式进行模型前传,损失函数计算,反向运算,优化器运算,直到迭代次数达到预设值。
其所使用的训练数据是上述生成的qvc_train_data,测试数据为qvc_test_data。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="n">result</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="c1">#示例化Model类</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="c1">#定义优化器,此处需要传入model.parameters()表示模型中所有待训练参数,lr为学习率</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span><span class="n">lr</span> <span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c1">#训练时候可以修改批处理的样本数</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1">#训练最大迭代次数</span>
<span class="n">epoch</span> <span class="o">=</span> <span class="mi">20</span>
<span class="c1">#模型损失函数</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">datas</span><span class="p">,</span><span class="n">labels</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">accuary</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">data</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">(</span><span class="n">datas</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">batch_size</span><span class="p">,</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">data</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">loss_b</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="n">loss_b</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
        <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss_b</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">count</span><span class="o">+=</span><span class="n">batch_size</span>
        <span class="n">accuary</span> <span class="o">+=</span> <span class="n">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, #### loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> #####accuray:</span><span class="si">{</span><span class="n">accuary</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">test_data</span><span class="p">,</span><span class="n">test_label</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">test_batch_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">accuary</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">testd</span><span class="p">,</span><span class="n">testl</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span><span class="n">test_label</span><span class="p">,</span><span class="n">test_batch_size</span><span class="p">):</span>
    <span class="n">testd</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">testd</span><span class="p">)</span>
    <span class="n">test_result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">testd</span><span class="p">)</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">testl</span><span class="p">,</span><span class="n">test_result</span><span class="p">)</span>
    <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">test_loss</span>
    <span class="n">count</span><span class="o">+=</span><span class="n">test_batch_size</span>
    <span class="n">accuary</span> <span class="o">+=</span> <span class="n">get_accuary</span><span class="p">(</span><span class="n">test_result</span><span class="p">,</span><span class="n">testl</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test:---------------&gt;loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> #####accuray:</span><span class="si">{</span><span class="n">accuary</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">epoch</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="c1">#### loss:0.20194714764753977 #####accuray:0.6666666666666666</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#### loss:0.19724808633327484 #####accuray:0.8333333333333334</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="c1">#### loss:0.19266503552595773 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="c1">#### loss:0.18812804917494455 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="c1">#### loss:0.1835678368806839 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="c1">#### loss:0.1789149840672811 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="c1">#### loss:0.17410411685705185 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="c1">#### loss:0.16908332953850427 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="c1">#### loss:0.16382796317338943 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="c1">#### loss:0.15835540741682053 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#### loss:0.15273457020521164 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span> <span class="c1">#### loss:0.14708336691061655 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="c1">#### loss:0.14155150949954987 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">13</span><span class="p">,</span> <span class="c1">#### loss:0.1362930883963903 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span> <span class="c1">#### loss:0.1314386005202929 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span> <span class="c1">#### loss:0.12707658857107162 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="c1">#### loss:0.123248390853405 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">17</span><span class="p">,</span> <span class="c1">#### loss:0.11995399743318558 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">18</span><span class="p">,</span> <span class="c1">#### loss:0.1171633576353391 #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">19</span><span class="p">,</span> <span class="c1">#### loss:0.11482855677604675 #####accuray:1.0</span>
<span class="p">[</span><span class="mf">0.3412148654</span><span class="p">]</span>
<span class="n">test</span><span class="p">:</span><span class="o">---------------&gt;</span><span class="n">loss</span><span class="p">:</span><span class="n">QTensor</span><span class="p">(</span><span class="mf">0.3412148654</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#####accuray:1.0</span>
</pre></div>
</div>
<p>模型在测试数据上准确率变化情况:</p>
<a class="reference internal image-reference" href="../_images/qvc_accuracy.png"><img alt="../_images/qvc_accuracy.png" class="align-center" src="../_images/qvc_accuracy.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="data-re-uploading">
<h3>2. Data Re-uploading模型<a class="headerlink" href="#data-re-uploading" title="Link to this heading">¶</a></h3>
<p>在神经网络中,每一个神经元都接受来自上层所有神经元的信息(图a)。与之相对的,单比特量子分类器接受上一个的信息处理单元和输入(图b)。
通俗地来说,对于传统的量子线路来说,当数据上传完成,可以直接通过若干幺正变换 <span class="math notranslate nohighlight">\(U(\theta_1,\theta_2,\theta_3)\)</span> 直接得到结果。
但是在量子数据重上传(Quantum Data Re-upLoading,QDRL)任务中,数据在幺正变换之前需要进行重新上传操作。</p>
<blockquote>
<div><p class="centered">
<strong>QDRL与经典神经网络原理图对比</strong></p></div></blockquote>
<a class="reference internal image-reference" href="../_images/qdrl.png"><img alt="../_images/qdrl.png" class="align-center" src="../_images/qdrl.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parameterized quantum circuit for Quantum Data Re-upLoading</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.qdrl.vqnet_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">vmodel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">sgd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span> <span class="k">as</span> <span class="n">get_minibatch_data</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_layers</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pqc</span> <span class="o">=</span> <span class="n">vmodel</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pqc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">circle</span><span class="p">(</span><span class="n">samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)):</span>
    <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">data_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">data_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_y</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">reds</span> <span class="o">=</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">blues</span> <span class="o">=</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$x_1$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$x_2$&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_score</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">pred</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">sgd</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function for train qdrl model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">circle</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x_train</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>  <span class="c1"># 500*3</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training...........&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">get_minibatch_data</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">loss_fun</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
            <span class="n">losss</span> <span class="o">=</span> <span class="n">loss_fun</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

            <span class="n">losss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">accuracy</span> <span class="o">+=</span> <span class="n">get_score</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="n">loss</span> <span class="o">+=</span> <span class="n">losss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="c1"># print(f&quot;epoch:{i}, train_accuracy:{accuracy}&quot;)</span>
            <span class="c1"># print(f&quot;epoch:{i}, train_loss:{losss}&quot;)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, train_accuracy_for_each_batch:</span><span class="si">{</span><span class="n">accuracy</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, train_loss_for_each_batch:</span><span class="si">{</span><span class="n">loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">():</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start eval...................&quot;</span><span class="p">)</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">circle</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">test_accuracy</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x_test</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>

    <span class="k">for</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span> <span class="ow">in</span> <span class="n">get_minibatch_data</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                                    <span class="n">batch_size</span><span class="p">):</span>

        <span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">test_data</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">test_label</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="n">test_accuracy</span> <span class="o">+=</span> <span class="n">get_score</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">test_label</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test_accuracy:</span><span class="si">{</span><span class="n">test_accuracy</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">train</span><span class="p">()</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p>QDRL在测试数据上准确率变化情况:</p>
<a class="reference internal image-reference" href="../_images/qdrl_accuracy.png"><img alt="../_images/qdrl_accuracy.png" class="align-center" src="../_images/qdrl_accuracy.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="vsql-variational-shadow-quantum-learning-for-classification">
<h3>3. VSQL: Variational Shadow Quantum Learning for Classification模型<a class="headerlink" href="#vsql-variational-shadow-quantum-learning-for-classification" title="Link to this heading">¶</a></h3>
<p>使用可变量子线路构建2分类模型,在与相似参数精度的神经网络对比分类精度,两者精度相近。而量子线路的参数量远小于经典神经网络。
算法基于论文:<a class="reference external" href="https://arxiv.org/abs/2012.08288">Variational Shadow Quantum Learning for Classification Model</a>  复现。</p>
<p>VSQL量子整体模型如下:</p>
<a class="reference internal image-reference" href="../_images/vsql_model.PNG"><img alt="../_images/vsql_model.PNG" class="align-center" src="../_images/vsql_model.PNG" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>VSQL中各个量子比特上的局部量子线路图如下:</p>
<img alt="../_images/vsql_0.png" src="../_images/vsql_0.png" />
<img alt="../_images/vsql_1.png" src="../_images/vsql_1.png" />
<img alt="../_images/vsql_2.png" src="../_images/vsql_2.png" />
<img alt="../_images/vsql_3.png" src="../_images/vsql_3.png" />
<img alt="../_images/vsql_4.png" src="../_images/vsql_4.png" />
<img alt="../_images/vsql_5.png" src="../_images/vsql_5.png" />
<img alt="../_images/vsql_6.png" src="../_images/vsql_6.png" />
<img alt="../_images/vsql_7.png" src="../_images/vsql_7.png" />
<img alt="../_images/vsql_8.png" src="../_images/vsql_8.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parameterized quantum circuit for VSQL</span>

<span class="sd">&quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">AmplitudeEmbeddingCircuit</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>

    <span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
    <span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
    <span class="p">}</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download function for mnist dataset file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">circuits_of_vsql</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">qlist</span><span class="p">,</span> <span class="n">clist</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VSQL model of quantum circuits</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">subcir</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">qlist</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">,</span> <span class="n">n_start</span><span class="p">):</span>
            <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qsc</span><span class="p">):</span>
                <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qsc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">n_qsc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qsc</span><span class="p">):</span>
                    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">repeat</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>

            <span class="k">return</span> <span class="n">cir</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_pauli_str</span><span class="p">(</span><span class="n">n_start</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;X&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_start</span><span class="p">,</span> <span class="n">n_start</span> <span class="o">+</span> <span class="n">n_qsc</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">pauli_str</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

        <span class="n">f_i</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">origin_in</span> <span class="o">=</span> <span class="n">AmplitudeEmbeddingCircuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">qlist</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">n_qsc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">psd</span> <span class="o">=</span> <span class="n">get_pauli_str</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">)</span>
            <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">origin_in</span><span class="p">)</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">subcir</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">qlist</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">n_qsc</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span>
            <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
            <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

            <span class="n">f_ij</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">qlist</span><span class="p">)</span>
            <span class="n">f_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_ij</span><span class="p">)</span>
        <span class="n">f_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f_i</span>


    <span class="c1">#GLOBAL VAR</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">n_qsc</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>


    <span class="k">class</span><span class="w"> </span><span class="nc">QModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model of VSQL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vq</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">circuits_of_vsql</span><span class="p">,</span> <span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_qsc</span><span class="p">,</span>
                                <span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">n_qsc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vq</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">x</span>


    <span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load mnist data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
        <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
            <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
            <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

        <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

        <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
            <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                    <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">run_vsql</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VQSL MODEL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="p">)</span>
        <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="p">)</span>
        <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="n">x_train_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_test_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">x_train_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">240</span><span class="p">),</span>
                    <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_train_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">x_test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">240</span><span class="p">),</span>
                    <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

        <span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_test_list</span><span class="p">)</span>

        <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>

        <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model start&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">()</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">result_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./result/vqslrlt.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>

            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                    <span class="n">y_train</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">cceloss</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">cceloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

                <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">n_loss</span> <span class="o">+=</span> <span class="n">batch_size</span>
                <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; n_loss </span><span class="si">{</span><span class="n">n_loss</span><span class="si">}</span><span class="s2"> Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Evaluation</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>
                                    <span class="n">y_test</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="n">cceloss</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">cceloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">n_loss</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">model</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">done vqsl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

        <span class="n">run_vsql</span><span class="p">()</span>
</pre></div>
</div>
<p>VSQL在测试数据上准确率变化情况:</p>
<a class="reference internal image-reference" href="../_images/vsql_cacc.PNG"><img alt="../_images/vsql_cacc.PNG" class="align-center" src="../_images/vsql_cacc.PNG" style="width: 600px;" />
</a>
<a class="reference internal image-reference" href="../_images/vsql_closs.PNG"><img alt="../_images/vsql_closs.PNG" class="align-center" src="../_images/vsql_closs.PNG" style="width: 600px;" />
</a>
<a class="reference internal image-reference" href="../_images/vsql_qacc.PNG"><img alt="../_images/vsql_qacc.PNG" class="align-center" src="../_images/vsql_qacc.PNG" style="width: 600px;" />
</a>
<a class="reference internal image-reference" href="../_images/vsql_qloss.PNG"><img alt="../_images/vsql_qloss.PNG" class="align-center" src="../_images/vsql_qloss.PNG" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="quanvolution">
<h3>4.Quanvolution进行图像分类<a class="headerlink" href="#quanvolution" title="Link to this heading">¶</a></h3>
<p>在此示例中,我们实现了量子卷积神经网络,这是一种最初在论文 <a class="reference external" href="https://arxiv.org/abs/1904.04767">Quanvolutional Neural Networks: Powering Image Recognition with Quantum Circuits</a> 中介绍的方法。</p>
<p>类似经典卷积,Quanvolution有以下步骤:
输入图像的一小块区域,在我们的例子中是 2×2方形经典数据,嵌入到量子电路中。
在此示例中,这是通过将参数化旋转逻辑门应用于在基态中初始化的量子位来实现的。此处的卷积核由参考文献中提出的随机电路生成变分线路。
最后测量量子系统,获得经典期望值列表。
类似于经典的卷积层,每个期望值都映射到单个输出像素的不同通道。
在不同区域重复相同的过程,可以扫描完整的输入图像,生成一个输出对象,该对象将被构造为多通道图像。
为了进行分类任务,本例在Quanvolution获取测量值后,使用经典全连接层 <code class="docutils literal notranslate"><span class="pre">Linear</span></code> 进行分类任务。
与经典卷积的主要区别在于,Quanvolution可以生成高度复杂的内核,其计算至少在原则上是经典难处理的。</p>
<a class="reference internal image-reference" href="../_images/quanvo.png"><img alt="../_images/quanvo.png" class="align-center" src="../_images/quanvo.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Mnist数据集定义</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">NLL_Loss</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.qcnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Quanvolution</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>

<span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download function for mnist dataset file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load mnist data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
<p>模型定义与运行函数定义</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">QModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vq</span> <span class="o">=</span> <span class="n">Quanvolution</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">14</span> <span class="o">*</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vq</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>



<span class="k">def</span><span class="w"> </span><span class="nf">run_quanvolution</span><span class="p">():</span>

    <span class="n">digit</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">digit</span><span class="p">))</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>

    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">digit</span><span class="p">))</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model start&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">QModel</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">result_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;quanvolution.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="n">cceloss</span> <span class="o">=</span> <span class="n">NLL_Loss</span><span class="p">()</span>
    <span class="n">N_EPOCH</span> <span class="o">=</span> <span class="mi">15</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_EPOCH</span><span class="p">):</span>

        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="n">cceloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

            <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">n_loss</span> <span class="o">+=</span> <span class="n">batch_size</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span>

            <span class="n">correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;correct </span><span class="si">{</span><span class="n">correct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Evaluation</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>
                                <span class="n">y_test</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="n">cceloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">n_loss</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_loss</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">result_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">model</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">run_quanvolution</span><span class="p">()</span>
</pre></div>
</div>
<p>训练集、验证集损失,训练集、验证集分类准确率随Epoch 变换情况。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># epoch train_loss      train_accuracy eval_loss    eval_accuracy</span>
<span class="c1"># 1 0.2488900272846222      0.232   1.7297331787645818      0.39</span>
<span class="c1"># 2 0.12281704187393189     0.646   1.201728610806167       0.61</span>
<span class="c1"># 3 0.08001763761043548     0.772   0.8947569639235735      0.73</span>
<span class="c1"># 4 0.06211201059818268     0.83    0.777864265316166       0.74</span>
<span class="c1"># 5 0.052190632969141004    0.858   0.7291000287979841      0.76</span>
<span class="c1"># 6 0.04542196464538574     0.87    0.6764470228599384      0.8</span>
<span class="c1"># 7 0.04029472427070141     0.896   0.6153804161818698      0.79</span>
<span class="c1"># 8 0.03600500610470772     0.902   0.5644993982824963      0.81</span>
<span class="c1"># 9 0.03230033944547176     0.916   0.528938240573043       0.81</span>
<span class="c1"># 10        0.02912954458594322     0.93    0.5058713140769396      0.83</span>
<span class="c1"># 11        0.026443827204406262    0.936   0.49064547760412097     0.83</span>
<span class="c1"># 12        0.024144304402172564    0.942   0.4800815625616815      0.82</span>
<span class="c1"># 13        0.022141477409750223    0.952   0.4724775951183983      0.83</span>
<span class="c1"># 14        0.020372112181037665    0.956   0.46692863543197743     0.83</span>
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2>量子自编码器模型<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<section id="id6">
<h3>1.量子自编码器<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<p>经典的自动编码器是一种神经网络,可以在高维空间学习数据的高效低维表示。自动编码器的任务是,给定一个输入x,将x映射到一个低维点y,这样x就可以从y中恢复。
可以选择底层自动编码器网络的结构,以便在较小的维度上表示数据,从而有效地压缩输入。受这一想法的启发,量子自动编码器的模型来对量子数据执行类似的任务。
量子自动编码器被训练来压缩量子态的特定数据集,而经典的压缩算法无法使用。量子自动编码器的参数采用经典优化算法进行训练。
我们展示了一个简单的可编程线路的例子,它可以被训练成一个高效的自动编码器。我们在量子模拟的背景下应用我们的模型来压缩哈伯德模型和分子哈密顿量的基态。
该例子参考自 <a class="reference external" href="https://arxiv.org/pdf/1612.02806.pdf">Quantum autoencoders for efficient compression of quantum data</a> .</p>
<p>QAE量子线路:</p>
<a class="reference internal image-reference" href="../_images/QAE_Quantum_Cir.png"><img alt="../_images/QAE_Quantum_Cir.png" class="align-center" src="../_images/QAE_Quantum_Cir.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quantum AutoEncoder demo</span>



<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;../&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span>  <span class="n">fidelityLoss</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.qae.qae</span><span class="w"> </span><span class="kn">import</span> <span class="n">QAElayer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;You should use Python 3.x&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>

<span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;train_img&#39;</span><span class="p">:</span><span class="s1">&#39;train-images-idx3-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;train_label&#39;</span><span class="p">:</span><span class="s1">&#39;train-labels-idx1-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_img&#39;</span><span class="p">:</span><span class="s1">&#39;t10k-images-idx3-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_label&#39;</span><span class="p">:</span><span class="s1">&#39;t10k-labels-idx1-ubyte.gz&#39;</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-idx&#39;</span><span class="p">,</span> <span class="s1">&#39;.idx&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trash_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">total_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pqc</span> <span class="o">=</span> <span class="n">QAElayer</span><span class="p">(</span><span class="n">trash_num</span><span class="p">,</span> <span class="n">total_num</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pqc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>         <span class="c1"># 下载数据</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">struct</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;train-images.idx3-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;train-labels.idx1-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;t10k-images.idx3-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;t10k-labels.idx1-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">magic_nr</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">magic_nr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:</span> <span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run2</span><span class="p">():</span>
    <span class="c1">##load dataset</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">)</span>                      <span class="c1"># 下载训练数据</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>                                             <span class="c1"># 将数据进行归一化处理[0,1]</span>

    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">)</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">100</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="p">[</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="mi">10</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="p">[</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">encode_qubits</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">latent_qubits</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">trash_qubits</span> <span class="o">=</span> <span class="n">encode_qubits</span> <span class="o">-</span> <span class="n">latent_qubits</span>
    <span class="n">total_qubits</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">trash_qubits</span> <span class="o">+</span> <span class="n">encode_qubits</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model start&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">trash_qubits</span><span class="p">,</span> <span class="n">total_qubits</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;rlt.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">loss_list_test</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fidelity_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fidelity_val</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">running_fidelity_train</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">running_fidelity_val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span><span class="mi">5</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span>  <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span><span class="mf">0.5</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1">#shuffle batch rather than data</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">encode_qubits</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">trash_qubits</span><span class="p">]),</span> <span class="n">x</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">np_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">floss</span> <span class="o">=</span> <span class="n">fidelityLoss</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">floss</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">loss_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="n">running_fidelity_train</span> <span class="o">+=</span> <span class="n">np_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n_loss</span> <span class="o">+=</span> <span class="n">batch_size</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">loss_output</span> <span class="o">=</span> <span class="n">full_loss</span> <span class="o">/</span> <span class="n">n_loss</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">loss_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_output</span><span class="p">)</span>


        <span class="c1"># Evaluation</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">full_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">encode_qubits</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">trash_qubits</span><span class="p">]),</span><span class="n">x</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">floss</span> <span class="o">=</span> <span class="n">fidelityLoss</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">floss</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">loss_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">full_loss</span> <span class="o">+=</span> <span class="n">loss_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">running_fidelity_val</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">n_loss</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">loss_output</span> <span class="o">=</span> <span class="n">full_loss</span> <span class="o">/</span> <span class="n">n_loss</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">loss_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">loss_list_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_output</span><span class="p">)</span>

        <span class="n">fidelity_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_fidelity_train</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span>
        <span class="n">fidelity_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_fidelity_val</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span>

    <span class="n">figure_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;QAE-rate1.png&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_list</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_list_test</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;QAE&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epochs&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figure_path</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">F1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">F1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">model</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">run2</span><span class="p">()</span>
</pre></div>
</div>
<p>运行上述代码得到的QAE误差值,该loss为1/保真度,趋向于1表示保真度接近1。</p>
<a class="reference internal image-reference" href="../_images/qae_train_loss.png"><img alt="../_images/qae_train_loss.png" class="align-center" src="../_images/qae_train_loss.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="id7">
<h2>量子线路结构学习<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h2>
<section id="id8">
<h3>1.量子线路结构学习<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<p>在量子线路结构中,最经常使用的带参数的量子门就是RZ、RY、RX门,但是在什么情况下使用什么门是一个十分值得研究的问题,一种方法就是随机选择,但是这种情况很有可能达不到最好的效果。
Quantum circuit structure learning任务的核心目标就是找到最优的带参量子门组合。
这里的做法是这一组最优的量子逻辑门要使得目标函数(loss function)取得最小值。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quantum Circuits Strcture Learning Demo</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;../&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
<span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
<span class="n">nqbits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gen</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">qbits</span><span class="p">,</span> <span class="n">circuit</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">generators</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qbits</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">generators</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qbits</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qbits</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">circuits</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">circuit</span><span class="p">):</span>
    <span class="n">gen</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">generators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nqbits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">circuit</span><span class="p">)</span>
    <span class="n">gen</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">generators</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nqbits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">circuit</span><span class="p">)</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">nqbits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nqbits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prog</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ansatz1</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">QTensor</span><span class="p">,</span> <span class="n">generators</span><span class="p">):</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">circuits</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">circuit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Z0&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="n">nqbits</span><span class="p">),</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Y1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">nqbits</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ansatz2</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">QTensor</span><span class="p">,</span> <span class="n">generators</span><span class="p">):</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">circuits</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">circuit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;X0&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">nqbits</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">loss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">):</span>
    <span class="n">z</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ansatz1</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ansatz2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rotosolve</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">M_0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    rotosolve algorithm implementation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">m0_plus</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">generators</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">m0_minus</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">generators</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">M_0</span> <span class="o">-</span> <span class="n">m0_plus</span> <span class="o">-</span> <span class="n">m0_minus</span><span class="p">,</span>
                <span class="n">m0_plus</span> <span class="o">-</span> <span class="n">m0_minus</span><span class="p">)</span>  <span class="c1"># returns value in (-pi,pi]</span>
    <span class="n">params</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">cost</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">generators</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">optimal_theta_and_gen_helper</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find optimal varaibles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">m0</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">generators</span><span class="p">)</span>  <span class="c1">#init value</span>
    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]:</span>
        <span class="n">generators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="n">params_cost</span> <span class="o">=</span> <span class="n">rotosolve</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">m0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="ow">or</span> <span class="n">params_cost</span> <span class="o">&lt;=</span> <span class="n">params_opt_cost</span><span class="p">:</span>
            <span class="n">params_opt_d</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">params_opt_cost</span> <span class="o">=</span> <span class="n">params_cost</span>
            <span class="n">generators_opt_d</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="k">return</span> <span class="n">params_opt_d</span><span class="p">,</span> <span class="n">generators_opt_d</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rotoselect_cycle</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">,</span> <span class="n">generators</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">params</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">generators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimal_theta_and_gen_helper</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">generators</span>


<span class="n">params</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]))</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">generator</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">]</span>
<span class="n">generators</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
<span class="n">epoch</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">state_save</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="n">state_save</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">generators</span><span class="p">))</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">generators</span> <span class="o">=</span> <span class="n">rotoselect_cycle</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">generators</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimal generators are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">generators</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimal params are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
<span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">state_save</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;rotoselect&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;cycles&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;cost&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>运行上述代码得到的量子线路结构。可见为一个 <span class="math notranslate nohighlight">\(RX\)</span>,一个 <span class="math notranslate nohighlight">\(RY\)</span></p>
<a class="reference internal image-reference" href="../_images/final_quantum_circuit.png"><img alt="../_images/final_quantum_circuit.png" class="align-center" src="../_images/final_quantum_circuit.png" style="width: 600px;" />
</a>
<p>以及逻辑门中的参数 <span class="math notranslate nohighlight">\(\theta_1\)</span>, <span class="math notranslate nohighlight">\(\theta_2\)</span> 不同参数下的损失函数</p>
<a class="reference internal image-reference" href="../_images/loss3d.png"><img alt="../_images/loss3d.png" class="align-center" src="../_images/loss3d.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="id9">
<h2>量子经典神经网络混合模型<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h2>
<section id="id10">
<h3>1.混合量子经典神经网络模型<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h3>
<p>机器学习 (ML) 已成为一个成功的跨学科领域,旨在从数据中以数学方式提取可概括的信息。量子机器学习寻求利用量子力学原理来增强机器学习,反之亦然。
无论您的目标是通过将困难的计算外包给量子计算机来增强经典 ML 算法,还是使用经典 ML 架构优化量子算法——两者都属于量子机器学习 (QML) 的范畴。
在本章中,我们将探讨如何部分量化经典神经网络以创建混合量子经典神经网络。量子线路由量子逻辑门构成,这些逻辑门实现的量子计算被论文 <a class="reference external" href="https://arxiv.org/abs/1803.00745">Quantum Circuit Learning</a> 证明是可微分。因此研究者尝试将量子线路与经典神经网络模块放到一起同时进行混合量子经典机器学习任务的训练。
我们将编写一个简单的示例,使用VQNet实现一个神经网络模型训练任务。此示例的目的是展示VQNet的简便性,并鼓励 ML 从业者探索量子计算的可能性。</p>
<section id="id11">
<h4>数据准备<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h4>
<p>我们将使用 <a class="reference external" href="http://yann.lecun.com/exdb/mnist/">MNIST datasets</a> 这一神经网络最基础的手写数字数据库作为分类数据 。
我们首先加载MNIST并过滤包含0和1的数据样本。这些样本分为训练数据 training_data 和测试数据 testing_data,它们每条数据均为1*784的维度大小。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.conv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conv2D</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">activation</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.pooling</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxPool2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>

<span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;train_img&#39;</span><span class="p">:</span><span class="s1">&#39;train-images-idx3-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;train_label&#39;</span><span class="p">:</span><span class="s1">&#39;train-labels-idx1-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_img&#39;</span><span class="p">:</span><span class="s1">&#39;t10k-images-idx3-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_label&#39;</span><span class="p">:</span><span class="s1">&#39;t10k-labels-idx1-ubyte.gz&#39;</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-idx&#39;</span><span class="p">,</span> <span class="s1">&#39;.idx&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>         <span class="c1"># 下载数据</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">struct</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;train-images.idx3-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;train-labels.idx1-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;t10k-images.idx3-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;t10k-labels.idx1-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">magic_nr</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">magic_nr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:</span> <span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_select</span><span class="p">(</span><span class="n">train_num</span><span class="p">,</span> <span class="n">test_num</span><span class="p">):</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">)</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">)</span>
    <span class="c1"># Train Leaving only labels 0 and 1</span>
    <span class="n">idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">])</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Test Leaving only labels 0 and 1</span>
    <span class="n">idx_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">])</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span>

<span class="n">n_samples_show</span> <span class="o">=</span> <span class="mi">6</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_select</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_samples_show</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="k">for</span> <span class="n">img</span> <span class="p">,</span><span class="n">targets</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n_samples_show</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Labeled: 0&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">n_samples_show</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">img</span> <span class="p">,</span><span class="n">targets</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n_samples_show</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Labeled: 1&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n_samples_show</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">n_samples_show</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mnsit_data_examples.png"><img alt="../_images/mnsit_data_examples.png" class="align-center" src="../_images/mnsit_data_examples.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id12">
<h4>构建量子线路<a class="headerlink" href="#id12" title="Link to this heading">¶</a></h4>
<p>在本例中,我们使用本源量子的 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">pyqpanda</a>
定义了一个1量子比特的简单量子线路,该线路将经典神经网络层的输出作为输入,通过 <code class="docutils literal notranslate"><span class="pre">H</span></code>, <code class="docutils literal notranslate"><span class="pre">RY</span></code> 逻辑门进行量子数据编码,并计算z方向的哈密顿期望值作为输出。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="k">def</span><span class="w"> </span><span class="nf">circuit</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#pyqpanda 创建模拟器</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="c1">#pyqpanda 分配量子比特</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="c1">#pyqpanda 分配经典比特辅助测量</span>
    <span class="n">cbits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">cAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="c1">#构建线路</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">&lt;&lt;</span> <span class="n">measure_all</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">cbits</span><span class="p">)</span>

    <span class="c1">#运行量子程序</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">run_with_configuration</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">cbits</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">expectation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">states</span> <span class="o">*</span> <span class="n">probabilities</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expectation</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/hqcnn_quantum_cir.png"><img alt="../_images/hqcnn_quantum_cir.png" class="align-center" src="../_images/hqcnn_quantum_cir.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id13">
<h4>构建混合量子神经网络<a class="headerlink" href="#id13" title="Link to this heading">¶</a></h4>
<p>由于量子线路可以和经典神经网络一起进行自动微分的计算,
因此我们可以使用VQNet的2维卷积层 <code class="docutils literal notranslate"><span class="pre">Conv2D</span></code> ,池化层 <code class="docutils literal notranslate"><span class="pre">MaxPool2D</span></code> ,全连接层 <code class="docutils literal notranslate"><span class="pre">Linear</span></code> 以及刚才构建的量子线路circuit构建模型。
通过以下代码中继承于VQNet自动微分模块 <code class="docutils literal notranslate"><span class="pre">Module</span></code> 的 Net 以及 Hybrid 类的定义,以及模型前传函数 <code class="docutils literal notranslate"><span class="pre">forward()</span></code> 中对数据前向计算的定义,我们构建了一个可以自动微分的模型
将本例中MNIST的数据进行卷积,降维,量子编码,测量,获取分类任务所需的最终特征。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#量子计算层的前传和梯度计算函数的定义,其需要继承于抽象类Module</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Hybrid</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Hybrid quantum - Quantum layer definition &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Hybrid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="n">expectation_z</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[[</span><span class="n">expectation_z</span><span class="p">]]</span>
        <span class="n">requires_grad</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">requires_grad</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_backward</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Backward pass computation &quot;&quot;&quot;</span>
            <span class="n">input_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">shift_right</span> <span class="o">=</span> <span class="n">input_list</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_list</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span>
            <span class="n">shift_left</span> <span class="o">=</span> <span class="n">input_list</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_list</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span>

            <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_list</span><span class="p">)):</span>
                <span class="n">expectation_right</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">shift_right</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">expectation_left</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">shift_left</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="n">gradient</span> <span class="o">=</span> <span class="n">expectation_right</span> <span class="o">-</span> <span class="n">expectation_left</span>
                <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
            <span class="n">gradients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gradients</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">gradients</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QTensor</span><span class="o">.</span><span class="n">GraphNode</span><span class="p">(</span><span class="n">tensor</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">_backward</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="nb">input</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">)</span>

<span class="c1">#模型定义</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Net</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid</span> <span class="o">=</span> <span class="n">Hybrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c1"># 1 6 24 24</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c1"># 1 16 8 8</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># 1 256</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c1"># 1 64</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>    <span class="c1"># 1 1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/hqcnnmodel.PNG"><img alt="../_images/hqcnnmodel.PNG" class="align-center" src="../_images/hqcnnmodel.PNG" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id14">
<h4>训练和测试<a class="headerlink" href="#id14" title="Link to this heading">¶</a></h4>
<p>通过上面代码示例,我们已经定义了模型。与经典神经网络模型训练类似, 我们还需要做的是实例化该模型,定义损失函数以及优化器以及定义整个训练测试流程。
对于形如下图的混合神经网络模型,我们通过循环输入数据前向计算损失值,并在反向计算中自动计算出各个待训练参数的梯度,并使用优化器进行参数优化,直到迭代次数满足预设值。</p>
<a class="reference internal image-reference" href="../_images/hqcnnarch.PNG"><img alt="../_images/hqcnnarch.PNG" class="align-center" src="../_images/hqcnnarch.PNG" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_select</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">#实例化</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="c1">#使用Adam完成此任务就足够了,model.parameters()是模型需要计算的参数。</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
<span class="c1">#分类任务使用交叉熵函数</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>

<span class="c1">#训练次数</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">train_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_acc_list</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">val_acc_list</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_train</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="n">n_train</span> <span class="o">+=</span> <span class="n">batch_size</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
        <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>

    <span class="n">train_loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
    <span class="n">train_acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">val_loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
    <span class="n">val_acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_eval</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id15">
<h4>数据可视化<a class="headerlink" href="#id15" title="Link to this heading">¶</a></h4>
<p>训练和测试数据上的数据损失函数与准确率的可视化曲线。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">xrange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loss_list</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">figure_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;HQCNN LOSS.png&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span><span class="n">train_loss_list</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span><span class="n">val_loss_list</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;HQCNN&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epochs&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">step</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figure_path</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">figure_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;HQCNN Accuracy.png&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span><span class="n">train_acc_list</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span><span class="n">val_acc_list</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;HQCNN&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epochs&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">step</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figure_path</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/HQCNNLOSS.png"><img alt="../_images/HQCNNLOSS.png" class="align-center" src="../_images/HQCNNLOSS.png" style="width: 600px;" />
</a>
<a class="reference internal image-reference" href="../_images/HQCNNAccuracy.png"><img alt="../_images/HQCNNAccuracy.png" class="align-center" src="../_images/HQCNNAccuracy.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_samples_show</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_samples_show</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n_samples_show</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicted </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/eval_test.png"><img alt="../_images/eval_test.png" class="align-center" src="../_images/eval_test.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="id16">
<h3>2.混合量子经典迁移学习模型<a class="headerlink" href="#id16" title="Link to this heading">¶</a></h3>
<p>我们将一种称为迁移学习的机器学习方法应用于基于混合经典量子网络的图像分类器。我们将编写一个将pyQPanda2与VQNet集成的简单示例。
迁移学习是一种成熟的人工神经网络训练技术,它基于一般直觉,即如果预训练的网络擅长解决给定的问题,那么,只需一些额外的训练,它也可以用来解决一个不同但相关的问题。</p>
<blockquote>
<div><p class="centered">
<strong>量子部分线路图</strong></p></div></blockquote>
<a class="reference internal image-reference" href="../_images/QTransferLearning_cir.png"><img alt="../_images/QTransferLearning_cir.png" class="align-center" src="../_images/QTransferLearning_cir.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quantum Classic Nerual Network Transfer Learning demo</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.conv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conv2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.utils.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_parameters</span><span class="p">,</span> <span class="n">save_parameters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">activation</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.pooling</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxPool2D</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoftmaxCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.sgd</span><span class="w"> </span><span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>

<span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CNN</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classical CNN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu3</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                            <span class="n">output_channels</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relu4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool4</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span>
            <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load mnist data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>


<span class="n">train_size</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">eval_size</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">EPOCHES</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">def</span><span class="w"> </span><span class="nf">classcal_cnn_model_training</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load train data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropy</span><span class="p">()</span>

    <span class="n">epochs</span> <span class="o">=</span> <span class="n">EPOCHES</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">temp_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Forward pass</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># Calculating loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>  <span class="c1"># target output</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Backward pass</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># Optimize the weights</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>

        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">save_flag</span><span class="p">:</span>
            <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">save_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">)</span>
            <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp_loss</span> <span class="o">&gt;</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">save_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">n_samples_show</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_samples_show</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n_samples_show</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">classical_cnn_transferlearning_predict</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use test data to eval classic NN model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>

    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">()</span>

    <span class="n">model_parameter</span> <span class="o">=</span> <span class="n">load_parameters</span><span class="p">(</span><span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_parameter</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">n_samples_show</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_samples_show</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n_samples_show</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Number of qubits</span>
<span class="n">q_depth</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Depth of the quantum circuit (number of variational layers)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Q_H_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Layer of single-qubit Hadamard gates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubits</span><span class="p">):</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">circuit</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Q_RY_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Layer of parametrized qubit rotations around the y axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">element</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">circuit</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Q_entangling_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Layer of CNOTs followed by another shifted layer of CNOT.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In other words it should apply something like :</span>
    <span class="c1"># CNOT  CNOT  CNOT  CNOT...  CNOT</span>
    <span class="c1">#   CNOT  CNOT  CNOT...  CNOT</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nqubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">):</span>  <span class="c1"># Loop over even indices: i=0,2,...N-2</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nqubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">):</span>  <span class="c1"># Loop over odd indices:  i=1,3,...N-3</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">circuit</span>

<span class="k">def</span><span class="w"> </span><span class="nf">quantum_net</span><span class="p">(</span><span class="n">q_input_features</span><span class="p">,</span> <span class="n">q_weights_flat</span><span class="p">,</span> <span class="n">qubits</span><span class="p">,</span> <span class="n">cubits</span><span class="p">,</span>
                <span class="n">machine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The variational quantum circuit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">)</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>

    <span class="c1"># Reshape weights</span>
    <span class="n">q_weights</span> <span class="o">=</span> <span class="n">q_weights_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">q_depth</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">])</span>

    <span class="c1"># Start from state |+&gt; , unbiased w.r.t. |0&gt; and |1&gt;</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_H_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">))</span>

    <span class="c1"># Embed features in the quantum node</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_RY_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">q_input_features</span><span class="p">))</span>

    <span class="c1"># Sequence of trainable variational layers</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q_depth</span><span class="p">):</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_entangling_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">))</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_RY_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">q_weights</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

    <span class="c1"># Expectation values in the Z basis</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>

    <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">):</span>
        <span class="n">pauli_str</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="n">pauli_map</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">PauliOperator</span><span class="p">(</span><span class="n">pauli_str</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">hamiltion</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="o">.</span><span class="n">toHamiltonian</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_expectation</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">hamiltion</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
        <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exp_vals</span>
<span class="k">def</span><span class="w"> </span><span class="nf">quantum_cnn_transferlearning</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The quantum cnn transferLearning model main function</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">class</span><span class="w"> </span><span class="nc">Q_DressedQuantumNet</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        module implementing the *dressed* quantum net.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Definition of the *dressed* layout.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_net</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_net</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qlayer</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">quantum_net</span><span class="p">,</span> <span class="n">q_depth</span> <span class="o">*</span> <span class="n">n_qubits</span><span class="p">,</span>
                                    <span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Defining how tensors are supposed to move through the *dressed* quantum</span>
<span class="sd">            net.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># obtain the input features for the quantum circuit</span>
            <span class="c1"># by reducing the feature dimension from 512 to 4</span>
            <span class="n">pre_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_net</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span>
            <span class="n">q_in</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">pre_out</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">q_out_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qlayer</span><span class="p">(</span><span class="n">q_in</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">q_out_elem</span>
            <span class="c1"># return the two-dimensional prediction from the postprocessing layer</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_net</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span>
                                <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  <span class="c1"># 下载训练数据</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">()</span>
    <span class="n">model_param</span> <span class="o">=</span> <span class="n">load_parameters</span><span class="p">(</span><span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_param</span><span class="p">)</span>

    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropy</span><span class="p">()</span>

    <span class="n">epochs</span> <span class="o">=</span> <span class="n">EPOCHES</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">eval_losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_hybrid</span> <span class="o">=</span> <span class="n">model</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model_hybrid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_hybrid</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Q_DressedQuantumNet</span><span class="p">()</span>

    <span class="n">optimizer_hybrid</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">temp_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                <span class="n">y_train</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">optimizer_hybrid</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Forward pass</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model_hybrid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>  <span class="c1"># target output</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Backward pass</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># Optimize the weights</span>
            <span class="n">optimizer_hybrid</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>

        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">save_flag</span><span class="p">:</span>
            <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                            <span class="s2">&quot;./result/QCNN_TL_FC3.model&quot;</span><span class="p">)</span>
            <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                            <span class="s2">&quot;./result/QCNN_TL_ALL.model&quot;</span><span class="p">)</span>
            <span class="n">save_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp_loss</span> <span class="o">&gt;</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                                <span class="s2">&quot;./result/QCNN_TL_FC3.model&quot;</span><span class="p">)</span>
                <span class="n">save_parameters</span><span class="p">(</span><span class="n">model_hybrid</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                                <span class="s2">&quot;./result/QCNN_TL_ALL.model&quot;</span><span class="p">)</span>

        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loss_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>
                                    <span class="n">y_test</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model_hybrid</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">np_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y1</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">loss_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np_loss</span><span class="p">)</span>
        <span class="n">eval_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_temp</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_eval</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> eval loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">eval_losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;model loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_list</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train_losses&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eval_losses</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;eval_losses&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;train_losses&quot;</span><span class="p">,</span> <span class="s2">&quot;eval_losses&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;qcnn_transfer_learning_classical&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">n_samples_show</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_samples_show</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n_samples_show</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model_hybrid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">quantum_cnn_transferlearning_predict</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Eval quantum cnn transferlearning model on test data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Number of qubits</span>
    <span class="n">q_depth</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Depth of the quantum circuit (number of variational layers)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Q_H_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Layer of single-qubit Hadamard gates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nqubits</span><span class="p">):</span>
            <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">circuit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Q_RY_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Layer of parametrized qubit rotations around the y axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">element</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">circuit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Q_entangling_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Layer of CNOTs followed by another shifted layer of CNOT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In other words it should apply something like :</span>
        <span class="c1"># CNOT  CNOT  CNOT  CNOT...  CNOT</span>
        <span class="c1">#   CNOT  CNOT  CNOT...  CNOT</span>
        <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nqubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">):</span>  <span class="c1"># Loop over even indices: i=0,2,...N-2</span>
            <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nqubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">):</span>  <span class="c1"># Loop over odd indices:  i=1,3,...N-3</span>
            <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">circuit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">quantum_net</span><span class="p">(</span><span class="n">q_input_features</span><span class="p">,</span> <span class="n">q_weights_flat</span><span class="p">,</span> <span class="n">qubits</span><span class="p">,</span> <span class="n">cubits</span><span class="p">,</span>
                    <span class="n">machine</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The variational quantum circuit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
        <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">)</span>
        <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>

        <span class="c1"># Reshape weights</span>
        <span class="n">q_weights</span> <span class="o">=</span> <span class="n">q_weights_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">q_depth</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">])</span>

        <span class="c1"># Start from state |+&gt; , unbiased w.r.t. |0&gt; and |1&gt;</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_H_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">))</span>

        <span class="c1"># Embed features in the quantum node</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_RY_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">q_input_features</span><span class="p">))</span>

        <span class="c1"># Sequence of trainable variational layers</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q_depth</span><span class="p">):</span>
            <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_entangling_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">))</span>
            <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Q_RY_layer</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">q_weights</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

        <span class="c1"># Expectation values in the Z basis</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
        <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
        <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="n">pauli_map</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">PauliOperator</span><span class="p">(</span><span class="n">pauli_str</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">hamiltion</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="o">.</span><span class="n">toHamiltonian</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_expectation</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">hamiltion</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
            <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">exp_vals</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Q_DressedQuantumNet</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        module implementing the *dressed* quantum net.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Definition of the *dressed* layout.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_net</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_net</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qlayer</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">quantum_net</span><span class="p">,</span> <span class="n">q_depth</span> <span class="o">*</span> <span class="n">n_qubits</span><span class="p">,</span>
                                    <span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Defining how tensors are supposed to move through the *dressed* quantum</span>
<span class="sd">            net.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># obtain the input features for the quantum circuit</span>
            <span class="c1"># by reducing the feature dimension from 512 to 4</span>
            <span class="n">pre_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_net</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span>
            <span class="n">q_in</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">pre_out</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">q_out_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qlayer</span><span class="p">(</span><span class="n">q_in</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">q_out_elem</span>
            <span class="c1"># return the two-dimensional prediction from the postprocessing layer</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_net</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span>
                                <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">2000</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">2000</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># The second method: unified storage and unified reading</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">()</span>
    <span class="n">model_hybrid</span> <span class="o">=</span> <span class="n">model</span>
    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Q_DressedQuantumNet</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_hybrid</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">model_param_quantum</span> <span class="o">=</span> <span class="n">load_parameters</span><span class="p">(</span><span class="s2">&quot;./result/QCNN_TL_ALL.model&quot;</span><span class="p">)</span>

    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_param_quantum</span><span class="p">)</span>
    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropy</span><span class="p">()</span>
    <span class="n">eval_losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">loss_temp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eval_batch_size</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>
                                <span class="n">y_test</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="n">eval_batch_size</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model_hybrid</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">np_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y1</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>

        <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">loss_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np_loss</span><span class="p">)</span>

    <span class="n">eval_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_temp</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_eval</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">eval_batch_size</span><span class="o">*</span><span class="n">n_eval</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">n_samples_show</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_samples_show</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">model_hybrid</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n_samples_show</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model_hybrid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result/QCNN_TL_1.model&quot;</span><span class="p">):</span>
        <span class="n">classcal_cnn_model_training</span><span class="p">()</span>
        <span class="n">classical_cnn_transferlearning_predict</span><span class="p">()</span>
    <span class="c1">#train quantum circuits.</span>

    <span class="n">quantum_cnn_transferlearning</span><span class="p">()</span>
    <span class="c1">#eval quantum circuits.</span>
    <span class="n">quantum_cnn_transferlearning_predict</span><span class="p">()</span>
</pre></div>
</div>
<p>训练集上Loss情况</p>
<a class="reference internal image-reference" href="../_images/qcnn_transfer_learning_classical.png"><img alt="../_images/qcnn_transfer_learning_classical.png" class="align-center" src="../_images/qcnn_transfer_learning_classical.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>测试集上运行分类情况</p>
<a class="reference internal image-reference" href="../_images/qcnn_transfer_learning_predict.png"><img alt="../_images/qcnn_transfer_learning_predict.png" class="align-center" src="../_images/qcnn_transfer_learning_predict.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="qunet">
<h3>3.混合量子经典的QUnet网络模型<a class="headerlink" href="#qunet" title="Link to this heading">¶</a></h3>
<p>图像分割（Image Segmeation）是计算机视觉研究中的一个经典难题,已经成为图像理解领域关注的一个热点,图像分割是图像分析的第一步,是计算机视觉的基础,
是图像理解的重要组成部分,同时也是图像处理中最困难的问题之一。所谓图像分割是指根据灰度、彩色、空间纹理、几何形状等特征把图像
划分成若干个互不相交的区域,使得这些特征在同一区域内表现出一致性或相似性,而在不同区域间表现出明显的不同。
简单而言就是给定一张图片,对图片上的每一个像素点分类。将不同分属不同物体的像素区域分开。 <a class="reference external" href="https://arxiv.org/abs/1505.04597">Unet</a> 是一种用于解决经典图像分割的算法。
在这里我们探索如何将经典神经网络部分量化,以创建适合量子数据的 <cite>QUnet - Quantum Unet</cite> 神经网络。我们将编写一个将 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">pyqpanda</a> 与 <cite>VQNet</cite> 集成的简单示例。
QUnet主要是用于解决图像分割的技术。</p>
<section id="id18">
<h4>数据准备<a class="headerlink" href="#id18" title="Link to this heading">¶</a></h4>
<p>我们将使用VOCdevkit/VOC2012官方库的数据: <a class="reference external" href="http://host.robots.ox.ac.uk/pascal/VOC/voc2012/#devkit">VOC2012</a> , 作为图像分割数据。
这些样本分为训练数据 training_data 和测试数据 testing_data,文件夹中包含images 和 labels。</p>
<a class="reference internal image-reference" href="../_images/Unet_data_imshow.png"><img alt="../_images/Unet_data_imshow.png" class="align-center" src="../_images/Unet_data_imshow.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id19">
<h4>构建量子线路<a class="headerlink" href="#id19" title="Link to this heading">¶</a></h4>
<p>在本例中,我们使用本源量子的 pyqpanda 定义了一个量子线路。将输入的3通道彩色图片数据压缩为单通道的灰度图片并进行存储,
再利用量子卷积操作对数据的特征进行提取降维操作。</p>
<a class="reference internal image-reference" href="../_images/qunet_cir.png"><img alt="../_images/qunet_cir.png" class="align-center" src="../_images/qunet_cir.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>导入必须的库和函数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.conv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">ConvT2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">activation</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.batch_norm</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchNorm2d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">BinaryCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.utils.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_parameters</span><span class="p">,</span> <span class="n">save_parameters</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
</pre></div>
</div>
<p>预处理数据</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#预处理数据</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PreprocessingData</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;/images&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_path</span><span class="p">)):</span>

            <span class="n">temp_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;/images&quot;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
            <span class="n">temp_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">temp_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
            <span class="n">grayimg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">temp_data</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="n">temp_data</span> <span class="o">=</span> <span class="n">grayimg</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">temp_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temp_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_data</span><span class="p">)</span>

            <span class="n">label_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;/labels&quot;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
            <span class="n">label_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">label_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>

            <span class="n">label_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">label_data</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="n">label_data</span> <span class="o">=</span> <span class="n">label_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">label_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="p">()</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_data</span><span class="p">)</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_label</span>

<span class="c1">#进行量子编码的线路</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QCNN_</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encode_cir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qlist</span><span class="p">,</span> <span class="n">pixels</span><span class="p">):</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pix</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pixels</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">pix</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">))</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">phi</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">entangle_cir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qlist</span><span class="p">):</span>
        <span class="n">k_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qlist</span><span class="p">)</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_size</span><span class="p">):</span>
            <span class="n">ctr</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">ctred</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">ctred</span> <span class="o">==</span> <span class="n">k_size</span><span class="p">:</span>
                <span class="n">ctred</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">ctr</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="n">ctred</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">cir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">qcnn_circuit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixels</span><span class="p">):</span>
        <span class="n">k_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">MPSQVM</span><span class="p">()</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
        <span class="n">qlist</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">k_size</span><span class="p">)</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>

        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode_cir</span><span class="p">(</span><span class="n">qlist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entangle_cir</span><span class="p">(</span><span class="n">qlist</span><span class="p">))</span>

        <span class="n">result0</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_list</span><span class="p">(</span><span class="n">cir</span><span class="p">,</span> <span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">result1</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_list</span><span class="p">(</span><span class="n">cir</span><span class="p">,</span> <span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_list</span><span class="p">(</span><span class="n">cir</span><span class="p">,</span> <span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">result3</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_list</span><span class="p">(</span><span class="n">cir</span><span class="p">,</span> <span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">result1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">result2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">result3</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">quanconv_</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convolves the input image with many applications of the same quantum circuit.&quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Process a squared 2x2 region of the image with a quantum circuit</span>
            <span class="n">q_results</span> <span class="o">=</span> <span class="n">QCNN_</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">qcnn_circuit</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">image</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">image</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">image</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">image</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_results</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">quantum_data_preprocessing</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
    <span class="n">quantum_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
        <span class="n">quantum_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quanconv_</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
    <span class="n">quantum_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">quantum_images</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quantum_images</span>
</pre></div>
</div>
</section>
<section id="id20">
<h4>构建混合经典量子神经网络<a class="headerlink" href="#id20" title="Link to this heading">¶</a></h4>
<p>我们按照Unet网络框架,使用 <cite>VQNet</cite> 框架搭建经典网络部分。下采样神经网络层用于降低维度,特征提取；
上采样神经网络层,用于恢复维度；上采样与下采样层之间通过concatenate进行连接,用于特征融合。</p>
<a class="reference internal image-reference" href="../_images/Unet.png"><img alt="../_images/Unet.png" class="align-center" src="../_images/Unet.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#下采样神经网络层的定义</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DownsampleLayer</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DownsampleLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">in_ch</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d1</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d2</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d3</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu3</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param x:</span>
<span class="sd">        :return: out(Output to deep),out_2(enter to next level),</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d1</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu1</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>
        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d2</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu2</span><span class="p">(</span><span class="n">x5</span><span class="p">)</span>
        <span class="n">x6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">x7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d3</span><span class="p">(</span><span class="n">x6</span><span class="p">)</span>
        <span class="n">out_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu3</span><span class="p">(</span><span class="n">x7</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">out_2</span>

<span class="c1">#上采样神经网络层的定义</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UpSampleLayer</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UpSampleLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">in_ch</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d1</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">out_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d2</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">ConvT2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">out_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                             <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d3</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu3</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param x: input conv layer</span>
<span class="sd">        :param out: connect with UpsampleLayer</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_out</span>

<span class="c1">#Unet整体网络架构</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UNet</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">out_channels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

        <span class="c1"># DownSampleLayer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d1</span> <span class="o">=</span> <span class="n">DownsampleLayer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 3-64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d2</span> <span class="o">=</span> <span class="n">DownsampleLayer</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 64-128</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d3</span> <span class="o">=</span> <span class="n">DownsampleLayer</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># 128-256</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d4</span> <span class="o">=</span> <span class="n">DownsampleLayer</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># 256-512</span>
        <span class="c1"># UpSampleLayer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u1</span> <span class="o">=</span> <span class="n">UpSampleLayer</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># 512-1024-512</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u2</span> <span class="o">=</span> <span class="n">UpSampleLayer</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># 1024-512-256</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u3</span> <span class="o">=</span> <span class="n">UpSampleLayer</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 512-256-128</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u4</span> <span class="o">=</span> <span class="n">UpSampleLayer</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 256-128-64</span>
        <span class="c1"># output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d1</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d2</span> <span class="o">=</span> <span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Relu2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Sigmoid</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out_1</span><span class="p">,</span> <span class="n">out1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out_2</span><span class="p">,</span> <span class="n">out2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">(</span><span class="n">out1</span><span class="p">)</span>
        <span class="n">out_3</span><span class="p">,</span> <span class="n">out3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3</span><span class="p">(</span><span class="n">out2</span><span class="p">)</span>
        <span class="n">out_4</span><span class="p">,</span> <span class="n">out4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d4</span><span class="p">(</span><span class="n">out3</span><span class="p">)</span>

        <span class="n">out5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u1</span><span class="p">(</span><span class="n">out4</span><span class="p">)</span>
        <span class="n">out5_pad_out4</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">pad2d</span><span class="p">(</span><span class="n">out5</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cat_out5</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">out5_pad_out4</span><span class="p">,</span> <span class="n">out_4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">out6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u2</span><span class="p">(</span><span class="n">cat_out5</span><span class="p">)</span>
        <span class="n">out6_pad_out_3</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">pad2d</span><span class="p">(</span><span class="n">out6</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cat_out6</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">out6_pad_out_3</span><span class="p">,</span> <span class="n">out_3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">out7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u3</span><span class="p">(</span><span class="n">cat_out6</span><span class="p">)</span>
        <span class="n">out7_pad_out_2</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">pad2d</span><span class="p">(</span><span class="n">out7</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cat_out7</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">out7_pad_out_2</span><span class="p">,</span> <span class="n">out_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">out8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u4</span><span class="p">(</span><span class="n">cat_out7</span><span class="p">)</span>
        <span class="n">out8_pad_out_1</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">pad2d</span><span class="p">(</span><span class="n">out8</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cat_out8</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">out8_pad_out_1</span><span class="p">,</span> <span class="n">out_1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">cat_out8</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BatchNorm2d2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Relu2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</section>
<section id="id21">
<h4>训练和模型保存<a class="headerlink" href="#id21" title="Link to this heading">¶</a></h4>
<p>通过上面代码示例,我们已经定义了模型。与经典神经网络模型训练类似, 我们还需要做的是实例化该模型,
定义损失函数以及优化器以及定义整个训练测试流程。 对于形如下图的混合神经网络模型,我们通过循环输入数据前向计算损失值,
并在反向计算中自动计算出各个待训练参数的梯度,并使用优化器进行参数优化,直到迭代次数满足预设值。
我们这里使用前面下载的VOC2012数据中选取100张作为训练集,10张作为测试集。训练集目录指定为 <cite>path0</cite>,测试集目录指定为 <cite>path1</cite>。
其中,图像以及其对应的标签图像都经过了量子卷积模块 <code class="docutils literal notranslate"><span class="pre">quantum_data_preprocessing</span></code> 进行预处理,我们Unet的训练目标是使得同时经过量子线路预处理的图像和标签尽可能贴近。
如果已经进行了量子化数据预处理,可以设置 <code class="docutils literal notranslate"><span class="pre">PREPROCESS</span></code> 为False。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PREPROCESS</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyDataset</span><span class="p">():</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">x_label</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_set</span> <span class="o">=</span> <span class="n">x_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">x_label</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_set</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">img_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">target_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">img_np</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target_np</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_set</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./Intermediate_results&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./Intermediate_results&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># prepare train/test data and label</span>
<span class="n">path0</span> <span class="o">=</span> <span class="s1">&#39;training_data&#39;</span>
<span class="n">path1</span> <span class="o">=</span> <span class="s1">&#39;testing_data&#39;</span>
<span class="n">train_images</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="n">PreprocessingData</span><span class="p">(</span><span class="n">path0</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span> <span class="o">=</span> <span class="n">PreprocessingData</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;train: &#39;</span><span class="p">,</span> <span class="n">train_images</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">test: &#39;</span><span class="p">,</span> <span class="n">test_images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;train: &#39;</span><span class="p">,</span> <span class="n">train_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">test: &#39;</span><span class="p">,</span> <span class="n">test_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">train_images</span> <span class="o">=</span> <span class="n">train_images</span> <span class="o">/</span> <span class="mi">255</span>
<span class="n">test_images</span> <span class="o">=</span> <span class="n">test_images</span> <span class="o">/</span> <span class="mi">255</span>

<span class="c1"># use quantum encoder to preprocess data</span>



<span class="k">if</span> <span class="n">PREPROCESS</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quantum pre-processing of train images:&quot;</span><span class="p">)</span>
    <span class="n">q_train_images</span> <span class="o">=</span> <span class="n">quantum_data_preprocessing</span><span class="p">(</span><span class="n">train_images</span><span class="p">)</span>
    <span class="n">q_test_images</span> <span class="o">=</span> <span class="n">quantum_data_preprocessing</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span>
    <span class="n">q_train_label</span> <span class="o">=</span> <span class="n">quantum_data_preprocessing</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
    <span class="n">q_test_label</span> <span class="o">=</span> <span class="n">quantum_data_preprocessing</span><span class="p">(</span><span class="n">test_labels</span><span class="p">)</span>

    <span class="c1"># Save pre-processed images</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Quantum Data Saving...&#39;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;./result/q_train.npy&quot;</span><span class="p">,</span> <span class="n">q_train_images</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;./result/q_test.npy&quot;</span><span class="p">,</span> <span class="n">q_test_images</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;./result/q_train_label.npy&quot;</span><span class="p">,</span> <span class="n">q_train_label</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;./result/q_test_label.npy&quot;</span><span class="p">,</span> <span class="n">q_test_label</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Quantum Data Saving Over!&#39;</span><span class="p">)</span>

<span class="c1"># loading quantum data</span>
<span class="n">SAVE_PATH</span> <span class="o">=</span> <span class="s2">&quot;./result/&quot;</span>
<span class="n">train_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">SAVE_PATH</span> <span class="o">+</span> <span class="s2">&quot;q_train.npy&quot;</span><span class="p">)</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">SAVE_PATH</span> <span class="o">+</span> <span class="s2">&quot;q_train_label.npy&quot;</span><span class="p">)</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">SAVE_PATH</span> <span class="o">+</span> <span class="s2">&quot;q_test.npy&quot;</span><span class="p">)</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">SAVE_PATH</span> <span class="o">+</span> <span class="s2">&quot;q_test_label.npy&quot;</span><span class="p">)</span>

<span class="n">train_x</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">test_x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="n">train_labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">test_labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">train_labels</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">test_labels</span>

<span class="n">trainset</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<span class="n">testset</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_label</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">UNet</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">BinaryCrossEntropy</span><span class="p">()</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">SAVE_FLAG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">temp_loss</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./result/result.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trainset</span><span class="p">):</span>
        <span class="n">x_img</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
        <span class="n">x_img_Qtensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x_img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">y_img</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
        <span class="n">y_img_Qtensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">y_img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">img_out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x_img_Qtensor</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;==========</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">==================&quot;</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y_img_Qtensor</span><span class="p">,</span> <span class="n">img_out</span><span class="p">)</span>  <span class="c1"># target output</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
            <span class="n">img_out_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s1">&#39;3.4.2&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_out_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_out_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
            <span class="n">y_img_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y_img_Qtensor</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s1">&#39;3.4.2&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_img_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_img_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;./Intermediate_results/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">)</span>

        <span class="n">loss_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2"> loss_data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">loss_data</span><span class="p">))</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
        <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_data</span><span class="p">)</span>

    <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
    <span class="n">out_read</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./result/result.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">out_read</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">out_read</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">out_read</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">SAVE_FLAG</span><span class="p">:</span>
        <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">save_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;./result/Q-Unet_End.model&quot;</span><span class="p">)</span>
        <span class="n">SAVE_FLAG</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">temp_loss</span> <span class="o">&gt;</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">temp_loss</span> <span class="o">=</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">save_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;./result/Q-Unet_End.model&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id22">
<h4>数据可视化<a class="headerlink" href="#id22" title="Link to this heading">¶</a></h4>
<p>训练数据的损失函数曲线显示保存,以及测试数据结果保存。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">out_read</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./result/result.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">lines_read</span> <span class="o">=</span> <span class="n">out_read</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="n">data_read</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines_read</span><span class="p">:</span>
    <span class="n">float_line</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">data_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">float_line</span><span class="p">)</span>
<span class="n">out_read</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_read</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Unet Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Training Iterations&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;./result/traing_loss.jpg&quot;</span><span class="p">)</span>

<span class="n">modela</span> <span class="o">=</span> <span class="n">load_parameters</span><span class="p">(</span><span class="s2">&quot;./result/Q-Unet_End.model&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------PREDICT-------------&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">modela</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">testset</span><span class="p">):</span>
    <span class="n">x_img</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
    <span class="n">x_img_Qtensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x_img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y_img</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
    <span class="n">y_img_Qtensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">y_img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">img_out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x_img_Qtensor</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y_img_Qtensor</span><span class="p">,</span> <span class="n">img_out</span><span class="p">)</span>
    <span class="n">loss_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> loss_eval: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loss_data</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
    <span class="n">img_out_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s1">&#39;3.4.2&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_out_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_out_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
    <span class="n">y_img_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y_img_Qtensor</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s1">&#39;3.4.2&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_img_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_img_tensor</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;./result/eval_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_1&quot;</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;end!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>训练集上Loss情况</p>
<a class="reference internal image-reference" href="../_images/qunet_train_loss.png"><img alt="../_images/qunet_train_loss.png" class="align-center" src="../_images/qunet_train_loss.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>可视化运行情况</p>
<a class="reference internal image-reference" href="../_images/qunet_eval_1.jpg"><img alt="../_images/qunet_eval_1.jpg" class="align-center" src="../_images/qunet_eval_1.jpg" style="width: 600px;" />
</a>
<a class="reference internal image-reference" href="../_images/qunet_eval_2.jpg"><img alt="../_images/qunet_eval_2.jpg" class="align-center" src="../_images/qunet_eval_2.jpg" style="width: 600px;" />
</a>
<a class="reference internal image-reference" href="../_images/qunet_eval_3.jpg"><img alt="../_images/qunet_eval_3.jpg" class="align-center" src="../_images/qunet_eval_3.jpg" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="qmlp">
<h3>4.混合量子经典的QMLP网络模型<a class="headerlink" href="#qmlp" title="Link to this heading">¶</a></h3>
<p>我们介绍并分析了提出了一种量子多层感知器 (QMLP) 架构,其特点是具有容错输入嵌入、丰富的非线性和带有参数化双量子比特纠缠门的增强变分电路模拟。<a class="reference external" href="https://arxiv.org/pdf/2206.01345.pdf">QMLP: An Error-Tolerant Nonlinear Quantum MLP Architecture using Parameterized Two-Qubit Gates</a> 。
我们将编写一个将 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">pyqpanda</a> 与 <cite>VQNet</cite> 集成的简单示例。</p>
<section id="id24">
<h4>构建混合经典量子神经网络<a class="headerlink" href="#id24" title="Link to this heading">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeanSquaredError</span><span class="p">,</span> <span class="n">CrossEntropyLoss</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span><span class="p">,</span> <span class="n">QuantumLayerMultiProcess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.pooling</span><span class="w"> </span><span class="kn">import</span> <span class="n">AvgPool2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You should use Python 3.x&quot;</span><span class="p">)</span>

<span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_img&quot;</span><span class="p">:</span> <span class="s2">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="s2">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_img&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download mnist data if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-idx&quot;</span><span class="p">,</span> <span class="s2">&quot;.idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load mnist data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;train-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-images.idx3-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;t10k-labels.idx1-ubyte&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span>
                                 <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_select</span><span class="p">(</span><span class="n">train_num</span><span class="p">,</span> <span class="n">test_num</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select data from mnist dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">)</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">)</span>
    <span class="n">idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">])</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Test Leaving only labels 0 and 1</span>
    <span class="n">idx_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">])</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span>

<span class="k">def</span><span class="w"> </span><span class="nf">RotCircuit</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">qlist</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Arbitrary single qubit rotation.Number of qlist should be 1,and number of parameters should</span>
<span class="sd">    be 3</span>

<span class="sd">    .. math::</span>

<span class="sd">        R(\phi,\theta,\omega) = RZ(\omega)RY(\theta)RZ(\phi)= \begin{bmatrix}</span>
<span class="sd">        e^{-i(\phi+\omega)/2}\cos(\theta/2) &amp; -e^{i(\phi-\omega)/2}\sin(\theta/2) \\</span>
<span class="sd">        e^{-i(\phi-\omega)/2}\sin(\theta/2) &amp; e^{i(\phi+\omega)/2}\cos(\theta/2)</span>
<span class="sd">        \end{bmatrix}.</span>


<span class="sd">    :param para: numpy array which represents paramters [\phi, \theta, \omega]</span>
<span class="sd">    :param qlist: qubits allocated by pyQpanda.qAlloc_many()</span>
<span class="sd">    :return: quantum circuits</span>

<span class="sd">    Example::</span>

<span class="sd">        m_machine = pq.init_quantum_machine(pq.QMachineType.CPU)</span>
<span class="sd">        m_clist = m_machine.cAlloc_many(2)</span>
<span class="sd">        m_prog = pq.QProg()</span>
<span class="sd">        m_qlist = m_machine.qAlloc_many(1)</span>
<span class="sd">        param = np.array([3,4,5])</span>
<span class="sd">        c = RotCircuit(param,m_qlist)</span>
<span class="sd">        print(c)</span>
<span class="sd">        pq.destroy_quantum_machine(m_machine)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">QTensor</span><span class="p">):</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">para</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; dim of paramters in Rot should be 1&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">para</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; numbers of paramters in Rot should be 3&quot;</span><span class="p">)</span>

    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">,</span> <span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">,</span> <span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">,</span> <span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_RotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">18</span><span class="p">:</span><span class="mi">21</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">24</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">27</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">30</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">33</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">33</span><span class="p">:</span><span class="mi">36</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">11</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">39</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">12</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">39</span><span class="p">:</span><span class="mi">42</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">13</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">45</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">14</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">45</span><span class="p">:</span><span class="mi">48</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">15</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CRXCircuit</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">control_qlists</span><span class="p">,</span> <span class="n">rot_qlists</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">rot_qlists</span><span class="p">,</span> <span class="n">para</span><span class="p">))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">set_control</span><span class="p">(</span><span class="n">control_qlists</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_CRotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">11</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">12</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">13</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">14</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">15</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">CRXCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">cir</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_qmlp_circuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">qubits</span><span class="p">,</span> <span class="n">clist</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_RotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">48</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_CRotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">48</span><span class="p">:</span><span class="mi">64</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_RotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">112</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_CRotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">112</span><span class="p">:</span><span class="mi">128</span><span class="p">]))</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>
    <span class="c1"># print(prog)</span>
    <span class="c1"># exit()</span>

    <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">pauli_str</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
        <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exp_vals</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_multiprocess_qmlp_circuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">,</span> <span class="n">num_clist</span><span class="p">):</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_RotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">48</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_CRotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">48</span><span class="p">:</span><span class="mi">64</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_RotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">112</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">build_CRotCircuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">112</span><span class="p">:</span><span class="mi">128</span><span class="p">]))</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>
    <span class="c1"># print(prog)</span>
    <span class="c1"># exit()</span>

    <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">pauli_str</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
        <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exp_vals</span>

<span class="k">class</span><span class="w"> </span><span class="nc">QMLPModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QMLPModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ave_pool2d</span> <span class="o">=</span> <span class="n">AvgPool2D</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="c1"># self.quantum_circuit = QuantumLayer(build_qmlp_circuit, 128, &quot;CPU&quot;, 16, diff_method=&quot;finite_diff&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span> <span class="o">=</span> <span class="n">QuantumLayerMultiProcess</span><span class="p">(</span><span class="n">build_multiprocess_qmlp_circuit</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span>
                                                        <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">diff_method</span><span class="o">=</span><span class="s2">&quot;finite_diff&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">bsz</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ave_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">bsz</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
        <span class="n">quanutum_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">quanutum_result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">vqnet_test_QMLPModel</span><span class="p">():</span>
    <span class="c1"># train num=1000, test_num=100</span>
    <span class="c1"># x_train, y_train, x_test, y_test = data_select(1000, 100)</span>

    <span class="n">train_size</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">eval_size</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="n">eval_size</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">QMLPModel</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_train</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                                   <span class="n">y_train</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                   <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Forward pass</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># Calculating loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loss: &quot;</span><span class="p">,</span> <span class="n">loss_np</span><span class="p">)</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">temp_out</span> <span class="o">=</span> <span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">temp_out</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">temp_output</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">temp_out</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">temp_out</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">temp_maks</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_output</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span>

            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp_maks</span><span class="p">))</span>
            <span class="n">n_train</span> <span class="o">+=</span> <span class="mi">160</span>

            <span class="c1"># Backward pass</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># Optimize the weights</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;##########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="c1"># train_acc_list.append(correct / n_train)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch: &quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="c1"># print(100. * (epoch + 1) / epochs)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">vqnet_test_QMLPModel</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id25">
<h4>数据结果<a class="headerlink" href="#id25" title="Link to this heading">¶</a></h4>
<p>训练数据的损失函数曲线显示保存,以及测试数据结果保存。
训练集上Loss情况</p>
<a class="reference internal image-reference" href="../_images/QMLP.png"><img alt="../_images/QMLP.png" class="align-center" src="../_images/QMLP.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="qdrl">
<h3>5.混合量子经典的QDRL网络模型<a class="headerlink" href="#qdrl" title="Link to this heading">¶</a></h3>
<p>我们介绍并分析了提出了一种量子强化学习网络 (QDRL) ,其特点将经典的深度强化学习算法（如经验回放和目标网络）重塑为变分量子电路的表示。
此外,与经典神经网络相比,我们使用量子信息编码方案来减少模型参数的数量。 <a class="reference external" href="https://arxiv.org/pdf/1907.00397.pdf">QDRL: Variational Quantum Circuits for Deep Reinforcement Learning</a> 。
我们将编写一个将 <a class="reference external" href="https://pyqpanda-toturial.readthedocs.io/zh/latest/">pyqpanda</a> 与 <cite>VQNet</cite> 集成的简单示例。</p>
<section id="id27">
<h4>构建混合经典量子神经网络<a class="headerlink" href="#id27" title="Link to this heading">¶</a></h4>
<p>需要安装 <code class="docutils literal notranslate"><span class="pre">gym</span></code> == 0.23.0 , <code class="docutils literal notranslate"><span class="pre">pygame</span></code> == 2.1.2 。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gym</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">animation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeanSquaredError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet</span><span class="w"> </span><span class="kn">import</span> <span class="n">kfloat32</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayerMultiProcess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet._core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span> <span class="k">as</span> <span class="n">CoreTensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">display_frames_as_gif</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">c_index</span><span class="p">):</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">(),</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">name_result</span> <span class="o">=</span> <span class="s2">&quot;./result_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c_index</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.gif&quot;</span>
    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name_result</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">CIRCUIT_SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">MAX_STEPS</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">BATCHSIZE</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">TARGET_MAX</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">GAMMA</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">STATE_T</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ACTION</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">REWARD</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">STATE_NT</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">DONE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">def</span><span class="w"> </span><span class="nf">RotCircuit</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">qlist</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arbitrary single qubit rotation.Number of qlist should be 1,and number of parameters should</span>
<span class="sd">    be 3</span>
<span class="sd">    .. math::</span>
<span class="sd">        R(\phi,\theta,\omega) = RZ(\omega)RY(\theta)RZ(\phi)= \begin{bmatrix}</span>
<span class="sd">        e^{-i(\phi+\omega)/2}\cos(\theta/2) &amp; -e^{i(\phi-\omega)/2}\sin(\theta/2) \\</span>
<span class="sd">        e^{-i(\phi-\omega)/2}\sin(\theta/2) &amp; e^{i(\phi+\omega)/2}\cos(\theta/2)</span>
<span class="sd">        \end{bmatrix}.</span>
<span class="sd">    :param para: numpy array which represents paramters [\phi, \theta, \omega]</span>
<span class="sd">    :param qlist: qubits allocated by pyQpanda.qAlloc_many()</span>
<span class="sd">    :return: quantum circuits</span>
<span class="sd">    Example::</span>
<span class="sd">        m_machine = pq.init_quantum_machine(pq.QMachineType.CPU)</span>
<span class="sd">        m_clist = m_machine.cAlloc_many(2)</span>
<span class="sd">        m_prog = pq.QProg()</span>
<span class="sd">        m_qlist = m_machine.qAlloc_many(1)</span>
<span class="sd">        param = np.array([3,4,5])</span>
<span class="sd">        c = RotCircuit(param,m_qlist)</span>
<span class="sd">        print(c)</span>
<span class="sd">        pq.destroy_quantum_machine(m_machine)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">QTensor</span><span class="p">):</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">para</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; dim of paramters in Rot should be 1&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">para</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; numbers of paramters in Rot should be 3&quot;</span><span class="p">)</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">,</span> <span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">,</span> <span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">,</span> <span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">cir</span>
<span class="k">def</span><span class="w"> </span><span class="nf">layer_circuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="c1"># Entanglement block</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1"># u3 gate</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># weights shape = [4, 3]</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">RotCircuit</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">cir</span>
<span class="k">def</span><span class="w"> </span><span class="nf">encoder</span><span class="p">(</span><span class="n">encodings</span><span class="p">):</span>
    <span class="n">encodings</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">encodings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">encodings</span><span class="si">:</span><span class="s1">0</span><span class="si">{</span><span class="n">CIRCUIT_SIZE</span><span class="si">}</span><span class="s1">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_qc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">,</span> <span class="n">num_clist</span><span class="p">):</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">wires</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="n">wires</span><span class="p">:</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">wire</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">wire</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="c1"># parameter number = 24</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="c1"># layer wise</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">layer_circuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>
    <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">pauli_str</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
        <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exp_vals</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DRLModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DRLModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span> <span class="o">=</span> <span class="n">QuantumLayerMultiProcess</span><span class="p">(</span><span class="n">build_qc</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
                                                        <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">diff_method</span><span class="o">=</span><span class="s2">&quot;finite_diff&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">quanutum_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantum_circuit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">quanutum_result</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;FrozenLake-v1&quot;</span><span class="p">,</span> <span class="n">is_slippery</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">map_name</span> <span class="o">=</span> <span class="s1">&#39;4x4&#39;</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">n_layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">targ_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sampled_vs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">memory</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_layers</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<span class="n">param_targ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">bias_targ</span> <span class="o">=</span> <span class="n">bias</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DRLModel</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_ITERATIONS</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">state_t</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">a_init</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_STEPS</span><span class="p">):</span>
        <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rgb_array&#39;</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">input_x</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">state_t</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
        <span class="n">acts</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_x</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias</span>
        <span class="c1"># print(f&#39;type of acts: {type(acts)}&#39;)</span>
        <span class="n">act_t</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>
        <span class="c1"># print(f&#39;act_t: {act_t} type of act_t: {type(act_t)}&#39;)</span>
        <span class="n">act_t_np</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">act_t</span><span class="o">.</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Episode: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, Steps: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">, act: </span><span class="si">{</span><span class="n">act_t_np</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">state_nt</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">act_t_np</span><span class="p">)</span>
        <span class="n">targ_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">input_state_nt</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">state_nt</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
        <span class="n">act_nt</span> <span class="o">=</span> <span class="n">QTensor</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">input_state_nt</span><span class="p">)</span><span class="o">+</span><span class="n">bias</span><span class="p">)</span>
        <span class="n">act_nt_np</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">act_nt</span><span class="o">.</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">state_t</span><span class="p">,</span> <span class="n">act_t</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">state_nt</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">BATCHSIZE</span><span class="p">:</span>
            <span class="c1"># print(&#39;Optimizing...&#39;)</span>
            <span class="n">sampled_vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">memory</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">memory</span><span class="p">),</span> <span class="n">BATCHSIZE</span><span class="p">)]</span>
            <span class="n">target_temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sampled_vs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">DONE</span><span class="p">]:</span>
                    <span class="n">target_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QTensor</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">REWARD</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_s</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">s</span><span class="p">[</span><span class="n">STATE_NT</span><span class="p">]]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
                    <span class="n">out_temp</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">REWARD</span><span class="p">]</span> <span class="o">+</span> <span class="n">GAMMA</span> <span class="o">*</span> <span class="n">tensor</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">input_s</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias_targ</span><span class="p">)</span>
                    <span class="n">out_temp</span> <span class="o">=</span> <span class="n">out_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">target_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_temp</span><span class="p">)</span>
            <span class="n">target_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">sampled_vs</span><span class="p">:</span>
                <span class="n">input_b</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">b</span><span class="p">[</span><span class="n">STATE_T</span><span class="p">]]],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">kfloat32</span><span class="p">)</span>
                <span class="n">out_result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_b</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">ACTION</span><span class="p">]</span><span class="o">.</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">out_result_temp</span> <span class="o">=</span> <span class="n">out_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">target_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_result_temp</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">target_label</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">target_temp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">target_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">target_label</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># update parameters in target circuit</span>
        <span class="k">if</span> <span class="n">targ_counter</span> <span class="o">==</span> <span class="n">TARGET_MAX</span><span class="p">:</span>
            <span class="n">param_targ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bias_targ</span> <span class="o">=</span> <span class="n">bias</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">targ_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">state_t</span><span class="p">,</span> <span class="n">act_t_np</span> <span class="o">=</span> <span class="n">state_nt</span><span class="p">,</span> <span class="n">act_nt_np</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;reward&quot;</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reward</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rgb_array&#39;</span><span class="p">))</span>
                <span class="n">display_frames_as_gif</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id28">
<h4>数据结果<a class="headerlink" href="#id28" title="Link to this heading">¶</a></h4>
<p>训练结果如下图所示,可以看出经过一定步骤之后达到最终位置。</p>
<a class="reference internal image-reference" href="../_images/result_QDRL.gif"><img alt="../_images/result_QDRL.gif" class="align-center" src="../_images/result_QDRL.gif" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="id29">
<h2>无监督学习<a class="headerlink" href="#id29" title="Link to this heading">¶</a></h2>
<section id="quantum-kmeans">
<h3>1.Quantum Kmeans<a class="headerlink" href="#quantum-kmeans" title="Link to this heading">¶</a></h3>
<section id="id30">
<h4>1.1介绍<a class="headerlink" href="#id30" title="Link to this heading">¶</a></h4>
<p>聚类算法是一种典型的无监督学习算法,主要用于将相似的样本自动归为一类。聚类算法中,根据样本之间的相似性,将样本划分为不同的类别。对于不同的相似度计算方法,会得到不同的聚类结果。常用的相似度计算方法是欧氏距离法。我们要展示的是量子 K-Means 算法。 K-Means算法是一种基于距离的聚类算法,它以距离作为相似度的评价指标,即两个对象之间的距离越近,相似度越大。该算法认为簇是由相距很近的对象组成的,因此紧凑且独立的簇是最终目标。</p>
<p>在VQNet中同样可以进行Quantum Kmeans量子机器学习模型的开发。下面给出了Quantum Kmeans聚类任务的一个示例。通过量子线路,我们可以构建一个测量值与经典机器学习的变量的欧几里得距离正相关,达到进行查找最近邻的目标。</p>
</section>
<section id="id31">
<h4>1.2算法原理介绍<a class="headerlink" href="#id31" title="Link to this heading">¶</a></h4>
<p>量子K-Means算法的实现主要使用swap test来比较输入数据点之间的距离。从N个数据点中随机选择K个点作为质心,测量每个点到每个质心的距离,并将其分配到最近的质心类,重新计算已经得到的每个类的质心,迭代2到3步,直到新的质心等于或小于指定的阈值,算法结束。 在我们的示例中,我们选择了100个数据点、2个质心,并使用CSWAP电路来计算距离。 最后,我们获得了两个数据点集群。 <span class="math notranslate nohighlight">\(|0\rangle\)</span> 是辅助比特, 通过H逻辑门量子比特位将变为 <span class="math notranslate nohighlight">\(\frac{1}{\sqrt{2}}(|0\rangle + |1\rangle)\)</span>. 在量比特 <span class="math notranslate nohighlight">\(|1\rangle\)</span> 的控制下, 量子线路将会翻转 <span class="math notranslate nohighlight">\(|x\rangle\)</span> 和 <span class="math notranslate nohighlight">\(|y\rangle​\)</span> . 最终得到结果:</p>
<div class="math notranslate nohighlight">
\[|0_{anc}\rangle |x\rangle |y\rangle \rightarrow \frac{1}{2}|0_{anc}\rangle(|xy\rangle + |yx\rangle) + \frac{1}{2}|1_{anc}\rangle(|xy\rangle - |yx\rangle)\]</div>
<p>如果我们单独测量辅助量子比特,那么基态最终状态的概率 <span class="math notranslate nohighlight">\(|1\rangle\)</span> 是:</p>
<div class="math notranslate nohighlight">
\[P(|1_{anc}\rangle) = \frac{1}{2} - \frac{1}{2}|\langle x | y \rangle|^2\]</div>
<p>两个量子态之间的欧几里得距离如下:</p>
<div class="math notranslate nohighlight">
\[Euclidean \ distance = \sqrt{(2 - 2|\langle x | y \rangle|)}\]</div>
<p>可见测量量子比特位 <span class="math notranslate nohighlight">\(|1\rangle\)</span> ​与欧几里得距离有正相关. 本算法的量子线路如下所述:</p>
<a class="reference internal image-reference" href="../_images/Kmeans.jpg"><img alt="../_images/Kmeans.jpg" class="align-center" src="../_images/Kmeans.jpg" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="vqnet">
<h4>1.3 VQNet实现<a class="headerlink" href="#vqnet" title="Link to this heading">¶</a></h4>
<section id="id32">
<h5>1.3.1 环境准备<a class="headerlink" href="#id32" title="Link to this heading">¶</a></h5>
<p>环境采用python3.8,建议使用conda进行环境配置,自带numpy,scipy,matplotlib,sklearn等工具包,方便使用,如果采用的是python环境,需要安装相关的包
还需要准备如下环境pyvqnet</p>
</section>
<section id="id33">
<h5>1.3.2 数据准备<a class="headerlink" href="#id33" title="Link to this heading">¶</a></h5>
<p>数据采用scipy下的make_blobs来随机产生,并定义函数用于生成高斯分布数据。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span><span class="p">,</span> <span class="n">zeros</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_blobs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="c1"># 根据数据的数据量n,聚类中心k和数据标准差std返回对应数据点和聚类中心点</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                    <span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">centers</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                    <span class="n">cluster_std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
                    <span class="n">random_state</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">centers</span>
</pre></div>
</div>
</section>
<section id="id34">
<h5>1.3.3 量子线路<a class="headerlink" href="#id34" title="Link to this heading">¶</a></h5>
<p>使用VQNet构建量子线路</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 根据输入的坐标点d(x,y)来计算输入的量子门旋转角度</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_theta</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="n">y</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span>

<span class="c1"># 根据输入的量子数据点构建量子线路</span>
<span class="k">def</span><span class="w"> </span><span class="nf">qkmeans_circuits</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quantum Circuit for kmeans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta_1</span> <span class="o">=</span> <span class="n">get_theta</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">theta_2</span> <span class="o">=</span> <span class="n">get_theta</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">num_qubits</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">cbits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">cAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">U3</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">theta_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">U3</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">theta_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">SWAP</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">control</span><span class="p">([</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">&lt;&lt;</span> <span class="n">pq</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">Reset</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">Reset</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">Reset</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">run_with_configuration</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">cbits</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;001&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1024.0</span>
</pre></div>
</div>
</section>
<section id="id35">
<h5>1.3.4 数据可视化<a class="headerlink" href="#id35" title="Link to this heading">¶</a></h5>
<p>对相关聚类数据进行可视化计算</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 对散点和聚类中心进行可视化</span>
<span class="k">def</span><span class="w"> </span><span class="nf">draw_plot</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">centers</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id36">
<h5>1.3.5 聚类计算<a class="headerlink" href="#id36" title="Link to this heading">¶</a></h5>
<p>对相关聚类数据进行聚类中心计算</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 随机生成聚类中心点</span>
<span class="k">def</span><span class="w"> </span><span class="nf">initialize_centers</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="n">k</span><span class="p">),:]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_nearest_neighbour</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">centroids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find nearest neighbour</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">centers</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">min_dis</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>

            <span class="n">temp_dis</span> <span class="o">=</span> <span class="n">qkmeans_circuits</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">centroids</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">if</span> <span class="n">temp_dis</span> <span class="o">&lt;</span> <span class="n">min_dis</span><span class="p">:</span>
                <span class="n">min_dis</span> <span class="o">=</span> <span class="n">temp_dis</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">centers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>

    <span class="k">return</span> <span class="n">centers</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_centroids</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">centers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find centroids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>

        <span class="n">cur_i</span> <span class="o">=</span> <span class="n">centers</span> <span class="o">==</span> <span class="n">i</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">cur_i</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">cur_i</span><span class="p">]</span>
        <span class="n">centroids</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">centroids</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">centroids</span>

<span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">30.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="mi">15</span>
        <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">x</span>

    <span class="k">return</span> <span class="n">points</span>


<span class="k">def</span><span class="w"> </span><span class="nf">qkmeans_run</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function for run qkmeans algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># number of data points</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of centers</span>
    <span class="n">std</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># std of datapoints</span>

    <span class="n">points</span><span class="p">,</span> <span class="n">o_centers</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>  <span class="c1"># dataset</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>  <span class="c1"># Normalize dataset</span>

    <span class="n">centroids</span> <span class="o">=</span> <span class="n">initialize_centers</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># Intialize centroids</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">)</span>
    <span class="n">draw_plot</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">o_centers</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># run k-means algorithm</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">find_nearest_neighbour</span><span class="p">(</span><span class="n">points</span><span class="p">,</span>
                                        <span class="n">centroids</span><span class="p">)</span>  <span class="c1"># find nearest centers</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="n">find_centroids</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">centers</span><span class="p">)</span>  <span class="c1"># find centroids</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;result after iteration </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">draw_plot</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># 运行程序入口</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">qkmeans_run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id37">
<h5>1.3.6 聚类前数据分布<a class="headerlink" href="#id37" title="Link to this heading">¶</a></h5>
<a class="reference internal image-reference" href="../_images/ep_1.png"><img alt="../_images/ep_1.png" class="align-center" src="../_images/ep_1.png" style="width: 600px;" />
</a>
</section>
<section id="id38">
<h5>1.3.7聚类后数据分布<a class="headerlink" href="#id38" title="Link to this heading">¶</a></h5>
<a class="reference internal image-reference" href="../_images/ep_9.png"><img alt="../_images/ep_9.png" class="align-center" src="../_images/ep_9.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
</section>
<section id="id39">
<h2>量子机器学习研究<a class="headerlink" href="#id39" title="Link to this heading">¶</a></h2>
<section id="fourier-series">
<h3>量子模型拟合fourier series算法<a class="headerlink" href="#fourier-series" title="Link to this heading">¶</a></h3>
<p>通过参数化的量子线路将数据输入映射到预测的模型,量子计算机可用于监督学习。虽然已经做了大量工作来研究这种方法的实际意义,
但这些模型的许多重要理论特性仍然未知。在这里,我们研究了将数据编码到模型中的策略如何影响参数化量子电路作为函数逼近器的表达能力。</p>
<p>本例参照 <a class="reference external" href="https://arxiv.org/pdf/2008.08605.pdf">The effect of data encoding on the expressive power of variational quantum machine learning models</a> 论文将量子计算机设计的常见量子机器学习模型与傅里叶级数联系起来。</p>
<section id="pauli">
<h4>1.1用串行Pauli旋转编码拟合傅里叶级数<a class="headerlink" href="#pauli" title="Link to this heading">¶</a></h4>
<p>首先我们展示使用Pauli旋转作为数据编码门的量子模型如何只能在一定程度上拟合傅里叶级数。为简单起见,我们将只看单量子比特电路:</p>
<a class="reference internal image-reference" href="../_images/single_qubit_model.png"><img alt="../_images/single_qubit_model.png" class="align-center" src="../_images/single_qubit_model.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>制作输入数据,定义并行量子模型,不进行模型训练结果。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quantum Fourier Series</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>


<span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># degree of the target function</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># scaling of the data</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span> <span class="o">+</span> <span class="mf">0.15</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">degree</span>  <span class="c1"># coefficients of non-zero frequencies</span>
<span class="n">coeff0</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># coefficient of zero frequency</span>

<span class="k">def</span><span class="w"> </span><span class="nf">target_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a truncated Fourier series, where the data gets re-scaled.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">coeff0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">scaling</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
        <span class="n">conj_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">conj_coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">exponent</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">target_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_function</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">S</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaling</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">W</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">serial_quantum_model</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">,</span> <span class="n">scaling</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">qubits</span><span class="p">))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">qubits</span><span class="p">))</span>

    <span class="c1"># (L+1)&#39;th unitary</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">))</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

    <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">pauli_str</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
        <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exp_vals</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">weights</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># some random initial weights</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">random_quantum_model_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">serial_quantum_model</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">random_quantum_model_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>不训练的量子线路运行结果为:</p>
<a class="reference internal image-reference" href="../_images/single_qubit_model_result_no_train.png"><img alt="../_images/single_qubit_model_result_no_train.png" class="align-center" src="../_images/single_qubit_model_result_no_train.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>制作输入数据,定义串行量子模型,并结合VQNet框架的QuantumLayer层构建训练模型。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quantum Fourier Series Serial</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeanSquaredError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># degree of the target function</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># scaling of the data</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span> <span class="o">+</span> <span class="mf">0.15</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">degree</span>  <span class="c1"># coefficients of non-zero frequencies</span>
<span class="n">coeff0</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># coefficient of zero frequency</span>

<span class="k">def</span><span class="w"> </span><span class="nf">target_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a truncated Fourier series, where the data gets re-scaled.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">coeff0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">scaling</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
        <span class="n">conj_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">conj_coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">exponent</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">target_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_function</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">S</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">W</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">cir</span>


<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">weights</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># some random initial weights</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">q_circuits_loop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">qubits</span><span class="p">,</span> <span class="n">clist</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">qubits</span><span class="p">))</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">qubits</span><span class="p">))</span>

        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">))</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
        <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

        <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">pauli_str</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
            <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_fourier_series</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">q_circuits_loop</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_fourier_series</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">MeanSquaredError</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Select batch of data</span>
            <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,))</span>
            <span class="n">x_batch</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
            <span class="n">y_batch</span> <span class="o">=</span> <span class="n">target_y</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([</span><span class="n">x_batch</span><span class="p">]),</span> <span class="n">QTensor</span><span class="p">([</span><span class="n">y_batch</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss_b</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">loss_b</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss_b</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, #### loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">xx</span><span class="p">]])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>其中量子模型为:</p>
<a class="reference internal image-reference" href="../_images/single_qubit_model_circuit.png"><img alt="../_images/single_qubit_model_circuit.png" class="align-center" src="../_images/single_qubit_model_circuit.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>网络训练结果为:</p>
<a class="reference internal image-reference" href="../_images/single_qubit_model_result.png"><img alt="../_images/single_qubit_model_result.png" class="align-center" src="../_images/single_qubit_model_result.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>网络训练损失为:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="n">training</span><span class="o">..............</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="c1">#### loss:0.04852807720773853</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#### loss:0.012945819365559146</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="c1">#### loss:0.0009359727291666786</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="c1">#### loss:0.00015995280153333625</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="c1">#### loss:3.988249877352246e-05</span>
</pre></div>
</div>
</section>
<section id="id40">
<h4>1.2用并行Pauli旋转编码拟合傅里叶级数<a class="headerlink" href="#id40" title="Link to this heading">¶</a></h4>
<p>根据论文所示,我们期望与串行模型相似的结果: 只有在量子模型中编码门至少有r个重复时,才能拟合r阶的傅立叶级数。量子比特电路:</p>
<a class="reference internal image-reference" href="../_images/parallel_model.png"><img alt="../_images/parallel_model.png" class="align-center" src="../_images/parallel_model.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>制作输入数据,定义并行量子模型,不进行模型训练结果。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quantum Fourier Series</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># degree of the target function</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># scaling of the data</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span> <span class="o">+</span> <span class="mf">0.15</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">degree</span>  <span class="c1"># coefficients of non-zero frequencies</span>
<span class="n">coeff0</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># coefficient of zero frequency</span>

<span class="k">def</span><span class="w"> </span><span class="nf">target_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a truncated Fourier series, where the data gets re-scaled.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">coeff0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">scaling</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
        <span class="n">conj_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">conj_coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">exponent</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">target_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_function</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">S1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qubits</span><span class="p">:</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">W1</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parallel_quantum_model</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W1</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">S1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">qubits</span><span class="p">))</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W1</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">))</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

    <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">pauli_str</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
        <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">exp_vals</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">trainable_block_layers</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">weights</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trainable_block_layers</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="c1"># print(weights)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">random_quantum_model_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">parallel_quantum_model</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">random_quantum_model_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>不训练的量子线路运行结果为:</p>
<a class="reference internal image-reference" href="../_images/parallel_model_result_no_train.png"><img alt="../_images/parallel_model_result_no_train.png" class="align-center" src="../_images/parallel_model_result_no_train.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>制作输入数据,定义并行量子模型,并结合VQNet框架的QuantumLayer层构建训练模型。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Quantum Fourier Series</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeanSquaredError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span><span class="p">,</span> <span class="n">QuantumLayerMultiProcess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not use matplot TkAgg&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># degree of the target function</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># scaling of the data</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span> <span class="o">+</span> <span class="mf">0.15</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">degree</span>  <span class="c1"># coefficients of non-zero frequencies</span>
<span class="n">coeff0</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># coefficient of zero frequency</span>

<span class="k">def</span><span class="w"> </span><span class="nf">target_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a truncated Fourier series, where the data gets re-scaled.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">coeff0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">scaling</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
        <span class="n">conj_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">conj_coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">exponent</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">target_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_function</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">S1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qubits</span><span class="p">:</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">W1</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">cir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">q_circuits_loop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">qubits</span><span class="p">,</span> <span class="n">clist</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W1</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qubits</span><span class="p">))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">S1</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">qubits</span><span class="p">))</span>

        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">W1</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qubits</span><span class="p">))</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
        <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

        <span class="n">exp_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pauli_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">pauli_str</span><span class="p">,</span> <span class="n">qubits</span><span class="p">)</span>
            <span class="n">exp_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q_fourier_series</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">q_circuits_loop</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_fourier_series</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">MeanSquaredError</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Select batch of data</span>
            <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,))</span>
            <span class="n">x_batch</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
            <span class="n">y_batch</span> <span class="o">=</span> <span class="n">target_y</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([</span><span class="n">x_batch</span><span class="p">]),</span> <span class="n">QTensor</span><span class="p">([</span><span class="n">y_batch</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss_b</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">loss_b</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss_b</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="n">loss_cout</span> <span class="o">=</span> <span class="n">sum_loss</span> <span class="o">/</span> <span class="n">count</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, #### loss:</span><span class="si">{</span><span class="n">loss_cout</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">loss_cout</span> <span class="o">&lt;</span> <span class="mf">0.002</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">([[</span><span class="n">xx</span><span class="p">]])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>其中量子模型为:</p>
<a class="reference internal image-reference" href="../_images/parallel_model_circuit.png"><img alt="../_images/parallel_model_circuit.png" class="align-center" src="../_images/parallel_model_circuit.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>网络训练结果为:</p>
<a class="reference internal image-reference" href="../_images/parallel_model_result.png"><img alt="../_images/parallel_model_result.png" class="align-center" src="../_images/parallel_model_result.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>网络训练损失为:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="n">training</span><span class="o">..............</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="c1">#### loss:0.0037272341538482578</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#### loss:5.271130586635309e-05</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="c1">#### loss:4.714951917250687e-07</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="c1">#### loss:1.0968826371082763e-08</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="c1">#### loss:2.1258629738507562e-10</span>
</pre></div>
</div>
</section>
</section>
<section id="id41">
<h3>量子线路表达能力<a class="headerlink" href="#id41" title="Link to this heading">¶</a></h3>
<p>在论文 <a class="reference external" href="https://arxiv.org/abs/1905.10876">Expressibility and entangling capability of parameterized quantum circuits for hybrid quantum-classical algorithms</a> 中,
作者提出了基于神经网络输出态之间的保真度概率分布的表达能力量化方法。
对任意量子神经网络 <span class="math notranslate nohighlight">\(U(\vec{\theta})\)</span> ,采样两次神经网络参数(设为 <span class="math notranslate nohighlight">\(\vec{\phi}\)</span> 和 <span class="math notranslate nohighlight">\(\vec{\psi}\)</span> ),
则两个量子电路输出态之间的保真度 <span class="math notranslate nohighlight">\(F=|\langle0|U(\vec{\phi})^\dagger U(\vec{\psi})|0\rangle|^2\)</span> 服从某个概率分布:</p>
<div class="math notranslate nohighlight">
\[F\sim{P}(f)\]</div>
<p>文献指出,量子神经网络 <span class="math notranslate nohighlight">\(U\)</span> 能够均匀地分布在所有酉矩阵上时(此时称 <span class="math notranslate nohighlight">\(U\)</span> 服从哈尔分布),保真度的概率分布 <span class="math notranslate nohighlight">\(P_\text{Haar}(f)\)</span> 满足</p>
<div class="math notranslate nohighlight">
\[P_\text{Haar}(f)=(2^{n}-1)(1-f)^{2^n-2}\]</div>
<p>统计数学中的 K-L 散度(也称相对熵)可以衡量两个概率分布之间的差异。两个离散概率分布 <span class="math notranslate nohighlight">\(P,Q\)</span> 之间的 K-L 散度定义为</p>
<div class="math notranslate nohighlight">
\[D_{KL}(P||Q)=\sum_jP(j)\ln\frac{P(j)}{Q(j)}\]</div>
<p>如果将量子神经网络输出的保真度分布记为 <span class="math notranslate nohighlight">\(P_\text{QNN}(f)\)</span> ,则量子神经网络的表达能力定义为 <span class="math notranslate nohighlight">\(P_\text{QNN}(f)\)</span> 和 <span class="math notranslate nohighlight">\(P_\text{Haar}(f)\)</span> 之间的 K-L 散度 :</p>
<div class="math notranslate nohighlight">
\[\text{Expr}_\text{QNN}=D_{KL}(P_\text{QNN}(f)||P_\text{Haar}(f))\]</div>
<p>因此,当 <span class="math notranslate nohighlight">\(P_\text{QNN}(f)\)</span> 越接近 <span class="math notranslate nohighlight">\(P_\text{Haar}(f)\)</span> 时, <span class="math notranslate nohighlight">\(\text{Expr}\)</span> 将越小(越趋近于 0),
量子神经网络的表达能力也就越强；反之, <span class="math notranslate nohighlight">\(\text{Expr}\)</span> 越大,量子神经网络的表达能力也就越弱。</p>
<p>我们可以根据该定义直接计算单比特量子神经网络 <span class="math notranslate nohighlight">\(R_Y(\theta)\)</span> , <span class="math notranslate nohighlight">\(R_Y(\theta_1)R_Z(\theta_2)\)</span> 和 <span class="math notranslate nohighlight">\(R_Y(\theta_1)R_Z(\theta_2)R_Y(\theta_3)\)</span> 的表达能力:</p>
<p>以下用VQNet展示了 <a class="reference external" href="https://arxiv.org/abs/1704.05018">HardwareEfficientAnsatz</a> 在不同深度下(1,2,3)的量子线路表达能力。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">FuncFormatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">sqrtm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">entropy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.ansatz</span><span class="w"> </span><span class="kn">import</span> <span class="n">HardwareEfficientAnsatz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantum_expressibility.quantum_express</span><span class="w"> </span><span class="kn">import</span> <span class="n">fidelity_of_cir</span><span class="p">,</span> <span class="n">fidelity_harr_sample</span>
<span class="n">num_qubit</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># the number of qubit</span>
<span class="n">num_sample</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># the number of sample</span>
<span class="n">outputs_y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># save QNN outputs</span>


<span class="c1"># plot histgram</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bin</span><span class="p">,</span> <span class="n">title_str</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_percent</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_bin</span><span class="p">),</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fidelity&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">FuncFormatter</span><span class="p">(</span><span class="n">to_percent</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



<span class="k">def</span><span class="w"> </span><span class="nf">cir</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>

    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qlist</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">az</span> <span class="o">=</span> <span class="n">HardwareEfficientAnsatz</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="s2">&quot;RY&quot;</span><span class="p">,</span> <span class="s2">&quot;rz&quot;</span><span class="p">],</span>
                                <span class="n">qlist</span><span class="p">,</span>
                                <span class="n">entangle_gate</span><span class="o">=</span><span class="s2">&quot;cnot&quot;</span><span class="p">,</span>
                                <span class="n">entangle_rules</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                                <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">QTensor</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">az</span><span class="o">.</span><span class="n">get_para_num</span><span class="p">()],</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="n">cir1</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">create_ansatz</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cir1</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">qlist</span>
</pre></div>
</div>
<p>哈尔采样输出的保真度服从分布:</p>
<a class="reference internal image-reference" href="../_images/haar-fidelity.png"><img alt="../_images/haar-fidelity.png" class="align-center" src="../_images/haar-fidelity.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置电路宽度和最大深度</span>
<span class="n">num_qubit</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1"># 计算哈尔采样对应的保真度分布</span>

<span class="n">flist</span><span class="p">,</span> <span class="n">p_haar</span><span class="p">,</span> <span class="n">theory_haar</span> <span class="o">=</span> <span class="n">fidelity_harr_sample</span><span class="p">(</span><span class="n">num_qubit</span><span class="p">,</span> <span class="n">num_sample</span><span class="p">)</span>
<span class="n">title_str</span> <span class="o">=</span> <span class="s2">&quot;haar, </span><span class="si">%d</span><span class="s2"> qubit(s)&quot;</span> <span class="o">%</span> <span class="n">num_qubit</span>
<span class="n">plot_hist</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">title_str</span><span class="p">)</span>



<span class="n">Expr_cel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="c1"># 计算不同深度的神经网络的表达能力</span>
<span class="k">for</span> <span class="n">DEPTH</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

    <span class="n">f_list</span><span class="p">,</span> <span class="n">p_cel</span> <span class="o">=</span> <span class="n">fidelity_of_cir</span><span class="p">(</span><span class="n">HardwareEfficientAnsatz</span><span class="p">,</span> <span class="n">num_qubit</span><span class="p">,</span> <span class="n">DEPTH</span><span class="p">,</span>
                                    <span class="n">num_sample</span><span class="p">)</span>
    <span class="n">title_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;HardwareEfficientAnsatz, </span><span class="si">{</span><span class="n">num_qubit</span><span class="si">}</span><span class="s2"> qubit(s) </span><span class="si">{</span><span class="n">DEPTH</span><span class="si">}</span><span class="s2"> layer(s)&quot;</span>
    <span class="n">plot_hist</span><span class="p">(</span><span class="n">f_list</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">title_str</span><span class="p">)</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">p_cel</span><span class="p">,</span> <span class="n">theory_haar</span><span class="p">)</span>
    <span class="n">Expr_cel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="c1"># 比较不同深度的神经网络的表达能力</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;深度为 1,2,3 的神经网络的表达能力分别为 </span><span class="si">{</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">Expr_cel</span><span class="p">,</span><span class="w"> </span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2"> 越小越好。&quot;</span><span class="p">,</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Expr_cel</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Expr.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Expressibility vs Circuit Depth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>采样深度为 1 的电路的保真度分布</p>
<a class="reference internal image-reference" href="../_images/f1.png"><img alt="../_images/f1.png" class="align-center" src="../_images/f1.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>采样深度为 2 的电路的保真度分布</p>
<a class="reference internal image-reference" href="../_images/f2.png"><img alt="../_images/f2.png" class="align-center" src="../_images/f2.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>采样深度为 3 的电路的保真度分布</p>
<a class="reference internal image-reference" href="../_images/f3.png"><img alt="../_images/f3.png" class="align-center" src="../_images/f3.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>可见,随着量子线路深度提升,保真度KL散度越小,表达力越强。</p>
<a class="reference internal image-reference" href="../_images/express.png"><img alt="../_images/express.png" class="align-center" src="../_images/express.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id42">
<h3>贫瘠高原现象<a class="headerlink" href="#id42" title="Link to this heading">¶</a></h3>
<p>在经典神经网络的训练中,基于梯度的优化方法不仅会遇到局部极小值的问题,
而且还会遇到梯度接近于零的鞍点等几何结构。
相应的,量子神经网络中也存在 “贫瘠高原效应” 。
这一奇特现象最早由McClean等人在2018年发现 <a class="reference external" href="https://arxiv.org/abs/1803.11173">Barren plateaus in quantum neural network training landscapes</a>。
简单地说,当你选择的随机电路结构满足一定程度的复杂性时,优化曲面会变得非常平坦,
这使得基于梯度下降的优化方法很难找到全局最小值
。对于大多数变分量子算法(VQE等)来说,这种现象意味着当量子位的数量增加时,
具有随机结构的电路可能无法很好地工作。
这将使精心设计的损失函数对应的优化曲面变成一个巨大的平台,
使量子神经网络的训练更加困难。
模型随机找到的初值很难逃离这个平台,梯度下降的收敛速度会非常慢。</p>
<p>本案例主要使用VQNet展示贫瘠高原现象,使用梯度分析函数对用户自定义量子神经网络中的参数梯度进行分析。</p>
<p>以下代码按照原论文中提及的类似方法搭建如下随机电路:</p>
<p>首先作用在所有量子比特上绕布洛赫球的 Y-轴旋转 <span class="math notranslate nohighlight">\(\pi/4\)</span> 。</p>
<p>其余的结构加起来构成一个模块(Block), 每个模块共分为两层:</p>
<ul class="simple">
<li><p>第一层搭建随机的旋转门, 其中 <span class="math notranslate nohighlight">\(R \in \{R_x, R_y, R_z\}\)</span> 。</p></li>
<li><p>第二层由 CZ 门组成,作用在每两个相邻的量子比特上。</p></li>
</ul>
<p>线路代码如rand_circuit_pq函数所示。</p>
<p>当我们确定了电路的结构之后,我们还需要定义一个损失函数(loss function)来确定优化曲面。
按照原论文中提及的,我们采用 VQE算法中常用的损失函数:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L}(\boldsymbol{\theta})= \langle0| U^{\dagger}(\boldsymbol{\theta})H U(\boldsymbol{\theta}) |0\rangle\]</div>
<p>其中的酉矩阵  <span class="math notranslate nohighlight">\(U(\boldsymbol{\theta})\)</span> 就是我们上一部分搭建的带有随机结构的量子神经网络。
哈密顿量 <span class="math notranslate nohighlight">\(H = |00\cdots 0\rangle\langle00\cdots 0|\)</span> 。
本案例使用在不同量子比特数上构建如上VQE算法,并生成200组随机网络结构和不同的随机初始参数.
含参线路中参数的梯度按照paramter-shift算法进行计算。
然后统计得到的其中变分参数的200个梯度的平均值和方差。</p>
<p>以下例子对变分量子参数的最后一个进行分析,读者也可自行修改为其他合理的值。
通过运行,读者不难发现,随着量子比特数增加,量子参数的梯度的方差越来越小,均值越来越接近0。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">贫瘠高原</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Hermitian_expval</span><span class="p">,</span> <span class="n">grad</span>

<span class="n">param_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">gate_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">pq</span><span class="o">.</span><span class="n">RX</span><span class="p">,</span> <span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">,</span> <span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rand_circuit_pq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">):</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qlist</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">cir</span> <span class="o">&lt;&lt;</span> <span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span>
            <span class="n">qlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">random_gate_sequence</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">i</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">gate_set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">):</span>
        <span class="n">cir</span> <span class="o">&lt;&lt;</span> <span class="n">random_gate_sequence</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">qlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cir</span> <span class="o">&lt;&lt;</span> <span class="n">pq</span><span class="o">.</span><span class="n">CZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">directly_run</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_qstate</span><span class="p">()</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">num_qubits</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">num_qubits</span><span class="p">))</span>
    <span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">expval</span> <span class="o">=</span> <span class="n">Hermitian_expval</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)],</span>
                            <span class="n">num_qubits</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">expval</span>


<span class="n">qubits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="n">variances</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">num_qubits</span> <span class="ow">in</span> <span class="n">qubits</span><span class="p">:</span>
    <span class="n">grad_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_qubits</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="n">rand_circuit_pq</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">)</span>

        <span class="n">grad_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">variances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">grad_vals</span><span class="p">))</span>
    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">grad_vals</span><span class="p">))</span>
<span class="n">variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
<span class="n">qubits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="s2">&quot;v-&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;N Qubits&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="s2">&quot;v-&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;N Qubits&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;means&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>下图显示了参数梯度的均值随着量子比特数变化的情况,随着量子比特数增加,参数梯度趋近0。</p>
<a class="reference internal image-reference" href="../_images/Barren_Plateau_mean.png"><img alt="../_images/Barren_Plateau_mean.png" class="align-center" src="../_images/Barren_Plateau_mean.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>下图显示了参数梯度的方差随着量子比特数变化的情况,随着量子比特数增加,参数梯度几乎不变化。
可以预见,任意含参逻辑门搭建的量子线路随着量子比特提升,在任意参数初始化情况下,参数训练容易陷入难以更新的情况。</p>
<a class="reference internal image-reference" href="../_images/Barren_Plateau_variance.png"><img alt="../_images/Barren_Plateau_variance.png" class="align-center" src="../_images/Barren_Plateau_variance.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id43">
<h3>量子感知机<a class="headerlink" href="#id43" title="Link to this heading">¶</a></h3>
<p>人工神经网络是机器学习算法和人工智能的一种经典方法。从历史上看,人工神经元的最简单实现可以追溯到经典Rosenblatt 的“感知器”,但其长期实际应用可能会受到计算复杂度快速扩展的阻碍,尤其是与多层感知器的训练相关网络。这里我们参照论文 <a class="reference external" href="https://arxiv.org/abs/1811.02266">An Artificial Neuron Implemented on an Actual Quantum Processor</a> 一种基于量子信息的算法实现量子计算机版本的感知器,在编码资源方面显示出相比经典模型指数优势。</p>
<p>对于该量子感知机,处理的数据是 0 1 二进制比特字符串。其目标是想识别形如下图 <span class="math notranslate nohighlight">\(w\)</span> 十字形状的模式。</p>
<a class="reference internal image-reference" href="../_images/QP-data.png"><img alt="../_images/QP-data.png" class="align-center" src="../_images/QP-data.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>使用二进制比特字符串对其进行编码,其中黑为0,白为1,可知 <span class="math notranslate nohighlight">\(w\)</span> 编码为(1,1,1,1,1,1,0,1,1,0,0,0,1,1,0,1)。共16位的字符串正好可以编码进4bit的量子态的振幅的符号上,符号为负数编码为0,符号为正数编码为1。通过以上编码方式,我们算法输入input转化为16位的二进制串。这样的不重复的二进制串可以分别对应特定的输入线路 <span class="math notranslate nohighlight">\(U_i\)</span> 。</p>
<p>该论文提出的量子感知机线路结构如下:</p>
<a class="reference internal image-reference" href="../_images/QP-cir.png"><img alt="../_images/QP-cir.png" class="align-center" src="../_images/QP-cir.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>在比特0~3上构建编码线路 <span class="math notranslate nohighlight">\(U_i\)</span> ,包含多受控的 <span class="math notranslate nohighlight">\(CZ\)</span> 门, <span class="math notranslate nohighlight">\(CNOT\)</span> 门, <span class="math notranslate nohighlight">\(H\)</span> 门；在 <span class="math notranslate nohighlight">\(U_i\)</span> 后面紧接着构建权重变换线路 <span class="math notranslate nohighlight">\(U_w\)</span> ,同样由受控门以及 <span class="math notranslate nohighlight">\(H\)</span> 门构成。使用 <span class="math notranslate nohighlight">\(U_i\)</span> 可以进行酉矩阵变化,将数据编码到量子态上:</p>
<div class="math notranslate nohighlight">
\[U_i|0\rangle^{\otimes N}=\left|\psi_i\right\rangle\]</div>
<p>使用酉矩阵变换 <span class="math notranslate nohighlight">\(U_w\)</span> 来计算输入和权重之间的内积:</p>
<div class="math notranslate nohighlight">
\[U_w\left|\psi_i\right\rangle=\sum_{j=0}^{m-1} c_j|j\rangle \equiv\left|\phi_{i, w}\right\rangle\]</div>
<p>使用一个目标比特在辅助比特上的多受控 <span class="math notranslate nohighlight">\(NOT\)</span> 门,并使用一些后续的 <span class="math notranslate nohighlight">\(H\)</span> 门, <span class="math notranslate nohighlight">\(X\)</span> 门,:math:<cite>CX</cite> 门作为激活函数可以获取 <span class="math notranslate nohighlight">\(U_i\)</span> 和 <span class="math notranslate nohighlight">\(U_w\)</span> 的归一化激活概率值:</p>
<div class="math notranslate nohighlight">
\[\left|\phi_{i, w}\right\rangle|0\rangle_a \rightarrow \sum_{j=0}^{m-2} c_j|j\rangle|0\rangle_a+c_{m-1}|m-1\rangle|1\rangle_a\]</div>
<p>当输入 <span class="math notranslate nohighlight">\(i\)</span> 的2进制串和 <span class="math notranslate nohighlight">\(w\)</span> 完全一致时,该归一化概率值应为最大。</p>
<p>VQNet提供了 <code class="docutils literal notranslate"><span class="pre">QuantumNeuron</span></code> 模块实现该算法。首先初始化一个量子感知机 <code class="docutils literal notranslate"><span class="pre">QuantumNeuron</span></code>。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">perceptron</span> <span class="o">=</span> <span class="n">QuantumNeuron</span><span class="p">()</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">gen_4bitstring_data</span></code> 接口生成论文中的各种数据以及其类别标签。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">training_label</span><span class="p">,</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">perceptron</span><span class="o">.</span><span class="n">gen_4bitstring_data</span><span class="p">()</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">train</span></code> 接口遍历所有数据,可以获取最后训练好的量子感知器线路Uw。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trained_para</span> <span class="o">=</span> <span class="n">perceptron</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_label</span><span class="p">,</span> <span class="n">test_label</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/QP-pic.png"><img alt="../_images/QP-pic.png" class="align-center" src="../_images/QP-pic.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>在测试数据上,可以获取测试数据上的准确率结果</p>
<a class="reference internal image-reference" href="../_images/QP-acc.png"><img alt="../_images/QP-acc.png" class="align-center" src="../_images/QP-acc.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id44">
<h3>随机参数偏移算法<a class="headerlink" href="#id44" title="Link to this heading">¶</a></h3>
<p>在量子变分线路中,使用参数偏移法 <cite>parameter-shift</cite> 计算量子参数的梯度是一种常用的方法。
参数偏移法并不普遍适用所有的量子含参逻辑门。
在它不成立(或不知道成立)的情况下,我们要么必须将门分解为兼容的门,要么使用梯度的替代估计器,例如有限差分近似。
但是,由于增加了电路复杂性或梯度值中的潜在误差,这两种替代方案都可能存在缺陷。
Banchi 和 Crooks 1 发现一种可以适用在任一酉矩阵量子逻辑门上的 <a class="reference external" href="https://arxiv.org/abs/2005.10299">随机参数偏移算法(Stochastic Parameter-Shift Rule)</a> 。</p>
<p>下面展示适用VQNet对一个量子变分线路使用随机参数偏移法计算梯度的示例。其中, <strong>pyqpanda建议版本为3.7.12</strong> 。示例线路定义如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">expm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>


<span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">init_quantum_machine</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">QMachineType</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">cAlloc_many</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># some basic Pauli matrices</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Generator</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">theta3</span><span class="p">):</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">theta1</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span> <span class="o">-</span> \
        <span class="n">theta2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> \
        <span class="n">theta3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">G</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pq_demo_circuit</span><span class="p">(</span><span class="n">gate_pars</span><span class="p">):</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="o">*</span><span class="n">gate_pars</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">expm</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">matrix_decompose</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">m_prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>
    <span class="n">pauli_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z0&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">m_prog</span><span class="p">,</span> <span class="n">pauli_dict</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exp2</span>
</pre></div>
</div>
<p>随机参数偏移法首先随机从[0,1]的均匀分布中采样一个变量s,接着对线路分别进行如下的酉矩阵变换:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p><span class="math notranslate nohighlight">\(e^{i(1-s)(\hat{H} + \theta\hat{V})}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(e^{+i\tfrac{\pi}{4}\hat{V}}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(e^{is(\hat{H} + \theta\hat{V})}\)</span></p></li>
</ol>
</div></blockquote>
<p>其中 <span class="math notranslate nohighlight">\(\hat{V}\)</span> 是一个泡利算符的张量积, <span class="math notranslate nohighlight">\(\hat{H}\)</span> 是任意泡利算符张量积的线性组合。
此时获取的观测量的期望值我们定义为 <span class="math notranslate nohighlight">\(\langle r_+ \rangle\)</span> 。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">pq_SPSRgates</span><span class="p">(</span><span class="n">gate_pars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sign</span><span class="p">):</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="o">*</span><span class="n">gate_pars</span><span class="p">)</span>
    <span class="c1"># step a)</span>
    <span class="n">G1</span> <span class="o">=</span> <span class="n">expm</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">G1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">matrix_decompose</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">m_prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

    <span class="c1"># step b)</span>
    <span class="n">G2</span> <span class="o">=</span> <span class="n">expm</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">G2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">matrix_decompose</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>

    <span class="c1"># step c)</span>
    <span class="n">G3</span> <span class="o">=</span> <span class="n">expm</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">G3</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">matrix_decompose</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">m_prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cir</span><span class="p">)</span>
    <span class="n">pauli_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z0&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="n">exp2</span> <span class="o">=</span> <span class="n">expval</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">m_prog</span><span class="p">,</span> <span class="n">pauli_dict</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exp2</span>
</pre></div>
</div>
<p>将上一步骤中 <span class="math notranslate nohighlight">\(\tfrac{\pi}{4}\)</span> 变成  <span class="math notranslate nohighlight">\(-\tfrac{\pi}{4}\)</span>,
重复进行 a, b, c 操作,获取观测量的期望 <span class="math notranslate nohighlight">\(\langle r_- \rangle\)</span> 。</p>
<p>随机参数偏移算法计算的梯度公式如下:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\mathbb{E}_{s\in\mathcal{U}[0,1]}[\langle r_+ \rangle - \langle r_-\rangle]\]</div>
</div></blockquote>
<p>我们画出使用随机参数偏移法计算的参数 <span class="math notranslate nohighlight">\(\theta_1\)</span> 梯度与观测量期望的之间的关系。
通过观察可见,观测量期望符合 <span class="math notranslate nohighlight">\(\cos(2\theta_1)\)</span> 的函数形式；而使用随机参数偏移法计算梯度
符合 <span class="math notranslate nohighlight">\(-2\sin(2\theta_1)\)</span> , 正好是 <span class="math notranslate nohighlight">\(\cos(2\theta_1)\)</span> 的微分。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">theta2</span><span class="p">,</span> <span class="n">theta3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">1.6</span>
<span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">pos_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>
    <span class="n">pq_SPSRgates</span><span class="p">([</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">theta3</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">sign</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="p">]</span> <span class="k">for</span> <span class="n">theta1</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">])</span>
<span class="n">neg_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>
    <span class="n">pq_SPSRgates</span><span class="p">([</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">theta3</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">sign</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="p">]</span> <span class="k">for</span> <span class="n">theta1</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">])</span>

<span class="c1"># Plot the results</span>
<span class="n">evals</span> <span class="o">=</span> <span class="p">[</span><span class="n">pq_demo_circuit</span><span class="p">([</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">theta3</span><span class="p">])</span> <span class="k">for</span> <span class="n">theta1</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">]</span>
<span class="n">spsr_vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos_vals</span> <span class="o">-</span> <span class="n">neg_vals</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">evals</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expectation Value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">spsr_vals</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stochastic parameter-shift rule&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;theta1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;VQNet&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/stochastic_parameter-shift.png"><img alt="../_images/stochastic_parameter-shift.png" class="align-center" src="../_images/stochastic_parameter-shift.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id45">
<h3>双随机梯度下降<a class="headerlink" href="#id45" title="Link to this heading">¶</a></h3>
<p>在变分量子算法中,参数化量子电路通过经典梯度下降法进行优化,以最小化期望函数值。
虽然可以在经典模拟中分析计算期望值,在量子硬件上,程序仅限于从期望值中采样；随着样本数量以及shots次数的增加,这种方式获得的期望值会收敛于理论期望值,但可能永远得到准确值。
Sweke 等人 在 <a class="reference external" href="https://arxiv.org/abs/1910.01155">论文</a> 中发现了一种双随机梯度下降法。
在本文中,他们证明了使用有限数量的测量样本(或shots)来估计梯度的量子梯度下降是随机梯度下降的一种形式。
此外,如果优化涉及期望值的线性组合(例如 VQE),从该线性组合中的项中抽样可以进一步减少所需的时间复杂度。</p>
<p>VQNet实现了该算法的一个示例: 使用VQE 求解目标Hamiltonian的基态能量。注意此处我们设置量子线路观测的次数shots仅为1次。</p>
<div class="math notranslate nohighlight">
\[\begin{split}H = \begin{bmatrix}
      8 &amp; 4 &amp; 0 &amp; -6\\
      4 &amp; 0 &amp; 4 &amp; 0\\
      0 &amp; 4 &amp; 8 &amp; 0\\
      -6 &amp; 0 &amp; 0 &amp; 0
    \end{bmatrix}.\end{split}\]</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">StronglyEntanglingTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.measure</span><span class="w"> </span><span class="kn">import</span> <span class="n">Hermitian_expval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayerV2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvqnet._core</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_core</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">num_layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_wires</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">param_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">shots</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

<span class="c1"># some basic Pauli matrices</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

<span class="n">init_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">high</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                                <span class="n">size</span><span class="o">=</span><span class="n">param_shape</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pq_circuit</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">param_shape</span><span class="p">)</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">machine</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">CPUQVM</span><span class="p">()</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">init_qvm</span><span class="p">()</span>
    <span class="n">qubits</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">qAlloc_many</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">circuit</span> <span class="o">=</span> <span class="n">StronglyEntanglingTemplate</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">num_qubits</span><span class="o">=</span><span class="n">num_qubits</span><span class="p">)</span>
    <span class="n">qcir</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">create_circuit</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">qcir</span><span class="p">)</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">directly_run</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">get_qstate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>该示例中的哈密顿量是厄密特矩阵,我们总是可以将其表示为泡利矩阵的总和。</p>
<div class="math notranslate nohighlight">
\[H = \sum_{i,j=0,1,2,3} a_{i,j} (\sigma_i\otimes \sigma_j),\]</div>
<p>其中</p>
<div class="math notranslate nohighlight">
\[a_{i,j} = \frac{1}{4}\text{tr}[(\sigma_i\otimes \sigma_j )H], ~~ \sigma = \{I, X, Y, Z\}.\]</div>
<p>代入以上公式,可见</p>
<div class="math notranslate nohighlight">
\[H = 4  + 2I\otimes X + 4I \otimes Z - X\otimes X + 5 Y\otimes Y + 2Z\otimes X.\]</div>
<p>为了执行“双随机”梯度下降,我们简单地应用随机梯度下降方法,但另外也均匀采样每个优化步骤的哈密顿期望项的子集。
vqe_func_analytic()函数是使用参数偏移计算理论梯度,vqe_func_shots()则是使用随机采样值以及随机采样哈密顿期望子集的“双随机”梯度计算。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span>
    <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">Z</span><span class="p">),</span>
    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span>
    <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">),</span>
    <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span>
<span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vqe_func_analytic</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">init_params</span><span class="p">):</span>
    <span class="n">qstate</span> <span class="o">=</span> <span class="n">pq_circuit</span><span class="p">(</span><span class="n">init_params</span><span class="p">)</span>
    <span class="n">expval</span> <span class="o">=</span> <span class="n">Hermitian_expval</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">qstate</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">expval</span>

<span class="k">def</span><span class="w"> </span><span class="nf">vqe_func_shots</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">init_params</span><span class="p">):</span>
    <span class="n">qstate</span> <span class="o">=</span> <span class="n">pq_circuit</span><span class="p">(</span><span class="n">init_params</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">terms</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">expval</span> <span class="o">=</span> <span class="n">Hermitian_expval</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">qstate</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">shots</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">expval</span>
</pre></div>
</div>
<p>使用VQNet进行参数优化,对比损失函数的曲线,由于双随机梯度下降法每次仅计算H的部分泡利算符和,
故使用其平均值才能代表最终观测量的期望结果,这里使用滑动平均moving_average()进行计算。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">##############################################################################</span>
<span class="c1"># Optimizing the circuit using gradient descent via the parameter-shift rule:</span>
<span class="n">qlayer_ana</span> <span class="o">=</span> <span class="n">QuantumLayerV2</span><span class="p">(</span><span class="n">vqe_func_analytic</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span> <span class="p">)</span>
<span class="n">qlayer_shots</span> <span class="o">=</span> <span class="n">QuantumLayerV2</span><span class="p">(</span><span class="n">vqe_func_shots</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span> <span class="p">)</span>
<span class="n">cost_sgd</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cost_dsgd</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">_core</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">init_params</span><span class="p">)</span>
<span class="n">_core</span><span class="o">.</span><span class="n">vqnet</span><span class="o">.</span><span class="n">copyTensor</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">qlayer_ana</span><span class="o">.</span><span class="n">m_para</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">opti_ana</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">qlayer_ana</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

<span class="n">_core</span><span class="o">.</span><span class="n">vqnet</span><span class="o">.</span><span class="n">copyTensor</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">qlayer_shots</span><span class="o">.</span><span class="n">m_para</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">opti_shots</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">qlayer_shots</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="n">opti_ana</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">qlayer_ana</span><span class="p">(</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">]]))</span>

    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">cost_sgd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">opti_ana</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="o">+</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">opti_shots</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">qlayer_shots</span><span class="p">(</span><span class="n">QTensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">]]))</span>

    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">cost_dsgd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">opti_shots</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">moving_average</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">n</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">moving_average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cost_dsgd</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">ta</span><span class="p">[:</span><span class="o">-</span><span class="mi">26</span><span class="p">]</span>
<span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span><span class="n">ta</span> <span class="p">])</span>
<span class="n">final_param</span> <span class="o">=</span> <span class="n">qlayer_shots</span><span class="o">.</span><span class="n">parameters</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Doubly stochastic gradient descent min energy = &quot;</span><span class="p">,</span> <span class="n">vqe_func_analytic</span><span class="p">(</span><span class="n">QTensor</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span><span class="n">final_param</span><span class="p">))</span>
<span class="n">final_param</span>  <span class="o">=</span> <span class="n">qlayer_ana</span><span class="o">.</span><span class="n">parameters</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stochastic gradient descent min energy = &quot;</span><span class="p">,</span> <span class="n">vqe_func_analytic</span><span class="p">(</span><span class="n">QTensor</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span><span class="n">final_param</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cost_sgd</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Vanilla gradient descent&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cost_dsgd</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Doubly QSGD&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">average</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">average</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Doubly QSGD (moving average)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cost function value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Optimization steps&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#Doubly stochastic gradient descent min energy =  -4.337801834749975</span>
<span class="c1">#stochastic gradient descent min energy =  -4.531484333030544</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/dsgd.png"><img alt="../_images/dsgd.png" class="align-center" src="../_images/dsgd.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="id47">
<h3>基于梯度的剪枝<a class="headerlink" href="#id47" title="Link to this heading">¶</a></h3>
<p>下面的例子实现了论文 <a class="reference external" href="https://openreview.net/forum?id=vKefw-zKOft">Towards Efficient On-Chip Training of Quantum Neural Networks</a> 中的算法。
通过仔细研究量子变分线路中参数的过程,作者观察到小梯度在量子噪声下往往具有较大的相对变化甚至错误的方向。
此外,并非所有梯度计算对于训练过程都是必需的,尤其是对于小幅度梯度。
受此启发,作者提出了一种概率梯度修剪方法来预测并仅计算高可靠性的梯度。
该方法可以减少噪声影响,还可以节省在真实量子机器上运行所需的电路数量。</p>
<p>在gradient based pruning算法中,对于参数的优化过程,划分了积累窗口和修剪窗口两个阶段,所有训练时期分成一个重复的累积窗口,然后是一个修剪窗口。 概率梯度修剪方法中有三个重要的超参数:</p>
<blockquote>
<div><ul class="simple">
<li><p>累积窗口宽度 <span class="math notranslate nohighlight">\(\omega_a\)</span> ,</p></li>
<li><p>修剪比例 <span class="math notranslate nohighlight">\(r\)</span> ,</p></li>
<li><p>修剪窗口宽度 <span class="math notranslate nohighlight">\(\omega_p\)</span> .</p></li>
</ul>
</div></blockquote>
<p>在累积窗口中,算法收集每个训练步骤中的梯度信息。 在修剪窗口的每一步中,算法根据从累积窗口和修剪比率收集的信息,
概率地免除一些梯度的计算。</p>
<a class="reference internal image-reference" href="../_images/gbp_arch.png"><img alt="../_images/gbp_arch.png" class="align-center" src="../_images/gbp_arch.png" style="width: 600px;" />
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>剪枝比例 <span class="math notranslate nohighlight">\(r\)</span> ,累积窗口宽度 <span class="math notranslate nohighlight">\(\omega_a\)</span> 和剪枝窗口宽度 <span class="math notranslate nohighlight">\(\omega_p\)</span> 分别决定了梯度趋势评估的可靠性。
因此,我们的概率梯度修剪方法节省的时间百分比是 <span class="math notranslate nohighlight">\(r\tfrac{\omega_p}{\omega_a +\omega_p}\times 100\%\)</span>。
以下是运用梯度剪枝方法在QVC分类任务的示例。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span> <span class="k">as</span> <span class="n">dataloader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">sgd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gradient_Prune_Instance</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>

<span class="n">qvc_train_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">]</span>
<span class="n">qvc_test_data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">qvc_circuits</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">qlist</span><span class="p">,</span> <span class="n">clist</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quantum circuits run function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">):</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nqubits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nqubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">cir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_circult</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
            <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">circult</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">basisstate</span><span class="p">():</span>
            <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">circult</span>

        <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">basisstate</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">weights_i</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)):</span>
                <span class="n">weights_j</span> <span class="o">=</span> <span class="n">weights_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">cnots</span> <span class="o">=</span> <span class="n">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cnots</span><span class="p">)</span>

        <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>

        <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circult</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prog</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">build_circult</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">qlist</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_dict</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">prob</span>


<span class="k">def</span><span class="w"> </span><span class="nf">qvc_circuits2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">qlist</span><span class="p">,</span> <span class="n">clist</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quantum circuits run function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">qlist</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circult</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_dict</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">prob</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">qvc_circuits</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1">#y = self.qvc2(y)</span>
        <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="n">dataset_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tranform data to valid form</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset_str</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_train_data</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_test_data</span><span class="p">)</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span>
</pre></div>
</div>
<p>我们使用 <code class="docutils literal notranslate"><span class="pre">Gradient_Prune_Instance</span></code> 类,
输入24为当前模型的参数个数。裁剪比例 <cite>prune_ratio</cite> 输入为0.5,
累计窗口大小 <cite>accumulation_window_size</cite> 为4,
剪枝窗口 <cite>pruning_window_size</cite> 为2。
当每次运行反向传播部分代码,在优化器 <code class="docutils literal notranslate"><span class="pre">step</span></code> 之前,
运行 <code class="docutils literal notranslate"><span class="pre">Gradient_Prune_Instance</span></code> 的 <code class="docutils literal notranslate"><span class="pre">step</span></code> 函数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main run function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">sgd</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">datas</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">datas</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="n">GBP_HELPER</span> <span class="o">=</span> <span class="n">Gradient_Prune_Instance</span><span class="p">(</span><span class="n">param_num</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span><span class="n">prune_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">accumulation_window_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">pruning_window_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">accuary</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">(</span><span class="n">datas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">loss_b</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="n">loss_b</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="n">GBP_HELPER</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss_b</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
            <span class="n">accuary</span> <span class="o">+=</span> <span class="n">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, #### loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> #####accuray:</span><span class="si">{</span><span class="n">accuary</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start testing..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="n">test_batch_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">accuary</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">testd</span><span class="p">,</span> <span class="n">testl</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span><span class="p">,</span> <span class="n">test_batch_size</span><span class="p">):</span>
        <span class="n">testd</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">testd</span><span class="p">)</span>
        <span class="n">test_result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">testd</span><span class="p">)</span>
        <span class="n">test_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">testl</span><span class="p">,</span> <span class="n">test_result</span><span class="p">)</span>
        <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">test_loss</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">test_batch_size</span>
        <span class="n">accuary</span> <span class="o">+=</span> <span class="n">get_accuary</span><span class="p">(</span><span class="n">test_result</span><span class="p">,</span> <span class="n">testl</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;test:---------------&gt;loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> #####accuray:</span><span class="si">{</span><span class="n">accuary</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">run</span><span class="p">()</span>

<span class="c1"># epoch:0, #### loss:0.2255942871173223 #####accuray:0.5833333333333334</span>
<span class="c1"># epoch:1, #### loss:0.1989427705605825 #####accuray:1.0</span>
<span class="c1"># epoch:2, #### loss:0.16489211718241373 #####accuray:1.0</span>
<span class="c1"># epoch:3, #### loss:0.13245886812607446 #####accuray:1.0</span>
<span class="c1"># epoch:4, #### loss:0.11463981121778488 #####accuray:1.0</span>
<span class="c1"># epoch:5, #### loss:0.1078591321905454 #####accuray:1.0</span>
<span class="c1"># epoch:6, #### loss:0.10561319688955943 #####accuray:1.0</span>
<span class="c1"># epoch:7, #### loss:0.10483601937691371 #####accuray:1.0</span>
<span class="c1"># epoch:8, #### loss:0.10457512239615123 #####accuray:1.0</span>
<span class="c1"># epoch:9, #### loss:0.10448987782001495 #####accuray:1.0</span>
<span class="c1"># start testing..............</span>
<span class="c1"># test:---------------&gt;loss:[0.3134713] #####accuray:1.0</span>
</pre></div>
</div>
</section>
</section>
<section id="id48">
<h2>在VQNet使用量子计算层进行模型训练<a class="headerlink" href="#id48" title="Link to this heading">¶</a></h2>
<p>以下是使用 <code class="docutils literal notranslate"><span class="pre">QuantumLayer</span></code>, <code class="docutils literal notranslate"><span class="pre">NoiseQuantumLayer</span></code>,  等VQNet接口实现量子机器学习的例子。</p>
<section id="vqnetquantumlayer">
<h3>在VQNet中使用QuantumLayer进行模型训练<a class="headerlink" href="#vqnetquantumlayer" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">sgd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span> <span class="k">as</span> <span class="n">dataloader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumLayer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>

<span class="n">qvc_train_data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">qvc_test_data</span><span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">qvc_circuits</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">qlist</span><span class="p">,</span><span class="n">clist</span><span class="p">,</span><span class="n">machine</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">):</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cir</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">nqubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">cir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_circult</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">nqubits</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span> <span class="n">qubits</span><span class="p">):</span>
            <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RZ</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">weights_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">circult</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">basisstate</span><span class="p">():</span>
            <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">circult</span>

        <span class="n">circult</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
        <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">basisstate</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">weights_i</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)):</span>
                <span class="n">weights_j</span> <span class="o">=</span> <span class="n">weights_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Rot</span><span class="p">(</span><span class="n">weights_j</span><span class="p">,</span><span class="n">nqubits</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">cnots</span> <span class="o">=</span> <span class="n">get_cnot</span><span class="p">(</span><span class="n">nqubits</span><span class="p">)</span>
            <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cnots</span><span class="p">)</span>

        <span class="n">circult</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">nqubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>

        <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circult</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prog</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">build_circult</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">qlist</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">prob_run_dict</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">prob</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span> <span class="o">=</span> <span class="n">QuantumLayer</span><span class="p">(</span><span class="n">qvc_circuits</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="n">dataset_str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dataset_str</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_train_data</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qvc_test_data</span><span class="p">)</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="n">result</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Run</span><span class="p">():</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">sgd</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span><span class="n">lr</span> <span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">datas</span><span class="p">,</span><span class="n">labels</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">datas</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">accuary</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">(</span><span class="n">datas</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">batch_size</span><span class="p">,</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">data</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">loss_b</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="n">loss_b</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss_b</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">count</span><span class="o">+=</span><span class="n">batch_size</span>
            <span class="n">accuary</span> <span class="o">+=</span> <span class="n">get_accuary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, #### loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> #####accuray:</span><span class="si">{</span><span class="n">accuary</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start testing..............&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="n">test_batch_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">accuary</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sum_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">testd</span><span class="p">,</span><span class="n">testl</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span><span class="n">test_label</span><span class="p">,</span><span class="n">test_batch_size</span><span class="p">):</span>
        <span class="n">testd</span> <span class="o">=</span> <span class="n">QTensor</span><span class="p">(</span><span class="n">testd</span><span class="p">)</span>
        <span class="n">test_result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">testd</span><span class="p">)</span>
        <span class="n">test_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">testl</span><span class="p">,</span><span class="n">test_result</span><span class="p">)</span>
        <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">test_loss</span>
        <span class="n">count</span><span class="o">+=</span><span class="n">test_batch_size</span>
        <span class="n">accuary</span> <span class="o">+=</span> <span class="n">get_accuary</span><span class="p">(</span><span class="n">test_result</span><span class="p">,</span><span class="n">testl</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test:---------------&gt;loss:</span><span class="si">{</span><span class="n">sum_loss</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2"> #####accuray:</span><span class="si">{</span><span class="n">accuary</span><span class="o">/</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">Run</span><span class="p">()</span>
</pre></div>
</div>
<p>运行的loss以及accuracy结果:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="n">training</span><span class="o">..............</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="c1">#### loss:[0.20585182] #####accuray:0.6</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#### loss:[0.17479989] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="c1">#### loss:[0.12679021] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="c1">#### loss:[0.11088503] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="c1">#### loss:[0.10598478] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="c1">#### loss:[0.10482856] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="c1">#### loss:[0.10453037] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="c1">#### loss:[0.10445572] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="c1">#### loss:[0.10442699] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="c1">#### loss:[0.10442187] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#### loss:[0.10442089] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span> <span class="c1">#### loss:[0.10442062] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="c1">#### loss:[0.10442055] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">13</span><span class="p">,</span> <span class="c1">#### loss:[0.10442055] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span> <span class="c1">#### loss:[0.10442055] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span> <span class="c1">#### loss:[0.10442055] #####accuray:1.0</span>
<span class="n">epoch</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="c1">#### loss:[0.10442055] #####accuray:1.0</span>

<span class="n">start</span> <span class="n">testing</span><span class="o">..............</span>
<span class="p">[</span><span class="mf">0.3132616580</span><span class="p">]</span>
<span class="n">test</span><span class="p">:</span><span class="o">---------------&gt;</span><span class="n">loss</span><span class="p">:</span><span class="n">QTensor</span><span class="p">(</span><span class="mf">0.3132616580</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#####accuray:1.0</span>
</pre></div>
</div>
</section>
<section id="vqnetnoisequantumlayer">
<h3>在VQNet中使用NoiseQuantumLayer进行模型训练<a class="headerlink" href="#vqnetnoisequantumlayer" title="Link to this heading">¶</a></h3>
<p>使用 <code class="docutils literal notranslate"><span class="pre">NoiseQuantumLayer</span></code> 可以使用QPanda的噪声虚拟机构建含噪量子线路,并进行训练。</p>
<p>一个完整的含噪模型量子机器学习模型的例子如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.conv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conv2D</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">activation</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.pooling</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxPool2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.nn.loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CategoricalCrossEntropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.optim.adam</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.tensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">tensor</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyqpanda</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvqnet.qnn.quantumlayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoiseQuantumLayer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;You should use Python 3.x&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>

<span class="n">url_base</span> <span class="o">=</span> <span class="s1">&#39;https://ossci-datasets.s3.amazonaws.com/mnist/&#39;</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;train_img&#39;</span><span class="p">:</span><span class="s1">&#39;train-images-idx3-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;train_label&#39;</span><span class="p">:</span><span class="s1">&#39;train-labels-idx1-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_img&#39;</span><span class="p">:</span><span class="s1">&#39;t10k-images-idx3-ubyte.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_label&#39;</span><span class="p">:</span><span class="s1">&#39;t10k-labels-idx1-ubyte.gz&#39;</span>
<span class="p">}</span>



<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; ... &quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url_base</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">file_path_ungz</span> <span class="o">=</span> <span class="n">file_path_ungz</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-idx&#39;</span><span class="p">,</span> <span class="s1">&#39;.idx&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">file_path_ungz</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">download_mnist</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_file</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_download</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

<span class="c1">#use qpanda to create quantum circuits</span>
<span class="k">def</span><span class="w"> </span><span class="nf">circuit</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">qubits</span><span class="p">,</span><span class="n">cbits</span><span class="p">,</span><span class="n">machine</span><span class="p">):</span>

    <span class="n">circuit</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QCircuit</span><span class="p">()</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">H</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">circuit</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">QProg</span><span class="p">()</span>
    <span class="n">prog</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">&lt;&lt;</span> <span class="n">measure_all</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">cbits</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">run_with_configuration</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">cbits</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Compute probabilities for each state</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="c1"># Get state expectation</span>
    <span class="n">expectation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">states</span> <span class="o">*</span> <span class="n">probabilities</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expectation</span>



<span class="k">class</span><span class="w"> </span><span class="nc">Net</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid</span> <span class="o">=</span> <span class="n">NoiseQuantumLayer</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;noise&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ReLu</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>该模型为混合量子线路以及经典网络的模型,其中量子线路部分使用 <code class="docutils literal notranslate"><span class="pre">NoiseQuantumLayer</span></code> 对量子线路加噪声模型进行模拟。使用该模型对mnist数据库中中的0,1手写数字进行分类。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_mnist</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;training_data&quot;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>         <span class="c1"># 下载数据</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">struct</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">array</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">pyarray</span>
    <span class="n">download_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;training_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;train-images.idx3-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;train-labels.idx1-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;testing_data&quot;</span><span class="p">:</span>
        <span class="n">fname_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;t10k-images.idx3-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fname_label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;t10k-labels.idx1-ubyte&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset must be &#39;training_data&#39; or &#39;testing_data&#39;&quot;</span><span class="p">)</span>

    <span class="n">flbl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_label</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">flbl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">flbl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fimg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_image</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pyarray</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">fimg</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">lbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
        <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">:</span> <span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_select</span><span class="p">(</span><span class="n">train_num</span><span class="p">,</span> <span class="n">test_num</span><span class="p">):</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;training_data&quot;</span><span class="p">)</span>
    <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s2">&quot;testing_data&quot;</span><span class="p">)</span>
    <span class="n">idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">train_num</span><span class="p">])</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_train</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Test Leaving only labels 0 and 1</span>
    <span class="n">idx_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="n">test_num</span><span class="p">])</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_select</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">CategoricalCrossEntropy</span><span class="p">()</span>

    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eval_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_acc_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eval_acc_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./result&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">eval_time</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./result/hqcnn_train_rlt.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">F2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./result/hqcnn_eval_rlt.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">iter</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_train</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="nb">iter</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Forward pass</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># Calculating loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">n_train</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Backward pass</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># Optimize the weights</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;##########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_loss</span><span class="p">))</span>
        <span class="n">train_acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct</span><span class="o">/</span><span class="n">n_train</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch: &quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="mf">100.</span> <span class="o">*</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epochs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> loss is : </span><span class="si">{:.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">F1</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_train</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_eval_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_eval</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">start_time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

            <span class="n">np_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">n_eval</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">total_eval_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_np</span><span class="p">)</span>
            <span class="n">eval_acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eval Accuracy: </span><span class="si">{</span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">F2</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">total_eval_loss</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">total_eval_loss</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">correct</span><span class="o">/</span><span class="n">n_eval</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">F1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">F2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>对比含噪量子线路与理想量子线路的机器学习模型分类结果,其loss变化情况以及accuary变化情况如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.715</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">1</span>
<span class="mi">1</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.6519572449</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">0.99</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">2</span>
<span class="mi">2</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.4458528900</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">3</span>
<span class="mi">3</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.3142367172</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">4</span>
<span class="mi">4</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.2259583092</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">5</span>
<span class="mi">5</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.1661866951</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">6</span>
<span class="mi">6</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.1306252861</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">7</span>
<span class="mi">7</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.0996847820</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">8</span>
<span class="mi">8</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.0801456261</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="c1">##########################</span>
<span class="n">Train</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">epoch</span><span class="p">:</span>  <span class="mi">9</span>
<span class="mi">9</span> <span class="n">loss</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.0649107647</span>
<span class="n">Eval</span> <span class="n">Accuracy</span><span class="p">:</span> <span class="mf">1.0</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="vqc_demo.html" class="btn btn-neutral float-left" title="使用自动微分模拟的量子机器学习示例" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="QTensor.html" class="btn btn-neutral float-right" title="QTensor 模块" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Original Quantum.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>